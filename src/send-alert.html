<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Send Alert — Wispa Real Estate</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header style="padding:12px;background:#1e88e5;color:#fff;display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700">Send Alert</div>
    <div><a href="admin.html" style="color:#fff">Back to Admin</a></div>
  </header>
  <main style="padding:18px;max-width:820px;margin:18px auto">
    <h2>Send Alert / Notification</h2>
    <div style="margin:8px 0"><input id="sendAlertTitle" placeholder="Title" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px"/></div>
    <div style="margin:8px 0"><textarea id="sendAlertMessage" placeholder="Message" rows="8" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px"></textarea></div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <select id="sendAlertTarget" style="padding:8px;border:1px solid var(--border);border-radius:6px"><option value="all">All users</option><option value="admins">All admins</option><option value="custom">Custom (enter user IDs/emails)</option></select>
      <input id="sendAlertCustom" placeholder="comma-separated emails/ids" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;display:none" />
      <button id="sendAlertSubmit" type="button" style="padding:8px 12px;border-radius:6px;background:#1e88e5;color:#fff;border:0;cursor:pointer">Send</button>
    </div>
    <div id="sendAlertStatus" style="margin-top:8px;color:#666"></div>
    <h3 style="margin-top:18px">Sent History</h3>
    <div id="sendAlertHistory" style="margin-top:8px;color:#222"></div>
  </main>
  <script src="script.js"></script>
  <script>
    // Load history and wire send button
    async function loadSendAlertHistory(){
      const histEl = document.getElementById('sendAlertHistory');
      if(!histEl) return;
      histEl.textContent = 'Loading…';
      try{
        const poster = window.apiFetch ? window.apiFetch : fetch;
        try{
          const res = await poster('/api/admin/sent-notifications');
          if(res && res.ok){ const j = await res.json(); const arr = Array.isArray(j) ? j : (j && (j.notifications || j.items)) ? (j.notifications || j.items) : [];
            if(arr && arr.length){ histEl.innerHTML = '<ul>'+arr.map(it=>`<li><strong>${escapeHtml(it.title||'')}</strong> — ${escapeHtml((it.message||it.body||'').slice(0,200))} <span style="color:#666;font-size:12px">${escapeHtml(String(it.sentAt||it.createdAt||''))}</span></li>`).join('')+'</ul>'; return; }
          }
        }catch(e){}
        // Fallback localStorage
        try{ const arr = JSON.parse(localStorage.getItem('sentNotifications')||'[]'); if(arr && arr.length){ histEl.innerHTML = '<ul>'+arr.map(it=>`<li><strong>${escapeHtml(it.title||'')}</strong> — ${escapeHtml((it.message||it.body||'').slice(0,200))} <span style="color:#666;font-size:12px">${escapeHtml(String(it.sentAt||it.createdAt||''))}</span></li>`).join('')+'</ul>'; return; } }catch(e){}
        histEl.textContent = 'No sent alerts yet.';
      }catch(e){ histEl.textContent = 'Failed to load history.' }
    }

    document.addEventListener('DOMContentLoaded', function(){
      try{
        const sat = document.getElementById('sendAlertTarget');
        if(sat) sat.addEventListener('change', function(){ try{ document.getElementById('sendAlertCustom').style.display = this.value==='custom' ? 'block' : 'none'; }catch(e){} });
        const sbtn = document.getElementById('sendAlertSubmit');
        if(sbtn) sbtn.addEventListener('click', async function(){
          try{
            const title = (document.getElementById('sendAlertTitle').value||'').trim();
            const message = (document.getElementById('sendAlertMessage').value||'').trim();
            const target = (document.getElementById('sendAlertTarget').value||'all');
            const custom = (document.getElementById('sendAlertCustom').value||'').trim();
            const status = document.getElementById('sendAlertStatus');
            if(!title || !message){ if(status) status.textContent = 'Title and message are required.'; return; }
            if(status) status.textContent = 'Sending…';
            const payload = { title, message, target, custom: custom || null };
            const poster = window.apiFetch ? window.apiFetch : (p,o)=>fetch(p,o);
            let res = null;
            try{ res = await poster('/api/admin/send-notification', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }catch(e){}
            if(!res || !res.ok){ try{ res = await poster('/api/admin/sent-notifications', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }catch(e){} }
            if(res && res.ok){ if(status) status.textContent = 'Sent.'; setTimeout(()=>{ try{ loadSendAlertHistory(); }catch(e){} },600); return; }
            // fallback to localStorage
            try{ const key='sentNotifications'; const arr = JSON.parse(localStorage.getItem(key)||'[]'); arr.unshift(Object.assign({ id: 'local-'+Date.now(), title, message, sentAt: new Date().toISOString(), target }, {})); localStorage.setItem(key, JSON.stringify(arr)); if(status) status.textContent='Saved locally (offline)'; setTimeout(()=>{ try{ loadSendAlertHistory(); }catch(e){} },600); return; }catch(e){ if(status) status.textContent='Send failed'; }
          }catch(e){ try{ document.getElementById('sendAlertStatus').textContent='Send failed'; }catch(_){} }
        });
      }catch(e){ }
      try{ loadSendAlertHistory(); }catch(e){}
    });
  </script>
</body>
</html>
