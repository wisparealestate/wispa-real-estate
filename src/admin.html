<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî Wispa Real Estate</title>
  <meta name="app-version" content="0.1.0">
  <script>window.WISPA_DATA_AVAILABLE = true;</script>
  <link rel="stylesheet" href="styles.css">
  <style id="admin-overview-styles">
  /* Admin Overview - responsive, clean dashboard styles */
  :root{ --overview-bg: #f7fbff; --overview-card:#ffffff; --overview-border:#e9f0f6; --overview-accent:#0e76a8 }

  #overviewContent{ display:flex; flex-direction:column; gap:14px; }

  /* Prevent horizontal overflow on mobile and ensure content fits viewport */
  #overview{ box-sizing:border-box; padding:8px 6px; max-width:100%; overflow-x:hidden }
  #overviewContent, #overviewStats, #overviewRecents, #companyDashboard{ width:100%; max-width:100% }
  #overview img, #overview video{ max-width:100%; height:auto; display:block }
  #overviewStats > div, #overviewRecents > div, #companyBreakdown > div { min-width:0 }

  #overviewStats{ display:flex; gap:14px; flex-wrap:wrap; align-items:stretch }
  #overviewStats > div{ flex:1 1 160px; min-width:140px; background:var(--overview-card); padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(11,34,54,0.06); border:1px solid var(--overview-border); }
  #overviewStats > div div{ font-weight:700; font-size:1.25rem; color:var(--overview-accent) }

  #overviewRecents{ display:flex; gap:18px; flex-wrap:wrap }
  #overviewRecents > div{ background:var(--overview-card); padding:12px; border-radius:8px; min-width:220px; flex:1 1 260px; box-shadow:0 6px 14px rgba(0,0,0,0.04); }

  #companyDashboard{ padding:14px; border-radius:10px; background: linear-gradient(180deg, #fff, #fbfdff); border:1px solid var(--overview-border); }

  #companyMetrics{ display:flex; gap:12px; flex-wrap:wrap; align-items:stretch }
  .metric-card, #companyMetrics > div { min-width:140px; background:var(--overview-card); padding:12px; border-radius:8px; box-shadow:0 6px 12px rgba(0,0,0,0.04); text-align:center; flex:1 1 160px; border:1px solid var(--overview-border) }
  .metric-card > div{ font-weight:700; font-size:1.1rem; color:var(--overview-accent) }

  #companyBreakdown{ display:flex; gap:18px; flex-wrap:wrap; margin-top:12px }
  #companyBreakdown > div{ background:var(--overview-card); padding:12px; border-radius:8px; min-width:220px; flex:1 1 220px; box-shadow:0 6px 12px rgba(0,0,0,0.04); border:1px solid var(--overview-border) }

  #overviewIntro{ font-size:1rem; color:var(--text); margin-bottom:6px }

  /* Small tweaks for property & users lists inside admin panels */
  #propertiesList > div:first-child, #usersList > div:first-child{ margin-bottom:8px }
  #propertiesList ul, #usersList ul{ margin:0; padding-left:18px }
  #propertiesList li, #usersList li{ padding:8px 0; border-bottom:1px dashed rgba(0,0,0,0.03) }

  /* Delete button styling (small and clear) */
  button.delete-prop{ margin-left:10px; background:#ff4d4f; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:12px }
  button.delete-prop:hover{ opacity:0.95 }

  /* Accessibility: focus outlines */
  #overview a:focus, #overview button:focus, #overview input:focus{ outline:3px solid rgba(14,118,168,0.12); outline-offset:2px }

  /* Responsive breakpoints */
  @media (max-width: 900px){
    #overviewStats{ gap:10px }
    #overviewStats > div{ flex:1 1 45%; min-width:140px }
    #overviewRecents{ flex-direction:column }
    #companyBreakdown{ flex-direction:column }
    .metric-card{ min-width:100% }
  }

  @media (max-width: 480px){
    /* Arrange overview stat cards into two rows of three on small screens */
    #overviewStats{ display:flex; gap:8px; flex-wrap:wrap }
    #overviewStats > div{ flex:1 1 calc(33.333% - 12px); min-width:0 }
    #companyMetrics{ flex-direction:column }
    #overviewRecents > div, #companyBreakdown > div{ min-width:100% }
    #overviewContent{ padding:6px }
    /* Reduce margins and gaps on very small screens */
    #overviewStats{ gap:8px }
    #overviewRecents{ gap:8px }
    #companyBreakdown{ gap:8px }
    .metric-card{ padding:8px }
  }

  /* Small utility to keep layout airy on very large screens */
  @media (min-width:1400px){
    #overviewStats{ gap:20px }
  }
  /* Compact mobile layout: smaller fonts, tighter spacing, hide nonessential tabs/panels */
  @media (max-width: 600px){
    /* global sizing */
    body, .admin-main, .admin-header { font-size: 14px }
    .admin-title { font-size: 1rem }
    h2 { font-size: 1.05rem }

    /* tighter gaps */
    #overviewContent{ gap:8px }
    #overviewStats{ gap:8px }
    #companyMetrics{ gap:8px }
    #overviewRecents, #companyBreakdown{ gap:8px }

    /* smaller metric cards */
    #overviewStats > div, .metric-card, #companyBreakdown > div, #overviewRecents > div { padding:8px; border-radius:8px }
    #overviewStats > div div, .metric-card > div { font-size:1rem }

    /* make tabs compact and allow wrap into multiple rows without overflow */
    .tabs { gap:6px }
    .tab-btn { padding:6px 8px; font-size:0.85rem }

    /* hide non-essential panels and their tabs to reduce clutter on phones */
    .tab-btn[data-tab="alerts"], .tab-btn[data-tab="notifications"], .tab-btn[data-tab="requests"], .tab-btn[data-tab="messages"] { display:none !important }
    #alerts, #notifications, #requests, #messages { display:none !important }

    /* compact property & user lists */
    #propertiesList li, #usersList li { padding:6px 0; font-size:0.9rem }

    /* reduce header padding */
    .admin-header { padding:8px 10px }
    .hamburger { font-size:1.1rem }
  }
  /* Recents responsive stacking: default (desktop) is horizontal, on small screens stack with users first */
  .overview-recents-flex{display:flex;gap:12px;overflow:visible;-webkit-overflow-scrolling:touch;padding-bottom:6px;align-items:flex-start}
  .overview-recents-flex .recent-users{order:1}
  .overview-recents-flex .recent-props{order:2}
  .overview-recents-flex > .recent-props,
  .overview-recents-flex > .recent-users,
  .overview-recents-flex > .recent-notifs {
    flex: 1 1 32%;
    min-width: 260px;
    box-sizing: border-box;
  }

  /* Ensure each card looks like a distinct section */
  .overview-recents-flex > div {
    background: var(--overview-card);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.04);
    border: 1px solid var(--overview-border);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  @media (max-width:600px){
    .overview-recents-flex{flex-direction:column}
    .overview-recents-flex > .recent-users{order:1}
    .overview-recents-flex > .recent-props{order:2}
  }
  /* Allow each recent-card to scroll internally so its table can be fully viewed.
     Enable both vertical and horizontal scrolling so wide tables remain accessible
     on narrow viewports. */
  .overview-recents-flex .recent-props > div,
  .overview-recents-flex .recent-users > div,
  .overview-recents-flex .recent-notifs > div {
    max-height: 260px;
    overflow: auto; /* allow both x and y scrolling */
    overflow-x: auto; /* ensure horizontal scroll for wide tables */
    -webkit-overflow-scrolling: touch;
    touch-action: auto; /* allow touch-driven scrolling in both directions */
    -ms-overflow-style: -ms-autohiding-scrollbar;
  }
  /* Tables inside the recent cards should size to their contents and allow
     horizontal scrolling when wider than the card. */
  .overview-recents-flex .recent-props table,
  .overview-recents-flex .recent-users table {
    width: auto;
    min-width: 520px; /* small sensible minimum, individual tables set larger when needed */
    border-collapse: collapse;
  }
  @media (max-width:600px){
    .overview-recents-flex .recent-props > div,
    .overview-recents-flex .recent-users > div,
    .overview-recents-flex .recent-notifs > div {
      max-height: 320px;
      overflow-y: auto; /* allow vertical scroll if content is tall */
      overflow-x: auto; /* ensure horizontal scroll on small screens */
      -webkit-overflow-scrolling: touch;
      touch-action: auto; /* allow touch-driven scrolling in both directions */
      -ms-overflow-style: -ms-autohiding-scrollbar;
      padding-bottom: 6px;
    }
    /* Make inner tables not shrink so horizontal scrolling is available */
    .overview-recents-flex .recent-props > div table,
    .overview-recents-flex .recent-users > div table,
    .overview-recents-flex .recent-notifs > div table {
      min-width: 640px;
      width: auto;
      display: table;
    }
  }
  /* Subtle left/right gradient hints for horizontally-scrollable recent cards */
  .overview-recents-flex > div { position: relative }
  .overview-recents-flex > div::before,
  .overview-recents-flex > div::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 6px;
    width: 44px;
    pointer-events: none;
    transition: opacity .22s ease;
    opacity: 0;
    z-index: 4;
  }
  .overview-recents-flex > div::after { right: 0; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(0,0,0,0.06)); }
  .overview-recents-flex > div::before { left: 0; background: linear-gradient(270deg, rgba(255,255,255,0), rgba(0,0,0,0.06)); }
  .overview-recents-flex > div.can-scroll-right::after { opacity: 1 }
  .overview-recents-flex > div.can-scroll-left::before { opacity: 1 }
  </style>
  <style>
    /* Minimal overrides to ensure header/hamburger visible */
    :root { --admin-header-height:56px }
    .admin-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:var(--brand, #1e88e5); color:#fff; position:fixed; top:0; left:0; right:0; width:100%; z-index:4000; box-shadow:0 6px 18px rgba(8,24,50,0.06) }
    .admin-title { font-size:1.05rem; font-weight:600; color:#fff; }
    .hamburger { background:transparent; border:0; color:#fff; font-size:1.25rem; cursor:pointer }
    .header-icons { display:flex; gap:10px; align-items:center; }
    .icon-btn { background:transparent; border:0; color:inherit; font-size:1.05rem; cursor:pointer; padding:6px; border-radius:6px }
    .icon-badge { position:relative; display:inline-flex }
    .icon-badge .badge { position:absolute; top:-6px; right:-6px; background:#ff4d4f; color:#fff; font-size:11px; padding:2px 6px; border-radius:12px }
    .menu-dropdown { position:absolute; right:16px; top:var(--admin-header-height); background:#fff; color:#111; border:1px solid rgba(0,0,0,0.08); box-shadow:0 6px 18px rgba(0,0,0,0.08); min-width:160px; display:none; z-index:2000; text-align:right }
    .menu-dropdown a{ display:block; padding:8px 12px; color:inherit; text-decoration:none }
    #hamburgerProfile { text-align:left; width:100%; }
    .menu-dropdown a:hover{ background:#f6f6f6 }
    /* Notifications dropdown specific tweaks */
    #notifDropdown{ min-width:420px; max-width:520px; right:70px; top:var(--admin-header-height); border-radius:10px; overflow:hidden }
    #notifDropdownContent{ padding:12px; max-height:360px; overflow:auto; background:transparent }
    #notifDropdownContent .notif-item{ padding:10px;border-radius:8px;margin-bottom:8px;background:#fff;border:1px solid #f1f6fb;box-shadow:0 6px 18px rgba(8,24,50,0.03) }
    #notifDropdownContent .notif-item:last-child{ margin-bottom:0 }
    /* Notifications panel styles */
    #notificationsContent{ background:#fff;border:1px solid #f1f6fb;padding:12px;border-radius:10px }
    #notificationsContent ul{ list-style:none;margin:0;padding:0 }
    #notificationsContent li{ padding:12px;border-bottom:1px solid #eef6fb }
    #notificationsContent li:hover{ background:#fbfdff }
    #notificationsContent li.notif-read{ opacity:0.6; background:#fafafa }
    #notificationsContent li div:first-child{ font-weight:700 }
    .admin-main{ padding:var(--page-gap) }

    /* keep page content below the sticky header so it doesn't jump; 10px gap after header */
    .admin-main { padding-top: calc(var(--admin-header-height) + 10px) }
    /* Ensure section titles (first visible content) don't add extra top margin */
    .admin-main h2, .tab-panel h2 { margin-top: 0; margin-bottom: 10px }

    /* Overview action buttons (centered, responsive) */
    .overview-actions { display:flex; gap:8px; align-items:center; justify-content:center; margin:8px 0 }
    .overview-actions .tab-btn { min-width:0 }
    @media (max-width:600px){
      .overview-actions { flex-direction:column; gap:10px }
      .overview-actions .tab-btn { width:100%; max-width:320px }
    }
    .tabs { display:flex; gap:8px; margin-bottom:0; flex-wrap:wrap; align-items:center }
    .tab-btn { padding:8px 12px; background:#f1f5f9; border-radius:6px; cursor:pointer; flex:0 1 auto; min-width:0; white-space:nowrap; font-size:0.95rem }
    .tab-btn.active { background:var(--brand, #1e88e5); color:#fff }
    @media (max-width: 600px){
      .tabs { gap:6px }
      .tab-btn { padding:6px 8px; font-size:0.88rem }
    }
    .tab-panel { display:none }
    .tab-panel.active { display:block }
    .profile-field { margin:8px 0 }
    /* Notification detail modal */
    #notifDetailModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:4000; align-items:center; justify-content:center }
    #notifDetailModal .modal-card { background:#fff; padding:16px; border-radius:10px; width:92%; max-width:720px; box-shadow:0 12px 40px rgba(8,24,50,0.3); }
    #notifDetailModal .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    #notifDetailModal h3 { margin:0 0 6px 0 }
  </style>
</head>
<body>
  <header class="admin-header">
    <div style="display:flex;align-items:center;gap:12px">
      <button id="adminBackBtn" class="icon-btn" title="Back" style="display:none;align-items:center;justify-content:center;padding:6px 8px">‚Üê</button>
      <div class="admin-title">Wispa Admin</div>
      <div style="font-size:0.9rem; opacity:0.9" id="logged-as"></div>
    </div>
    <div style="position:relative; display:flex; align-items:center; gap:10px">
      <div class="header-icons" aria-hidden="false" style="display:flex;align-items:center;gap:8px">
        <button id="quickSearchBtn" class="icon-btn" title="Quick search" aria-label="Search">üîç</button>
        <button id="notificationsBtn" class="icon-btn icon-badge" title="Notifications" aria-label="Notifications">üîî<span class="badge" id="notifBadge" style="display:none">0</span></button>
        <div id="notifDropdown" class="menu-dropdown" style="position:fixed;right:16px;top:56px;min-width:280px;max-width:520px;display:none;z-index:2400;border-radius:10px;overflow:hidden;background:#fff;border:1px solid rgba(0,0,0,0.06);box-shadow:0 10px 30px rgba(0,0,0,0.08)">
          <div id="notifDropdownContent" style="max-height:360px;overflow:auto;padding:8px;background:transparent"></div>
            <div style="padding:8px;border-top:1px solid #f1f5fb;display:flex;gap:8px;justify-content:space-between;align-items:center;background:#fbfdff">
              <div style="display:flex;gap:6px">
                <a href="#notifications" data-notif-view="all" class="notifQuickLink" style="text-decoration:none">All</a>
                <a href="#notifications" data-notif-view="messages" class="notifQuickLink" style="text-decoration:none">Messages</a>
                <a href="#notifications" data-notif-view="alerts" class="notifQuickLink" style="text-decoration:none">Alerts</a>
                <a href="#notifications" data-notif-view="activities" class="notifQuickLink" style="text-decoration:none">Activities</a>
              </div>
              <div style="text-align:right"><a href="#notifications" id="notifOpenFull" style="text-decoration:none">Open all</a></div>
            </div>
        </div>
        <button id="chatsBtn" class="icon-btn" title="Chats" aria-label="Chats">üí¨</button>
      </div>
      <!-- Chat quick search (hidden by default, shown when Chat tab active) -->
      <div id="chatHeaderSearchWrap" style="display:none; margin-left:8px;">
        <input id="chatHeaderSearch" placeholder="Search chats" style="padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);width:220px;background:rgba(255,255,255,0.08);color:#fff" />
      </div>
      <button class="hamburger" id="hamburger" aria-label="Menu">‚ò∞</button>
      <nav class="menu-dropdown" id="menuDropdown">
        <div id="hamburgerProfile" style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #f2f6fb;background:#fff">
          <div id="hamburgerProfileAvatar" style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;overflow:hidden;border:1px solid var(--border);flex:0 0 36px"></div>
          <div style="flex:1;min-width:0">
            <div id="hamburgerProfileName" style="font-weight:700;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">‚Äî</div>
            <div id="hamburgerProfileEmail" style="font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">&nbsp;</div>
            <div id="hamburgerAuthStatus" style="font-size:11px;color:#999;margin-top:4px">Auth: unknown</div>
          </div>
        </div>
        <!-- Profile link removed: top profile block opens Profile tab -->
        <a href="#overview" data-tab="overview">Overview</a>
        <a href="#properties" data-tab="properties">Properties</a>
        <a href="#users" data-tab="users">Users</a>
        <a href="#" id="debugLink">Debug</a>
        <a href="#settings" data-tab="settings" id="settingsLink">Settings</a>
        <a href="#privacy" data-tab="privacy" id="privacyLink">Privacy</a>
        <a href="#logout" id="logoutLink">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Quick search dropdown (hidden until used) -->
  <div id="adminQuickSearch" style="display:none; position:fixed; top:64px; left:50%; transform:translateX(-50%); width:92%; max-width:760px; background:#fff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 10px 30px rgba(0,0,0,0.12); z-index:2200; border-radius:8px;">
    <div style="padding:8px 12px; display:flex; gap:8px; align-items:center">
      <input id="adminQuickSearchInput" placeholder="Search properties, users, requests..." style="flex:1; padding:10px 12px; font-size:14px; border:1px solid #e6eef7; border-radius:6px" />
      <button id="adminQuickSearchClose" style="background:transparent;border:0;font-size:18px;padding:6px;cursor:pointer">‚úï</button>
    </div>
    <div id="adminQuickSearchResults" style="max-height:320px; overflow:auto; padding:8px 12px; border-top:1px solid #f0f5fb"></div>
  </div>

  <main class="admin-main">
    <!-- Navigation handled via hamburger menu; header tabs removed -->

    <section id="overview" class="tab-panel">
      <h2>Overview</h2>
      <p id="overviewIntro">Loading admin overview‚Ä¶</p>
      <p class="overview-actions" style="display:flex;gap:8px;align-items:center;justify-content:center;margin:8px 0"><button id="refreshOverview" class="tab-btn">Refresh Overview</button><button id="overviewCreatePostBtn" class="tab-btn">Create Post</button><button id="overviewSendAlertBtn" class="tab-btn">Send Alert</button></p>
      <div id="overviewContent">
        <div id="overviewStats" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px"></div>
        <div id="overviewRecents" style="display:flex;gap:18px;flex-wrap:wrap"></div>
        <!-- Footer replaces additional overview content (kept minimal per request) -->
        <div id="overviewFooter" style="margin-top:18px;padding:12px;border-radius:8px;display:flex;justify-content:center;">
          <div style="max-width:980px;width:100%;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;color:#666;font-size:0.95rem">
            <div id="footerDateTime">Loading date‚Ä¶</div>
            <div id="footerVersion">Version: -</div>
            <div id="footerSafety">Safety rate: N/A</div>
            <div id="footerCopy">¬© <span id="footerYear"></span> Wispa</div>
            <div id="footerDebug" style="font-size:12px;color:#999;width:100%;text-align:center;margin-top:6px">Last check: ‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <section id="edit-profile" class="tab-panel">
      <h2>Edit Profile</h2>
      <div style="max-width:820px; background:#fff; border:1px solid var(--border); padding:14px; border-radius:10px">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div style="flex:0 0 120px;text-align:center">
            <div id="editAvatarPreview" style="width:100px;height:100px;border-radius:50%;background:#f1f5f9;overflow:hidden;border:1px solid var(--border);display:inline-block"></div>
            <div style="margin-top:8px"><input id="editAvatarFile" type="file" accept="image/*"/></div>
          </div>
          <div style="flex:1;min-width:220px">
            <label style="display:block">Full name<input id="editFullName" style="width:100%;padding:8px;margin-top:6px"/></label>
            <label style="display:block;margin-top:8px">Email<input id="editEmail" style="width:100%;padding:8px;margin-top:6px"/></label>
            <label style="display:block;margin-top:8px">Phone<input id="editPhone" style="width:100%;padding:8px;margin-top:6px"/></label>
            <label style="display:block;margin-top:8px">Gender<select id="editGender" style="width:100%;padding:8px;margin-top:6px"><option value="">Prefer not to say</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></label>
            <label style="display:block;margin-top:8px">Location<input id="editLocation" style="width:100%;padding:8px;margin-top:6px"/></label>
            <label style="display:block;margin-top:8px">Bio<textarea id="editBio" rows="4" style="width:100%;padding:8px;margin-top:6px"></textarea></label>
          </div>
        </div>
        <div style="margin-top:12px;text-align:right;display:flex;gap:8px;justify-content:flex-end">
          <button id="editCancelBtn" class="tab-btn">Cancel</button>
          <button id="editSaveBtn" class="tab-btn">Save</button>
        </div>
        <div id="editStatus" style="margin-top:8px;color:#666"></div>
      </div>
    </section>

    <section id="profile" class="tab-panel">
      <h2>Admin Profile</h2>
      <div id="admin-profile-panel" style="max-width:920px;background:#fff;border:1px solid var(--border);padding:18px;border-radius:12px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
        <div style="flex:0 0 140px;text-align:center">
          <div id="admin-avatar" style="width:120px;height:120px;border-radius:50%;background:#f1f5f9;display:inline-block;overflow:hidden;border:1px solid var(--border);box-shadow:0 6px 16px rgba(8,24,50,0.06)"></div>
        </div>
        <div style="flex:1 1 520px;min-width:0">
          <div style="display:flex;flex-direction:column;gap:6px">
            <div style="display:flex;align-items:center;gap:8px">
              <div id="profileDisplayName" style="font-size:1.25rem;font-weight:700">‚Äî</div>
              <span id="profileVerified" title="Verified admin" aria-hidden="true" style="display:none;color:#27ae60;font-size:0.95rem;line-height:1">‚úîÔ∏é</span>
            </div>
            <div id="profileDisplayEmail" style="color:#666;margin-top:6px">‚Äî</div>
            <div style="margin-top:12px;color:#444;font-size:14px">Role: <span id="profileRole">Admin</span></div>
            <div style="margin-top:12px;color:#666;font-size:13px">Use Settings to edit your profile, update avatar, change password and adjust privacy options.</div>
          </div>
        </div>
        <div style="flex:0 0 100%;display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <a href="#edit-profile" data-tab="edit-profile" id="profileSettingsBtn" class="tab-btn" style="text-align:center;display:inline-block;padding:10px 12px">Edit</a>
          <button id="profilePrivacyBtn" class="tab-btn" style="text-align:center;display:inline-block;padding:10px 12px;background:#fff;border:1px solid var(--border)">Privacy Settings</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div id="profileMessages" style="color:#666">Loading profile‚Ä¶</div>
    </section>

    <!-- Embedded Settings tab (in-page) -->
    <section id="settings" class="tab-panel">
      <h2>App Settings (affects user & admin sites)</h2>
      <div class="card">
        <form id="appSettingsFormInline">
          <label>Site title
            <input id="siteTitleInline" name="siteTitle" type="text" placeholder="Site title">
          </label>

          <label>Default language
            <select id="defaultLangInline" name="defaultLang">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
            </select>
          </label>

          <label>
            <input id="maintenanceModeInline" name="maintenanceMode" type="checkbox"> Enable maintenance mode
          </label>

          <label>
            <input id="allowRegistrationInline" name="allowRegistration" type="checkbox"> Allow user registration
          </label>

          <div style="margin-top:12px">
            <button id="saveAppSettingsInline" class="btn">Save App Settings</button>
          </div>
        </form>
      </div>

      <h3 style="margin-top:18px">Admin Defaults</h3>
      <div class="card">
        <form id="adminDefaultsFormInline">
          <label>Items per page
            <input id="adminItemsPerPageInline" name="adminItemsPerPage" type="number" min="1" value="20">
          </label>
          <label>
            <input id="adminEmailAlertsInline" name="adminEmailAlerts" type="checkbox" checked> Send email alerts to admins
          </label>
          <div style="margin-top:12px">
            <button id="saveAdminDefaultsInline" class="btn">Save Admin Defaults</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Embedded Privacy tab (in-page) -->
    <section id="privacy" class="tab-panel">
      <h2>User-facing Privacy Controls</h2>
      <div class="card">
        <form id="privacyFormInline">
          <label>
            <input id="publicProfileInline" type="checkbox" checked>
            Allow users to make their profile public
          </label>

          <label>
            <input id="showContactInfoInline" type="checkbox" checked>
            Show contact information on property detail to other users
          </label>

          <label>
            <input id="showPhoneButtonInline" type="checkbox" checked>
            Show direct contact button on listings
          </label>

          <label>
            <input id="dataSharingInline" type="checkbox">
            Enable data sharing with 3rd-party services (analytics/ads)
          </label>

          <label>
            <input id="analyticsInline" type="checkbox" checked>
            Enable site analytics (collect anonymous usage data)
          </label>

          <div style="margin-top:12px">
            <button id="savePrivacyInline" class="btn">Save Privacy Settings</button>
          </div>
        </form>
      </div>

      <h3 style="margin-top:18px">Admin visibility</h3>
      <div class="card">
        <form id="adminPrivacyFormInline">
          <label>
            <input id="adminSeeUserContactsInline" type="checkbox" checked>
            Allow admins to view user contact details
          </label>
          <label>
            <input id="adminExportDataInline" type="checkbox">
            Allow admins to export user data
          </label>
          <div style="margin-top:12px">
            <button id="saveAdminPrivacyInline" class="btn">Save Admin Privacy</button>
          </div>
        </form>
      </div>
    </section>

    <section id="requests" class="tab-panel">
      <h2>Property Requests</h2>
      <p><button id="refreshRequests">Refresh</button></p>
      <div id="requestsList">Loading requests‚Ä¶</div>
    </section>

    <section id="messages" class="tab-panel">
      <h2>Contact Messages</h2>
      <p><button id="refreshMessages">Refresh</button></p>
      <div id="messagesList">Loading messages‚Ä¶</div>
    </section>

    <section id="chat" class="tab-panel">
      <h2>Property Chats</h2>
      <p style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
        <span><button id="refreshChats">Refresh</button></span>
        <span style="flex:1;margin:0 12px"><input id="chatSearchInput" placeholder="Search conversations by name, email or id" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px"/></span>
      </p>
      <div id="admin-chats-list">Loading chats‚Ä¶</div>
      <div id="chat-fullview" style="display:none;margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="chat-full-title" style="font-weight:700;font-size:1.05rem">Conversation</div>
            <div id="chat-full-sub" style="color:#666;font-size:0.9rem"></div>
          </div>
          <div>
            <button id="chat-back" class="icon-btn">‚Üê Back</button>
          </div>
        </div>
        <div id="chat-full-messages" style="max-height:360px;overflow:auto;padding:12px;border:1px solid #f1f5fb;margin-top:8px;background:#fff;border-radius:8px">No messages.</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="chat-full-input" placeholder="Type a reply‚Ä¶" style="flex:1;padding:8px;border:1px solid #e6eef7;border-radius:6px" />
          <button id="chat-full-send" class="icon-btn">Send</button>
        </div>
      </div>
    </section>

    <script src="admin-chat-widget.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try{
          // initialize new admin chat widget
          if(typeof AdminChatWidget === 'function'){
            window._adminChatWidget = new AdminChatWidget({ listId: 'admin-chats-list', fullViewId: 'chat-fullview', messagesId: 'chat-full-messages', inputId: 'chat-full-input', sendBtnId: 'chat-full-send' });
          }
        }catch(e){ console.warn('AdminChatWidget init failed', e); }
      });
    </script>
    <script>
      // Wire profile panel: load current user and attach save handler
      document.addEventListener('DOMContentLoaded', async function(){
        try{
          const nameInput = document.getElementById('profileName');
          const nameDisplay = document.getElementById('profileDisplayName');
          const emailInput = document.getElementById('profileEmail');
          const emailDisplay = document.getElementById('profileDisplayEmail');
          const roleEl = document.getElementById('profileRole');
          const msgs = document.getElementById('profileMessages');
          const avatar = document.getElementById('admin-avatar');
          const saveBtn = document.getElementById('saveProfileBtn');
          const settingsBtn = document.getElementById('profileSettingsBtn');
          const privacyBtn = document.getElementById('profilePrivacyBtn');

          // Try to obtain current user. Prefer explicit admin profile, but do not gate UI on an "admin unauthorized" flag.
          let u = null;
          try {
            try {
              const ar = window.apiFetch ? await window.apiFetch('/api/admin/profile') : await fetch('/api/admin/profile', { credentials: 'include' });
              if (ar && ar.ok) {
                const aj = await ar.json().catch(()=>null);
                u = (aj && (aj.user || aj.profile || aj.admin)) || aj || null;
                // If admin profile shape is { profile: { adminName, adminEmail } } normalise it
                if (u && !u.id && aj && aj.profile) {
                  const p = aj.profile;
                  u = { id: p.id || null, username: p.adminName || p.adminEmail || null, email: p.adminEmail || null, full_name: p.adminName || null, role: (p.adminRole || 'admin'), avatar: p.adminAvatar || null };
                }
              } else if (ar && ar.status === 401) {
                // Try a session-to-admin mapping check: this endpoint verifies whether the
                // current session corresponds to an admin in admin_logins (by id or email).
                try {
                  const vr = window.apiFetch ? await window.apiFetch('/api/admin/validate') : await fetch('/api/admin/validate', { credentials: 'include' });
                  if (vr && vr.ok) {
                    const vj = await vr.json().catch(()=>null);
                    if (vj && vj.admin) {
                      const a = vj.admin;
                      u = { id: a.id || null, username: a.username || a.email || null, email: a.email || null, full_name: a.full_name || null, role: 'admin', avatar: a.avatar || null };
                      try { if (typeof window.clearAdminUnauthorized === 'function') window.clearAdminUnauthorized(); else try{ window._wispaAdminUnauthorized = false; }catch(e){} } catch(e){}
                    }
                  }
                } catch (e) { /* ignore */ }
              }
            } catch (e) { /* ignore admin-profile failure and fallback to getCurrentUser */ }
          } catch(e){}
          if(!u) u = await window.getCurrentUser();
          // Determine admin status from fetched user object
          const isAdmin = !!(u && (u.role === 'admin' || u.adminRole === 'admin' || u.isAdmin));
          // Clear any stale admin-unauthorized backoff when we detect a valid admin session
          try { if (isAdmin) { if (typeof window.clearAdminUnauthorized === 'function') window.clearAdminUnauthorized(); else try{ window._wispaAdminUnauthorized = false; }catch(e){} } } catch(e){}
          if(!u){ if(msgs) msgs.textContent = 'Not signed in.'; }
          const displayName = u ? (u.full_name || u.name || u.displayName || u.username || '') : '';
          const displayEmail = u ? (u.email || u.user_email || '') : '';
          const roleText = u ? ((u.role || u.roles || u.isAdmin) ? (u.role || (u.isAdmin? 'Administrator':'Admin')) : 'Admin') : 'Admin';

          if(nameInput) nameInput.value = displayName; if(nameDisplay) nameDisplay.textContent = displayName;
          if(emailInput) emailInput.value = displayEmail; if(emailDisplay) emailDisplay.textContent = displayEmail;
          if(roleEl) roleEl.textContent = roleText;
          if(msgs) msgs.textContent = '';
          if(u.avatar && avatar) avatar.innerHTML = '<img src="'+ (u.avatar) + '" style="width:100%;height:100%;object-fit:cover">';
          // Show verified icon for admin sessions
          try{
            const verifiedEl = document.getElementById('profileVerified');
            if(verifiedEl) verifiedEl.style.display = isAdmin ? 'inline-block' : 'none';
          }catch(e){}

          // If a legacy save button exists, wire it. Otherwise the Settings link handles editing.
          if(saveBtn){
            saveBtn.addEventListener('click', async function(){
              try{
                saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
                const payload = { full_name: (nameInput?nameInput.value:displayName), email: (emailInput?emailInput.value:displayEmail) };
                await window.saveAdminProfile(payload);
                if(msgs) msgs.textContent = 'Profile saved.';
                saveBtn.textContent = 'Saved';
                setTimeout(()=>{ saveBtn.textContent = 'Save Profile'; saveBtn.disabled = false; }, 1200);
              }catch(e){ if(msgs) msgs.textContent = 'Save failed.'; saveBtn.disabled = false; saveBtn.textContent = 'Save Profile'; }
            });
          }

          if(settingsBtn){ settingsBtn.addEventListener('click', function(e){ e.preventDefault(); try{ switchTab('edit-profile'); }catch(err){} }); }
          if(privacyBtn){ privacyBtn.addEventListener('click', function(e){ e.preventDefault(); try{ switchTab('privacy'); }catch(err){} }); }
        }catch(e){ console.warn('Profile panel init failed', e); }
      });
    </script>

    <section id="alerts" class="tab-panel">
      <h2>System Alerts</h2>
      <p><button id="refreshAlerts">Refresh</button></p>
      <div id="alertsList">Loading alerts‚Ä¶</div>
    </section>

    <section id="notifications" class="tab-panel">
      <h2>Notifications</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <!-- Tabs removed: use the filter dropdown rendered inside the view instead -->
        <button id="refreshNotifications">Refresh</button>
      </div>
      <div id="notificationsContent">Loading notifications‚Ä¶</div>
    </section>

    <section id="create-post" class="tab-panel">
      <h2>Create Property Post</h2>
      <p>Use this form to create a new property post for users.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:920px">
        <label style="display:block">Title<input id="postTitle" placeholder="Title" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">Price<input id="postPrice" placeholder="200000" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">Address<input id="postAddress" placeholder="123 Main St" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">Type<input id="postType" placeholder="house, apartment" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">For<select id="postFor" style="width:100%;padding:8px;margin-top:6px"><option value="sale">Sale</option><option value="rent">Rent</option></select></label>
        <label style="display:block">Bedrooms<input id="postBeds" type="number" min="0" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">Bathrooms<input id="postBaths" type="number" min="0" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="display:block">Area (m¬≤)<input id="postArea" type="number" min="0" style="width:100%;padding:8px;margin-top:6px"/></label>
        <label style="grid-column:1 / -1;display:block">Description<textarea id="postDescription" rows="6" style="width:100%;padding:8px;margin-top:6px"></textarea></label>
        
        <label style="display:block">Post to<select id="postTo" style="width:100%;padding:8px;margin-top:6px"><option value="available">Available</option><option value="hot">Hot</option><option value="featured">Featured</option></select></label>
        <label style="grid-column:1 / -1;display:block">Select Images/Videos (you can choose multiple)</label>
        <div style="grid-column:1 / -1;display:flex;gap:8px;align-items:center">
          <input id="postImagesFiles" type="file" accept="image/*,video/*" multiple style="flex:0 0 auto" />
          <div id="postImagesPreview" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
        <label style="grid-column:1 / -1;display:block"><input type="checkbox" id="postNotify"/> Notify users about this post</label>
      </div>
      <p style="margin-top:12px"><button id="createPostBtn">Create Post</button> <button id="createPostClear">Clear</button></p>
      <div id="createPostStatus" style="margin-top:8px;color:#666"></div>
    </section>

      <section id="properties" class="tab-panel">
        <h2>Properties</h2>
        <p>
          <button id="refreshProperties">Refresh</button>
          <label style="margin-left:12px">Search: <input id="propSearch" placeholder="title or address" style="min-width:180px"></label>
          <label style="margin-left:8px">Type: <input id="propType" placeholder="house, apartment" style="width:120px"></label>
          <label style="margin-left:8px">For: <select id="propSaleRent"><option value="">All</option><option value="sale">Sale</option><option value="rent">Rent</option></select></label>
        </p>
        <div id="propertiesList">Loading properties‚Ä¶</div>
      </section>

      <section id="users" class="tab-panel">
        <h2>Users</h2>
        <p>
          <button id="refreshUsers">Refresh</button>
          <label style="margin-left:12px">Search: <input id="userSearch" placeholder="name or email" style="min-width:200px"></label>
          <label style="margin-left:8px">Role: <select id="userRole"><option value="">All</option><option value="user">User</option><option value="admin">Admin</option></select></label>
        </p>
        <div id="usersList">Loading users‚Ä¶</div>
      </section>
  </main>

  <!-- Notification detail modal -->
  <div id="notifDetailModal" role="dialog" aria-hidden="true">
    <div class="modal-card" role="document">
      <div id="notifDetailHeader"><h3 id="notifDetailTitle">Notification</h3><div id="notifDetailTime" style="color:#666;font-size:12px"></div></div>
      <div id="notifDetailBody" style="margin-top:8px;color:#222;line-height:1.4"></div>
      <div class="modal-actions">
        <button id="notifDetailPrimary" class="tab-btn">Open</button>
        <button id="notifDetailMark" class="tab-btn">Mark Read</button>
        <button id="notifDetailClose" class="tab-btn" style="background:#fff;border:1px solid #e6eef7">Close</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Minimal admin UI wiring
    const hamburger = document.getElementById('hamburger');
    const menu = document.getElementById('menuDropdown');
    async function loadHamburgerProfile(){
      try{
        const avatarEl = document.getElementById('hamburgerProfileAvatar');
        const hamburgerBtn = document.getElementById('hamburger');
        const nameEl = document.getElementById('hamburgerProfileName');
        const emailEl = document.getElementById('hamburgerProfileEmail');
        let u = null;
        try { if(window.getCurrentUser) u = await window.getCurrentUser(); }catch(e){}
        if(!u){ try{ const res = await fetch('/api/admin/profile', { credentials: 'include' }); if(res && res.ok){ const j = await res.json().catch(()=>null); u = (j && (j.user||j.profile||j.admin)) || j || null; } }catch(e){} }
        if(u){
          try{
            if(avatarEl){
              const av = u.avatar || u.avatar_url || u.adminAvatar || null;
              avatarEl.innerHTML = av ? '<img src="'+av+'" style="width:100%;height:100%;object-fit:cover">' : '';
              try{ if(hamburgerBtn){ if(av) { hamburgerBtn.innerHTML = '<img src="'+av+'" style="width:24px;height:24px;border-radius:50%;object-fit:cover">'; hamburgerBtn.title = (u.full_name||u.name||u.email||'Profile'); } else { hamburgerBtn.innerHTML = '‚ò∞'; hamburgerBtn.title = 'Menu'; } } }catch(e){}
            }
          }catch(e){}
          try{
            if(nameEl){
              const displayName = (u.full_name || u.name || u.username || u.email || 'Admin');
              const roleRaw = (u.role || u.adminRole || (u.isAdmin? 'admin' : '')) || '';
              const roleLabel = roleRaw ? (String(roleRaw).charAt(0).toUpperCase() + String(roleRaw).slice(1)) : '';
              nameEl.textContent = roleLabel ? (displayName + ' - ' + roleLabel) : displayName;
            }
          }catch(e){}
          try{ if(emailEl) emailEl.textContent = u.email || ''; }catch(e){}
        }
      }catch(e){ /* ignore */ }
    }
    hamburger.addEventListener('click', ()=>{ const open = (menu.style.display!=='block'); if(open) { menu.style.display = 'block'; loadHamburgerProfile().catch(()=>{}); } else { menu.style.display = 'none'; } });
    window.addEventListener('click', (e)=>{ if(!e.target.closest('#menuDropdown') && !e.target.closest('#hamburger')) menu.style.display='none' });

    function switchTab(name){
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active', p.id===name));
      // expose current tab on body for easy querying
      try{ document.body.dataset.currentTab = name; }catch(e){}
      // Show header chat quick-search only when chat tab is active
      try{ const wrap = document.getElementById('chatHeaderSearchWrap'); if(wrap) wrap.style.display = (name==='chat') ? 'block' : 'none'; }catch(e){}
      location.hash = '#'+name;
      try{ if(typeof updateBackButton === 'function') updateBackButton(); }catch(e){}
      // Call panel-specific loaders when switching
      try{ if(name === 'edit-profile' && typeof loadEditProfile === 'function') { setTimeout(()=>{ try{ loadEditProfile(); }catch(e){} }, 40); } }catch(e){}
      try{ if(name === 'chat'){ setTimeout(()=>{ try{ const si = document.getElementById('chatSearchInput'); if(si){ si.focus(); si.scrollIntoView({behavior:'smooth', block:'center'}); } const hs = document.getElementById('chatHeaderSearch'); if(hs){ hs.focus(); } }catch(e){} },60); } }catch(e){}
    }

    // Helper: return currently opened tab id (or null)
    function getCurrentTab(){
      try{
        if(document.body && document.body.dataset && document.body.dataset.currentTab) return document.body.dataset.currentTab;
        const el = document.querySelector('.tab-panel.active');
        return el ? el.id : null;
      }catch(e){ return null; }
    }
    // expose for debugging/other scripts
    window.getCurrentTab = getCurrentTab;

    // Back button helpers: show when not on overview and handle click
    function updateBackButton(){
      try{
        const btn = document.getElementById('adminBackBtn'); if(!btn) return;
        const cur = getCurrentTab();
        // show whenever current tab is not overview (or when there's history)
        if(cur && cur !== 'overview') btn.style.display = 'inline-flex'; else btn.style.display = 'none';
      }catch(e){}
    }
    (function(){
      const btn = document.getElementById('adminBackBtn');
      if(!btn) return;
      // Always navigate to the Overview when the back arrow is clicked
      btn.addEventListener('click', function(e){ e.preventDefault(); try{ switchTab('overview'); }catch(err){} });
      window.addEventListener('hashchange', updateBackButton);
      document.addEventListener('DOMContentLoaded', function(){ setTimeout(updateBackButton, 40); });
    })();

    document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click', ()=>switchTab(b.dataset.tab)));
    document.querySelectorAll('#menuDropdown a[data-tab]').forEach(a=>a.addEventListener('click', (e)=>{ e.preventDefault(); switchTab(a.dataset.tab); menu.style.display='none' }));

    // Clicking the top profile area should open the profile tab
    (function(){
      try{
        const hp = document.getElementById('hamburgerProfile');
        if(hp){ hp.addEventListener('click', function(e){ e.preventDefault(); switchTab('profile'); menu.style.display='none'; }); }
      }catch(e){}
    })();

    // Header profile button opens profile tab
    (function(){
      const pBtn = document.getElementById('adminProfileBtn');
      if(pBtn){ pBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('profile'); }); }
    })();

    // Edit Profile loader + handlers
    async function loadEditProfile(){
      try{
        const status = document.getElementById('editStatus'); if(status) status.textContent = 'Loading‚Ä¶';
        let u = null;
        // Prefer the admin profile API to ensure we read authoritative DB values
        try{
          const res = window.apiFetch ? await window.apiFetch('/api/admin/profile') : await fetch('/api/admin/profile', { credentials: 'include' });
          if(res && res.ok){ const j = await res.json().catch(()=>null); u = j || null; }
        }catch(e){}
        // Fallback to getCurrentUser or /api/me
        if(!u){ try{ if(window.getCurrentUser) u = await window.getCurrentUser(); else { const r = await fetch('/api/me',{credentials:'include'}); if(r && r.ok){ const jm = await r.json().catch(()=>null); u = jm || null; } } }catch(e){} }
        // Normalize common wrapper shapes: { profile }, { user }, or admin-specific keys
        try{ if(u && (u.profile || u.user)) u = u.profile || u.user; }catch(e){}
        if(!u){ if(status) status.textContent = 'Not signed in.'; return; }
        // Populate fields
        try{ document.getElementById('editFullName').value = u.full_name || u.fullName || u.name || u.username || u.adminName || ''; }catch(e){}
        try{ document.getElementById('editEmail').value = u.email || u.adminEmail || ''; }catch(e){}
        try{ document.getElementById('editPhone').value = u.phone || u.phone_number || u.mobile || u.contact || u.adminPhone || ''; }catch(e){}
        try{ document.getElementById('editGender').value = (u.gender || u.sex || u.adminGender || '').toString().toLowerCase() || ''; }catch(e){}
        try{ document.getElementById('editLocation').value = u.location || u.city || ''; }catch(e){}
        try{ document.getElementById('editBio').value = u.bio || u.about || u.description || u.adminBio || ''; }catch(e){}
        try{ const pv = document.getElementById('editAvatarPreview'); if(pv){ const av = u.avatar || u.avatar_url || u.adminAvatar || null; pv.innerHTML = av ? '<img src="'+av+'" style="width:100%;height:100%;object-fit:cover">' : ''; } }catch(e){}
        if(status) status.textContent = '';
      }catch(e){ try{ if(document.getElementById('editStatus')) document.getElementById('editStatus').textContent = 'Failed to load profile.'; }catch(_){} }
    }

    document.addEventListener('DOMContentLoaded', function(){
      try{
        const saveBtn = document.getElementById('editSaveBtn');
        const cancelBtn = document.getElementById('editCancelBtn');
        if(cancelBtn) cancelBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('profile'); });
        if(saveBtn){
          saveBtn.addEventListener('click', async function(e){
            e.preventDefault();
            const status = document.getElementById('editStatus'); if(status) status.textContent = 'Saving‚Ä¶';
            saveBtn.disabled = true;
            try{
              const full_name = document.getElementById('editFullName').value || '';
              const email = document.getElementById('editEmail').value || '';
              const phone = document.getElementById('editPhone').value || '';
              const location = document.getElementById('editLocation').value || '';
              const avatarFile = (document.getElementById('editAvatarFile') && document.getElementById('editAvatarFile').files && document.getElementById('editAvatarFile').files[0]) ? document.getElementById('editAvatarFile').files[0] : null;
              let avatarUrl = null;
              if(avatarFile){
                try{
                  const fd = new FormData(); fd.append('avatar', avatarFile);
                  const poster = (typeof window !== 'undefined' && window.apiFetch) ? window.apiFetch : fetch;
                  const upResp = await poster('/api/upload-avatar', { method: 'POST', body: fd });
                  if(upResp && upResp.ok){ const upj = await upResp.json(); avatarUrl = upj.imageUrl || upj.url || upj.image || null; }
                }catch(e){ console.warn('avatar upload failed', e); }
              }
              const payload = { full_name, email, phone, location };
              try{ const bioEl = document.getElementById('editBio'); if(bioEl) payload.bio = bioEl.value || ''; }catch(e){}
              try{ const gEl = document.getElementById('editGender'); if(gEl) payload.gender = gEl.value || ''; }catch(e){}
              if(avatarUrl){ payload.avatar_url = avatarUrl; payload.avatar = avatarUrl; }
              // Use global saveAdminProfile helper
              try{
                const resp = await window.saveAdminProfile(payload);
                // prefer returned avatar_url, fall back to uploaded avatarUrl
                const newAvatar = (resp && (resp.avatar_url || resp.avatar)) || avatarUrl || null;
                if(status) status.textContent = 'Saved.';
                // Immediately update UI using the known avatar (avoid relying on re-fetch when session/cookies may block)
                try{ if(newAvatar){ const headAvatar = document.getElementById('adminHeaderAvatar'); if(headAvatar) headAvatar.innerHTML = '<img src="'+newAvatar+'" style="width:100%;height:100%;object-fit:cover">'; } }catch(e){}
                try{ if(newAvatar){ const bigAvatar = document.getElementById('admin-avatar'); if(bigAvatar) bigAvatar.innerHTML = '<img src="'+newAvatar+'" style="width:100%;height:100%;object-fit:cover">'; } }catch(e){}
                try{ if(newAvatar){ const hp = document.getElementById('hamburgerProfileAvatar'); if(hp) hp.innerHTML = '<img src="'+newAvatar+'" style="width:100%;height:100%;object-fit:cover">'; } }catch(e){}
                try{ const hamburgerBtn = document.getElementById('hamburger'); if(hamburgerBtn){ if(newAvatar) { hamburgerBtn.innerHTML = '<img src="'+newAvatar+'" style="width:24px;height:24px;border-radius:50%;object-fit:cover">'; hamburgerBtn.title = 'Profile'; } else { hamburgerBtn.innerHTML = '‚ò∞'; hamburgerBtn.title = 'Menu'; } } }catch(e){}
                try{ const pv = document.getElementById('editAvatarPreview'); if(pv){ pv.innerHTML = newAvatar ? '<img src="'+newAvatar+'" style="width:100%;height:100%;object-fit:cover">' : pv.innerHTML; } }catch(e){}
                try{ if(typeof loadProfile === 'function') await loadProfile(); }catch(e){}
                try{ if(typeof loadHamburgerProfile === 'function') await loadHamburgerProfile(); }catch(e){}
                setTimeout(()=>{ try{ switchTab('profile'); }catch(e){} }, 400);
              }catch(e){ if(status) status.textContent = 'Save failed.'; throw e; }
            }catch(err){ console.error(err); }
            saveBtn.disabled = false;
          });
        }
        // Preview selected avatar immediately
        try{
          const avatarFileEl = document.getElementById('editAvatarFile');
          if(avatarFileEl){ avatarFileEl.addEventListener('change', function(e){ try{ const f = avatarFileEl.files && avatarFileEl.files[0]; const pv = document.getElementById('editAvatarPreview'); if(!pv) return; if(!f){ pv.innerHTML = ''; return; } try{ const url = URL.createObjectURL(f); pv.innerHTML = '<img src="'+url+'" style="width:100%;height:100%;object-fit:cover">'; }catch(e){} }catch(e){} }); }
        }catch(e){}
      }catch(e){ }
    });

    document.getElementById('logoutLink').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await fetch('/api/logout',{method:'POST', credentials:'include'}); }catch(e){}
      location.href = '/admin-login.html';
    });

    // Wire debug link to call both admin and user debug helpers
    (function(){
      try{
        const dbg = document.getElementById('debugLink');
        if(dbg){
          dbg.addEventListener('click', async function(e){
            e.preventDefault();
            try{
              const [adminRes, userRes] = await Promise.all([ window.debugAdminAuth && window.debugAdminAuth().catch(e=>({error:String(e)})), window.debugUserAuth && window.debugUserAuth().catch(e=>({error:String(e)})) ]);
              console.log('Debug results - admin:', adminRes, 'user:', userRes);
              let msg = 'Debug results:\n';
              msg += 'Admin -> ' + (adminRes && (adminRes.status||adminRes.error) ? (adminRes.status || adminRes.error) : 'ok') + '\n';
              msg += 'User  -> ' + (userRes && (userRes.status||userRes.error) ? (userRes.status || userRes.error) : 'ok') + '\n';
              alert(msg);
            }catch(e){ alert('Debug failed: ' + (e && e.message ? e.message : String(e))); }
          });
        }
      }catch(e){ console.warn('Debug link wiring failed', e); }
    })();

    // Header icon handlers: quick search, notifications, chats
    const quickSearchBtn = document.getElementById('quickSearchBtn');
    const notificationsBtn = document.getElementById('notificationsBtn');
    const chatsBtn = document.getElementById('chatsBtn');
    const quickSearchEl = document.getElementById('adminQuickSearch');
    const quickSearchInput = document.getElementById('adminQuickSearchInput');
    const quickSearchResults = document.getElementById('adminQuickSearchResults');
    const quickSearchClose = document.getElementById('adminQuickSearchClose');

    function openQuickSearch(){ quickSearchEl.style.display='block'; quickSearchInput.value=''; quickSearchResults.innerHTML=''; quickSearchInput.focus(); }
    function closeQuickSearch(){ quickSearchEl.style.display='none'; quickSearchResults.innerHTML=''; }

    quickSearchBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(quickSearchEl.style.display==='block') closeQuickSearch(); else openQuickSearch(); });
    quickSearchClose.addEventListener('click', closeQuickSearch);
    window.addEventListener('click', (e)=>{ if(!e.target.closest('#adminQuickSearch') && !e.target.closest('#quickSearchBtn')) closeQuickSearch(); });

    async function doQuickSearch(q){
      if(!q || q.trim().length<2){ quickSearchResults.innerHTML = '<div style="color:#666;padding:8px">Type 2+ chars to search</div>'; return }
      quickSearchResults.innerHTML = '<div style="color:#666;padding:8px">Searching‚Ä¶</div>';
      try{
        const [propsResp, usersResp, reqsResp] = await Promise.all([
          safeApi('/api/properties').catch(()=>null),
          safeApi('/api/users').catch(()=>null),
          safeApi('/api/property-requests').catch(()=>null)
        ]);
        const ql = q.toLowerCase();
        const items = [];
        if(propsResp && Array.isArray(propsResp.properties)){
          for(const p of propsResp.properties){ const hay = ((p.title||'')+' '+(p.address||'')).toLowerCase(); if(hay.indexOf(ql)!==-1) items.push({type:'property', title: p.title||p.address||('Property #'+(p.id||'')), id:p.id}) }
        }
        if(usersResp && Array.isArray(usersResp.users)){
          for(const u of usersResp.users){ const hay = ((u.full_name||'')+' '+(u.email||'')+' '+(u.username||'')).toLowerCase(); if(hay.indexOf(ql)!==-1) items.push({type:'user', title: u.full_name||u.email||u.username, id:u.id}) }
        }
        if(reqsResp && Array.isArray(reqsResp.requests)){
          for(const r of reqsResp.requests){ const hay = ((r.name||'')+' '+(r.email||'')+' '+(r.message||'')).toLowerCase(); if(hay.indexOf(ql)!==-1) items.push({type:'request', title: r.name||r.email||'Request', id:r.id}) }
        }
        if(!items.length) quickSearchResults.innerHTML = '<div style="color:#666;padding:8px">No results</div>';
        else quickSearchResults.innerHTML = '<ul style="list-style:none;margin:0;padding:0">'+items.slice(0,12).map(it=>`<li style="padding:8px;border-bottom:1px solid #f2f6fb"><a href="#" data-type="${it.type}" data-id="${it.id}" class="quick-result">${escapeHtml(it.title)} <span style="color:#777;font-size:12px">(${it.type})</span></a></li>`).join('')+'</ul>';
        // wire click handlers
        quickSearchResults.querySelectorAll('.quick-result').forEach(a=>a.addEventListener('click', (ev)=>{ ev.preventDefault(); const t=a.dataset.type; const id=a.dataset.id; closeQuickSearch(); if(t==='property'){ switchTab('properties'); setTimeout(()=>{ document.getElementById('propSearch').value = id; renderPropertiesList(_propertiesCache); }, 120); } else if(t==='user'){ switchTab('users'); setTimeout(()=>{ document.getElementById('userSearch').value = id; renderUsersList(_usersCache); }, 120); } else if(t==='request'){ switchTab('requests'); } }));
      }catch(err){ quickSearchResults.innerHTML = '<div style="color:#c33;padding:8px">Search failed</div>' }
    }

    quickSearchInput.addEventListener('input', (e)=>{ const v=e.target.value; doQuickSearch(v); });

    // Overview footer helpers: date/time, version, safety rate, copyright
    (function(){
      function updateDateTime(){ try{ const el = document.getElementById('footerDateTime'); if(!el) return; const d = new Date(); el.textContent = d.toLocaleString(); }catch(e){} }
      async function loadVersionAndSafety(){
        try{
          const verEl = document.getElementById('footerVersion');
          const safEl = document.getElementById('footerSafety');
          const copyEl = document.getElementById('footerYear');
          if(copyEl) copyEl.textContent = (new Date()).getFullYear();
          // Read version from meta tag first (no network fetch)
          try{
            const meta = document.querySelector('meta[name="app-version"]');
            if(meta && meta.content && verEl) verEl.textContent = 'Version: ' + meta.content;
            else if(verEl) verEl.textContent = 'Version: unknown';
          }catch(e){ if(verEl) verEl.textContent = 'Version: unknown'; }

          // Read safety rate from window.safetyRate if provided (no network fetch)
          try{
            if(typeof window.safetyRate !== 'undefined'){
              const s = String(window.safetyRate);
              if(safEl) safEl.textContent = (s.indexOf('%')!==-1) ? ('Safety rate: ' + s) : ('Safety rate: ' + s + '%');
            } else {
              if(safEl) safEl.textContent = 'Safety rate: N/A';
            }
          }catch(e){ if(safEl) safEl.textContent = 'Safety rate: N/A'; }
        }catch(e){}
      }
      updateDateTime(); setInterval(updateDateTime, 1000);
      loadVersionAndSafety();
      // Auto-debug routine: run every 5 minutes to compute safety rate
      async function autoDebugSafety(){
        try{
          const footerEl = document.getElementById('footerSafety');
          // helper: fetch with timeout
          const fetchWithTimeout = (url, opts={}, ms=5000)=>{
            return new Promise(async (resolve)=>{
              try{
                const ac = new AbortController(); const id = setTimeout(()=>ac.abort(), ms);
                const r = await fetch(url, Object.assign({ signal: ac.signal, credentials: 'include' }, opts)).catch(e=>null);
                clearTimeout(id); resolve(r);
              }catch(e){ resolve(null); }
            });
          };

          const endpoints = ['/api/admin/profile','/api/properties','/api/users'];
          const API_BASE = (window.WISPA_API_BASE || '').replace(/\/+$/,'');
          let checks = 0, errors = 0;
          for(const ep of endpoints){
            try{
              const target = API_BASE ? (API_BASE + ep) : ep;
              const r = await fetchWithTimeout(target, {}, 4000);
              // skip if not reachable or intentionally blocked (401/403/404)
              if(!r) continue;
              if([401,403,404].includes(r.status)) continue;
              // count this endpoint check
              checks++;
              if(!r.ok) errors++; // non-OK (e.g. 5xx) => error
            }catch(e){ /* ignore network/CORS issues and don't penalize */ }
          }

          // Inspect data files if exposed (contribute to checks)
          // Only attempt these fetches when `window.WISPA_DATA_AVAILABLE` is true
          // AND when the API base is same-origin (avoids noisy 404s against remote hosts).
          const canFetchDataFiles = Boolean(window.WISPA_DATA_AVAILABLE) && (!API_BASE || API_BASE === window.location.origin);
          if(canFetchDataFiles){
            try{
              const contactTarget = API_BASE ? (API_BASE + '/data/contact_messages.json') : '/data/contact_messages.json';
              const rc = await fetchWithTimeout(contactTarget, {}, 3000);
              // ignore missing or blocked files (401/403/404)
              if(rc && ![401,403,404].includes(rc.status)){
                if(rc.ok){ const arr = await rc.json().catch(()=>null); if(Array.isArray(arr)){ checks += arr.length; for(const it of arr){ const txt = ((it.subject||'')+' '+(it.message||'')).toLowerCase(); if(/error|failed|exception|traceback|stack|err/i.test(txt)) errors++; } } }
              }
            }catch(e){}
            try{
              const alertsTarget = API_BASE ? (API_BASE + '/data/system_alerts.json') : '/data/system_alerts.json';
              const rs = await fetchWithTimeout(alertsTarget, {}, 3000);
              if(rs && ![401,403,404].includes(rs.status)){
                if(rs.ok){ const arr = await rs.json().catch(()=>null); if(Array.isArray(arr)){ checks += arr.length; for(const a of arr){ if(a && (a.severity==='error' || a.severity==='critical')) errors++; } } }
              }
            }catch(e){}

            // server.err presence counts as an error only if the file exists and is non-empty
            try{
              const serverErrTarget = API_BASE ? (API_BASE + '/server.err') : '/server.err';
              const rerr = await fetchWithTimeout(serverErrTarget, {}, 2000);
              if(rerr && ![401,403,404].includes(rerr.status)){
                const txt = await rerr.text().catch(()=>null);
                if(typeof txt === 'string'){ checks++; if(txt.trim().length>0) errors++; }
              }
            }catch(e){}
          }

          // Run debug auth checks (admin + user) if available
          let authChecks = 0, authErrors = 0, adminOk = false, userOk = false;
          try{
            if(typeof window.debugAdminAuth === 'function'){ authChecks++; try{ const ar = await window.debugAdminAuth(); if(ar && ar.status===200) { adminOk = true; } else { authErrors++; } }catch(e){ authErrors++; } }
          }catch(e){}
          try{
            if(typeof window.debugUserAuth === 'function'){ authChecks++; try{ const ur = await window.debugUserAuth(); if(ur && ur.status===200) { userOk = true; } else { authErrors++; } }catch(e){ authErrors++; } }
          }catch(e){}

          const authRate = (authChecks>0) ? Math.max(0, Math.round(100*(1 - (authErrors/authChecks)))) : 100;

          // Base safety from other checks
          const baseSafePercent = (checks>0) ? Math.max(0, Math.round(100*(1 - (errors/checks)))) : 100;
          // Combine base safety and auth rate (equal weight)
          const combined = Math.round((baseSafePercent + authRate) / 2);
          window.safetyRate = combined + '%';

          if(footerEl) footerEl.textContent = `Safety (auth/base): ${authRate}% / ${baseSafePercent}% (avg ${window.safetyRate})`;
          try{ const hp = document.getElementById('hamburgerAuthStatus'); if(hp) hp.textContent = `Auth: ${adminOk? 'A:OK' : 'A:ERR'} ${userOk? 'U:OK' : 'U:ERR'} (${authRate}%)`; }catch(e){}
          console.info('[autoDebugSafety] checks=', checks, 'errors=', errors, 'baseSafe=', baseSafePercent, 'authRate=', authRate, 'combined=', window.safetyRate);
          try{ const dbg = document.getElementById('footerDebug'); if(dbg) dbg.textContent = `Last check: ${new Date().toLocaleString()} ‚Äî checks=${checks}, errors=${errors}, base=${baseSafePercent}%, auth=${authRate}%, combined=${window.safetyRate}`; }catch(e){}
        }catch(e){ console.warn('autoDebugSafety failed', e); }
      }
      // run immediately and every 5 minutes
      try{ autoDebugSafety().catch(()=>{}); setInterval(()=>{ autoDebugSafety().catch(()=>{}); }, 5 * 60 * 1000); }catch(e){}
    })();

    // Notifications: open dropdown showing full notifications (quick view)
    const notifDropdown = document.getElementById('notifDropdown');
    const notifDropdownContent = document.getElementById('notifDropdownContent');
    const notifOpenFull = document.getElementById('notifOpenFull');
    // helper: set active notif sub-tab
    function setActiveNotifTab(view){
      try{
        document.querySelectorAll('.notif-tab').forEach(b=>b.classList.toggle('active', b.dataset.view===view));
        // If the filter select exists in the notifications view, keep it in sync
        const sel = document.getElementById('notifViewSelect'); if(sel) sel.value = view || 'all';
      }catch(e){}
    }
    async function renderNotifDropdown(){
      notifDropdownContent.innerHTML = '<div style="padding:12px;color:#666">Loading‚Ä¶</div>';
      try{
        const data = await safeApi('/api/admin/sent-notifications');
        let rows = Array.isArray(data) ? data : (data && data.notifications) ? data.notifications : (data && data.items) ? data.items : [];
        if(!rows || !rows.length) { notifDropdownContent.innerHTML = '<div style="padding:12px;color:#666">No notifications.</div>'; return }
        notifDropdownContent.innerHTML = rows.slice(0,12).map(n=>`<div style="padding:10px;border-bottom:1px solid #f6f9fc"><div style="font-weight:700">${escapeHtml(n.title||n.message||'Notification')}</div><div style="color:#666;font-size:13px;margin-top:4px">${escapeHtml((n.message||'').slice(0,240))}</div><div style="font-size:12px;color:#999;margin-top:6px">${escapeHtml(n.sentAt||n.createdAt||'')}</div></div>`).join('');
      }catch(e){ notifDropdownContent.innerHTML = '<div style="padding:12px;color:#c33">Failed to load</div>' }
    }
    // Open notifications when bell icon is clicked.
    // Always open the full Notifications panel; on mobile it should behave like
    // the chat page (full panel). After opening, focus the notifications panel
    // and show the 'all' view.
    notificationsBtn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{
        // Primary: use the standard tab switch
        switchTab('notifications');
        setActiveNotifTab('all');
        setTimeout(()=>{
          renderNotificationsView('all');
          // Stronger fallback: ensure panel is active and visible (helps when CSS hides panels on mobile)
          try{
            const panel = document.getElementById('notifications');
            if (panel){
              panel.classList.add('active');
              try{ document.body.dataset.currentTab = 'notifications'; }catch(_){ }
              try{ location.hash = '#notifications'; }catch(_){ }
              try{ if(typeof menu !== 'undefined' && menu) menu.style.display = 'none'; }catch(_){ }
              try{ if(panel.scrollIntoView) panel.scrollIntoView({behavior:'smooth'}); }catch(_){ }
              try{ /* Force visible on mobile even if stylesheet hides panels via !important */ panel.style.setProperty('display','block','important'); }catch(_){ }
            }
            const sel = document.getElementById('notifViewSelect'); if(sel) sel.focus();
          }catch(_){ }
        },50);
      }catch(e){ console.warn('Failed to open notifications', e); }
    });
    // clicking outside should close dropdown (use element.contains for reliability)
    window.addEventListener('click', (e)=>{
      try{
        const clickedInsideDropdown = notifDropdown && notifDropdown.contains(e.target);
        const clickedOnBell = notificationsBtn && notificationsBtn.contains(e.target);
        if(!clickedInsideDropdown && !clickedOnBell) {
          notifDropdown.style.display = 'none';
          try{ notifDropdown.setAttribute('aria-hidden','true'); }catch(_){ }
        }
      }catch(_){ /* ignore */ }
    });
    notifOpenFull.addEventListener('click', (e)=>{ e.preventDefault(); notifDropdown.style.display='none'; switchTab('notifications'); setActiveNotifTab('all'); renderNotificationsView('all'); });

    // Chats: open property chats (admin conversations)
    chatsBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ location.hash = 'chat'; }catch(_){}; switchTab('chat'); renderAdminChatList(); });

    // Render admin chat list: prefer server-backed conversations, fall back to localStorage
    async function renderAdminChatList(){
      // If the new AdminChatWidget is available, delegate to it and skip the legacy renderer
      try{
        if (window._adminChatWidget && typeof window._adminChatWidget.loadConversations === 'function'){
          try{ window._adminChatWidget.loadConversations(); return; }catch(e){ console.warn('AdminChatWidget.loadConversations failed', e); }
        }
      }catch(e){}
      const out = document.getElementById('admin-chats-list');
      out.innerHTML = 'Loading‚Ä¶';
      try{
        // Try server-side conversations first (includes property/user messages saved to DB)
        try{
          const data = await safeApi('/api/conversations');
          let convs = [];
          if (data) convs = Array.isArray(data.conversations) ? data.conversations : (Array.isArray(data) ? data : []);
          // Normalize to expected meta fields
          if (convs && convs.length) {
            const mapped = convs.map(c => ({ id: c.id || c.conversation_id || c.key || (c.user_id?('user-'+c.user_id):null), participantName: c.title || c.participantName || c.userName || c.user_email || (c.meta && c.meta.property && c.meta.property.title) || null, lastMessage: c.last || c.last_message || c.lastMessage || c.updated || '', unread: c.unread || 0 }));
            out.innerHTML = '<ul style="list-style:none;margin:0;padding:0">'+mapped.map(c=>`<li style="padding:10px;border-bottom:1px solid #f6f9fc"><a href="admin.html#conversation?id=${encodeURIComponent(c.id||'')}" data-id="${escapeHtml(c.id||'')}" class="admin-chat-link" style="text-decoration:none;color:inherit;display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">${escapeHtml(c.participantName||c.userName||c.title||('Conversation '+(c.id||'unknown')))}</div><div style="color:#666;font-size:13px">${escapeHtml(c.lastMessage||'')}</div></div><div style="color:#999">${escapeHtml(String(c.unread||''))}</div></a></li>`).join('')+'</ul>';
            out.querySelectorAll('.admin-chat-link').forEach(a=>a.addEventListener('click', (ev)=>{
              // allow modifier clicks (open in new tab/window)
              if (ev.ctrlKey || ev.metaKey || ev.shiftKey || ev.button !== 0) return;
              ev.preventDefault();
              const id = a.dataset.id || (function(){ try{ const m = a.href.match(/[?&]id=([^&]+)/); return m ? decodeURIComponent(m[1]) : null; }catch(e){ return null; } })();
              console.log('admin chat clicked (server list)', id, a.href);
              try{
                try { location.hash = 'conversation?id=' + encodeURIComponent(id); } catch(e) { console.warn('failed to set hash', e); }
                if (id && typeof openAdminChat === 'function') openAdminChat(id);
                else if (typeof renderAdminChatList === 'function') renderAdminChatList();
              }catch(e){ console.error(e) }
            }));
            return;
          }
        }catch(e){ /* server may be unreachable or return no conversations; fall back to local */ }

        // Fallback: Render admin chat list from localStorage keys or fallback chatNotifications
        let convs = [];
        try{ convs = JSON.parse(localStorage.getItem('adminChats') || '[]'); }catch(e){ convs = []; }
        if(!convs || !convs.length){ try{ convs = JSON.parse(localStorage.getItem('chatNotifications') || '[]') }catch(e){ convs = []; } }
        if(!convs || !convs.length){ out.innerHTML = '<div style="padding:12px;color:#666">No conversations yet.</div>'; return }
        out.innerHTML = '<ul style="list-style:none;margin:0;padding:0">'+convs.map(c=>`<li style="padding:10px;border-bottom:1px solid #f6f9fc"><a href="admin.html#conversation?id=${encodeURIComponent(c.id)}" data-id="${escapeHtml(c.id)}" class="admin-chat-link" style="text-decoration:none;color:inherit;display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">${escapeHtml(c.participantName||c.userName||c.title||c.id)}</div><div style="color:#666;font-size:13px">${escapeHtml(c.lastMessage||'')}</div></div><div style="color:#999">${escapeHtml(String(c.unread||''))}</div></a></li>`).join('')+'</ul>';
        out.querySelectorAll('.admin-chat-link').forEach(a=>a.addEventListener('click', (ev)=>{
          if (ev.ctrlKey || ev.metaKey || ev.shiftKey || ev.button !== 0) return;
          ev.preventDefault();
          const id = a.dataset.id || (function(){ try{ const m = a.href.match(/[?&]id=([^&]+)/); return m ? decodeURIComponent(m[1]) : null; }catch(e){ return null; } })();
          console.log('admin chat clicked (local list)', id, a.href);
          try{
            try { location.hash = 'conversation?id=' + encodeURIComponent(id); } catch(e) { console.warn('failed to set hash', e); }
            if (id && typeof openAdminChat === 'function') openAdminChat(id);
            else if (typeof renderAdminChatList === 'function') renderAdminChatList();
          }catch(e){ console.error(e) }
        }));
      }catch(e){ out.innerHTML = '<div style="padding:12px;color:#c33">Failed to load chats</div>'; }
    }

    document.getElementById('refreshChats').addEventListener('click', renderAdminChatList);
    document.getElementById('chat-back').addEventListener('click', (e)=>{ e.preventDefault(); backToChatList(); });
    document.getElementById('chat-full-send').addEventListener('click', (e)=>{ 
      // If new AdminChatWidget is present, let it handle sending
      if(window._adminChatWidget && typeof window._adminChatWidget.sendMessage === 'function') return;
      const text = document.getElementById('chat-full-input').value || ''; if(!text.trim()) return; try{ const id = (document.getElementById('chat-full-title').dataset && document.getElementById('chat-full-title').dataset.chatId) || null; if(!id){ /* try to infer from title */ } sendAdminMessage(id, text); document.getElementById('chat-full-input').value=''; }catch(err){ console.error(err) } 
    });

    async function sendAdminMessage(chatId, text){
      if(!chatId){ console.warn('Missing chatId for sendAdminMessage'); return }
      const msg = { sender:'admin', text: text, ts: Date.now() };
      // If this is a property conversation, attempt to attach property metadata
      try{
        const m = String(chatId).match(/^property-(\d+)/i);
        if(m){
          const pid = parseInt(m[1],10);
          try{
            const poster = window.apiFetch ? window.apiFetch : fetch;
            const pres = await poster('/api/properties');
            if(pres && pres.ok){
              const pj = await pres.json();
              const list = Array.isArray(pj) ? pj : (pj && pj.properties) ? pj.properties : [];
              const p = list.find(pp => String(pp.id) === String(pid));
              if(p){ msg.meta = msg.meta || {}; msg.meta.property = p; }
            }
          }catch(e){}
        }
      }catch(e){}
      // Try to persist via server API so users receive admin replies
      try{
        const opts = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ convId: chatId, message: msg })
        };
        const poster = window.apiFetch ? window.apiFetch : fetch;
        const res = await poster('/api/conversations/messages', opts);
        if (res && res.ok) {
          // update adminChats meta locally for immediate UI update
          try{
            const acKey = 'adminChats';
            let ac = [];
            try{ ac = JSON.parse(localStorage.getItem(acKey) || '[]'); }catch(e){ ac = []; }
            let meta = ac.find(a=>a.id===chatId);
            const now = Date.now();
            // preserve existing participantName when present, otherwise use visible title
            const visibleName = (document.getElementById('chat-full-title') && document.getElementById('chat-full-title').textContent) ? document.getElementById('chat-full-title').textContent : null;
            if(!meta){
              meta = { id: chatId, userId: null, participantName: (visibleName||null), lastMessage: text, updated: now, unread: 0 };
              ac.unshift(meta);
            } else {
              meta.lastMessage = text;
              meta.updated = now;
              meta.unread = 0;
              if(!meta.participantName && visibleName) meta.participantName = visibleName;
            }
            try{ localStorage.setItem(acKey, JSON.stringify(ac)); }catch(e){}
          }catch(e){}
          try{ openAdminChat(chatId); }catch(e){}
          return;
        }
      }catch(e){ /* fall through to local fallback */ }

      // Fallback: save to localStorage if server unavailable
      try{
        const key = 'adminMessages_' + chatId;
        let arr = [];
        try{ arr = JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ arr = []; }
        arr.push(msg);
        try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(e){}
        // update adminChats meta
        try{
          const acKey = 'adminChats';
          let ac = [];
          try{ ac = JSON.parse(localStorage.getItem(acKey) || '[]'); }catch(e){ ac = []; }
          let meta = ac.find(a=>a.id===chatId);
          const now = Date.now();
          if(!meta){
            meta = { id: chatId, userId: null, participantName: null, lastMessage: text, updated: now, unread: 0 };
            ac.unshift(meta);
          } else {
            meta.lastMessage = text;
            meta.updated = now;
            meta.unread = 0;
          }
          try{ localStorage.setItem(acKey, JSON.stringify(ac)); }catch(e){}
        }catch(e){}
        try{ openAdminChat(chatId); }catch(e){}
      }catch(e){ console.error('Failed to send admin message', e); }
    }

    async function loadProfile(){
      try{
        let res;
        if (window.apiFetch) res = await window.apiFetch('/api/admin/profile');
        else res = await fetch('/api/admin/profile',{credentials:'include'});
        if(!res || !res.ok){
          // If unauthorized, attempt to load a locally-saved admin profile so details can still display
          if(res && res.status===401){
            try{
              // try adminLoadKey (defined in admin-profile.html) or localStorage fallback
              let localProfile = null;
              try { localProfile = (window.adminLoadKey) ? await window.adminLoadKey('adminProfile') : null; } catch(e) { localProfile = null; }
              if(!localProfile){
                try { const raw = localStorage.getItem('adminProfile'); if(raw) localProfile = JSON.parse(raw); } catch(e) { localProfile = null; }
              }
              if(localProfile){
                document.getElementById('profileName').textContent = localProfile.adminName || localProfile.name || localProfile.username || 'Admin';
                try{ document.getElementById('profileEmail').textContent = localProfile.adminEmail || localProfile.email || '‚Äî'; }catch(e){}
                try{ document.getElementById('overviewIntro').textContent = 'Offline/admin session not validated ‚Äî showing cached profile'; }catch(e){}
                return;
              }
            }catch(e){/* ignore */}
            // Don't auto-redirect to login; show a message so the page doesn't loop back
            try { document.getElementById('overviewIntro').textContent = 'Not authenticated ‚Äî please sign in via /admin-login.html'; } catch(e){}
            return;
          }
          throw new Error('Failed');
        }
        const data = await res.json();
        document.getElementById('profileName').textContent = data.full_name || data.name || data.username || 'Admin';
        document.getElementById('profileEmail').textContent = data.email || '‚Äî';
        document.getElementById('profileRole').textContent = data.role || 'admin';
        try{ const pg = document.getElementById('profileGender'); if(pg) pg.textContent = data.gender ? (String(data.gender).charAt(0).toUpperCase() + String(data.gender).slice(1)) : '‚Äî'; }catch(e){}
        try{ const pb = document.getElementById('profileBio'); if(pb) pb.textContent = data.bio || data.about || ''; }catch(e){}
        // update header profile display
        try{ const headName = document.getElementById('adminHeaderName'); if(headName) headName.textContent = data.name || data.username || data.email || 'Admin'; }catch(e){}
        try{ const headAvatar = document.getElementById('adminHeaderAvatar'); if(headAvatar){ const av = data.avatar || data.avatar_url || data.adminAvatar || null; if(av) headAvatar.innerHTML = '<img src="'+av+'" style="width:100%;height:100%;object-fit:cover">'; else headAvatar.innerHTML = ''; } }catch(e){}
        try{ const bigAvatar = document.getElementById('admin-avatar'); if(bigAvatar){ const av = data.avatar || data.avatar_url || data.adminAvatar || null; if(av) bigAvatar.innerHTML = '<img src="'+av+'" style="width:100%;height:100%;object-fit:cover">'; else bigAvatar.innerHTML = ''; } }catch(e){}
        document.getElementById('overviewIntro').textContent = `Welcome back, ${data.full_name || data.name || data.email || 'Admin'}.`;
        // keep existing overview content intact (do not overwrite dashboard)
      }catch(err){
        document.getElementById('overviewIntro').textContent = 'Unable to load profile ‚Äî please login.';
      }
    }

    const refreshProfileBtn = document.getElementById('refreshProfile');
    if (refreshProfileBtn) refreshProfileBtn.addEventListener('click', loadProfile);
    const refreshOverviewBtn = document.getElementById('refreshOverview');
    if (refreshOverviewBtn) refreshOverviewBtn.addEventListener('click', loadOverview);
    // Wire Overview quick actions
    try{
      const overviewCreateBtn = document.getElementById('overviewCreatePostBtn');
      if(overviewCreateBtn) overviewCreateBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('create-post'); try{ document.getElementById('postTitle') && document.getElementById('postTitle').focus(); }catch(e){} });
    }catch(e){}
    try{
      const overviewSendAlertBtn = document.getElementById('overviewSendAlertBtn');
      if(overviewSendAlertBtn) overviewSendAlertBtn.addEventListener('click', function(e){
        e.preventDefault();
        try{ switchTab('notifications'); }catch(e){}
        setTimeout(()=>{ try{ setActiveNotifTab && setActiveNotifTab('send'); renderNotificationsView && renderNotificationsView('send'); }catch(e){} },50);
        // after render, focus the title input for quick compose
        setTimeout(()=>{ try{ const t = document.getElementById('sendAlertTitle'); if(t){ t.focus(); t.scrollIntoView({behavior:'smooth', block:'center'}); } }catch(e){} },300);
      });
    }catch(e){}

    // Data loaders for new panels
    async function safeApi(path, opts){
      const fn = window.apiFetch ? window.apiFetch : (p,o)=>fetch(p, Object.assign({credentials:'include'}, o));
      const res = await fn(path, opts);
      if(!res.ok){
        if(res.status===401){
          // Do not redirect automatically; propagate null so callers can handle login UI without loops
          return null;
        }
        throw new Error('API error '+res.status)
      }
      return res.json();
    }

    async function loadRequests(){
      const out = document.getElementById('requestsList');
      out.textContent = 'Loading‚Ä¶';
      try{
        const data = await safeApi('/api/property-requests');
        if(!data) return;
        if(!Array.isArray(data)) data = data.items || [];
        out.innerHTML = data.length ? '<ul>'+data.map(r=>`<li><strong>${escapeHtml(r.name||r.email||'Request')}</strong> ‚Äî ${escapeHtml(r.message||r.comment||r.note||'')}</li>`).join('')+'</ul>' : 'No requests.';
      }catch(e){ out.textContent = 'Failed to load requests.' }
    }

    async function loadMessages(){
      const out = document.getElementById('messagesList');
      out.textContent = 'Loading‚Ä¶';
      try{
        const data = await safeApi('/api/contact-messages');
        if(!data) return;
        if(!Array.isArray(data)) data = data.items || [];
        out.innerHTML = data.length ? '<ul>'+data.map(m=>`<li><strong>${escapeHtml(m.email||m.from||'Sender')}</strong>: ${escapeHtml((m.message||m.body||'').slice(0,200))}</li>`).join('')+'</ul>' : 'No messages.';
      }catch(e){ out.textContent = 'Failed to load messages.' }
    }

    async function loadAlerts(){
      const out = document.getElementById('alertsList');
      out.textContent = 'Loading‚Ä¶';
      try{
        const data = await safeApi('/api/system-alerts');
        if(!data) return;
        if(!Array.isArray(data)) data = data.items || [];
        out.innerHTML = data.length ? '<ul>'+data.map(a=>`<li>${escapeHtml(a.title||a.message||'Alert')}</li>`).join('')+'</ul>' : 'No alerts.';
      }catch(e){ out.textContent = 'Failed to load alerts.' }
    }

    // Render notifications across multiple views: all, messages, alerts, activities, send
    async function renderNotificationsView(view){
      view = view || 'all';
      const out = document.getElementById('notificationsContent');
      if(!out) return;
      out.innerHTML = '<div style="padding:12px;color:#666">Loading‚Ä¶</div>';
      try{
        if(view === 'send'){
          out.innerHTML = `
            <div style="max-width:720px">
              <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px"><label style="color:#666;font-size:13px">Filter:</label><select id="notifViewSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px"><option value="all">All</option><option value="messages">Messages</option><option value="alerts">Alerts</option><option value="activities">Activities</option><option value="send">Send Alert</option></select></div>
              <h3>Send Alert / Notification</h3>
              <div style="margin:8px 0"><input id="sendAlertTitle" placeholder="Title" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px"/></div>
              <div style="margin:8px 0"><textarea id="sendAlertMessage" placeholder="Message" rows="6" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px"></textarea></div>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="sendAlertTarget" style="padding:8px;border:1px solid var(--border);border-radius:6px"><option value="all">All users</option><option value="admins">All admins</option><option value="custom">Custom (enter user IDs/emails)</option></select>
                <input id="sendAlertCustom" placeholder="comma-separated emails/ids" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;display:none" />
                <button id="sendAlertSubmit" class="tab-btn">Send</button>
              </div>
              <div id="sendAlertStatus" style="margin-top:8px;color:#666"></div>
              <div id="sendAlertHistory" style="margin-top:14px;color:#222"></div>
            </div>
          `;
          // wire controls
          document.getElementById('sendAlertTarget').addEventListener('change', function(){ document.getElementById('sendAlertCustom').style.display = this.value==='custom' ? 'block' : 'none'; });
          document.getElementById('sendAlertSubmit').addEventListener('click', async function(){
            const title = (document.getElementById('sendAlertTitle').value||'').trim();
            const message = (document.getElementById('sendAlertMessage').value||'').trim();
            const target = (document.getElementById('sendAlertTarget').value||'all');
            const custom = (document.getElementById('sendAlertCustom').value||'').trim();
            const status = document.getElementById('sendAlertStatus');
            if(!title || !message){ status.textContent = 'Title and message are required.'; return; }
            status.textContent = 'Sending‚Ä¶';
            try{
              const payload = { title, message, target, custom: custom || null };
              const poster = window.apiFetch ? window.apiFetch : (p,o)=>fetch(p,o);
              // Try common admin endpoint first, fall back to sent-notifications collection
              let res = null;
              try{ res = await poster('/api/admin/send-notification', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }catch(e){}
              if(!res || !res.ok){ try{ res = await poster('/api/admin/sent-notifications', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }catch(e){} }
              if(res && res.ok){ status.textContent = 'Sent.'; setTimeout(()=>renderNotificationsView('send'),600); return; }
              // fallback to localStorage if server not available
              try{ const key='sentNotifications'; const arr = JSON.parse(localStorage.getItem(key)||'[]'); arr.unshift(Object.assign({ id: 'local-'+Date.now(), title, message, sentAt: new Date().toISOString(), target }, {})); localStorage.setItem(key, JSON.stringify(arr)); status.textContent='Saved locally (offline)'; setTimeout(()=>renderNotificationsView('send'),600); return; }catch(e){ status.textContent='Send failed'; }
            }catch(e){ console.error(e); status.textContent='Send failed'; }
          });

          // Load sent notifications history (server + local fallback)
          (async function(){
            const histEl = document.getElementById('sendAlertHistory');
            histEl.innerHTML = '<div style="color:#666">Loading sent alerts‚Ä¶</div>';
            try{
              let data = null;
              try{ data = await safeApi('/api/admin/sent-notifications'); }catch(e){ data = null; }
              const norm = (d)=>{ if(!d) return []; if(Array.isArray(d)) return d; if(Array.isArray(d.notifications)) return d.notifications; if(Array.isArray(d.items)) return d.items; return [] };
              const rows = norm(data);
              // localStorage fallback
              let local = [];
              try{ local = JSON.parse(localStorage.getItem('sentNotifications')||'[]'); }catch(e){ local = []; }
              const merged = (rows || []).concat(local || []);
              // Filter to only items that look like sent alerts (title/body/category contains 'alert')
              const filtered = (merged || []).filter(n=>{
                try{
                  const txt = ((n.title||n.message||n.body||'') + ' ' + (n.category||n.type||n._type||'') + ' ' + (n.data && (n.data.type||n.data.category) || '')).toString().toLowerCase();
                  return txt.indexOf('alert') !== -1 || txt.indexOf('sent_alert') !== -1 || txt.indexOf('send alert') !== -1;
                }catch(e){ return false; }
              });
              if(!filtered.length){ histEl.innerHTML = '<div style="color:#666">No sent alerts.</div>'; return; }
              histEl.innerHTML = '<h4>Sent Alerts</h4><ul style="list-style:none;margin:0;padding:0">'+filtered.slice(0,50).map(n=>`<li style="padding:8px;border-bottom:1px solid #f2f6fb"><div style="font-weight:700">${escapeHtml(n.title||n.message||'Alert')}</div><div style="color:#666;margin-top:4px">${escapeHtml((n.message||n.body||'').slice(0,240))}</div><div style="font-size:12px;color:#999;margin-top:6px">${escapeHtml(n.sentAt||n.createdAt||n.time||'')}</div></li>`).join('')+'</ul>';
            }catch(e){ histEl.innerHTML = '<div style="color:#c33">Failed to load sent alerts.</div>'; }
          })();

          // wire the filter select inside the send view
          try{
            const sel = document.getElementById('notifViewSelect');
            if(sel){ sel.value = 'send'; sel.addEventListener('change', function(){ const v = this.value || 'all'; setActiveNotifTab(v); renderNotificationsView(v); }); }
          }catch(e){}

          return;
        }

        // helper to normalise arrays
        const norm = (d)=>{ if(!d) return []; if(Array.isArray(d)) return d; if(Array.isArray(d.items)) return d.items; if(Array.isArray(d.notifications)) return d.notifications; return [] };
        // load relevant sources
        const [notifications, sent, contacts, reqs, alerts, activities, propsData, convs] = await Promise.all([
          safeApi('/api/notifications').catch(()=>null),
          safeApi('/api/admin/sent-notifications').catch(()=>null),
          safeApi('/api/contact-messages').catch(()=>null),
          safeApi('/api/property-requests').catch(()=>null),
          safeApi('/api/system-alerts').catch(()=>null),
          safeApi('/api/activities').catch(()=>null),
          safeApi('/api/properties').catch(()=>null),
          safeApi('/api/conversations').catch(()=>null)
        ]);

        let items = [];
        // messages: combine contact messages + property requests + conversation notifications
        if(view==='all' || view==='messages'){
          const c = norm(contacts).map(m=>Object.assign({ _type:'message', title: m.subject||m.email||m.from||'Message', body: m.message||m.body||'', time: m.createdAt||m.sentAt||m.ts||m.time||m.date || m.created || (m.ts?new Date(m.ts).toISOString():null) }, m));
          const r = norm(reqs).map(m=>Object.assign({ _type:'request', title: m.name||m.email||'Request', body: m.message||m.note||'', time: m.createdAt||m.sentAt||m.ts||m.date }, m));
          const cv = norm(convs).map(cn=>Object.assign({ _type:'conversation', title: cn.participantName||cn.title||('Conversation '+(cn.id||'')), body: cn.last || cn.lastMessage || cn.preview || '', time: cn.updated || cn.lastUpdated || cn.updatedAt || cn.updated_at || cn.updatedAt || cn.updated }, cn));
          items.push(...c, ...r, ...cv);
        }
        if(view==='all' || view==='alerts'){
          const a = norm(alerts).map(x=>Object.assign({ _type:'alert', title: x.title||x.message||'Alert', body: x.message||'', time: x.sentAt||x.createdAt||x.time }, x));
          items.push(...a);
        }
        if(view==='all' || view==='activities'){
          const act = norm(activities).map(x=>Object.assign({ _type:'activity', title: x.title||x.action||'Activity', body: x.summary||'', time: x.ts||x.createdAt||x.time }, x));
          items.push(...act);

          // Include recent property posts as activities so admins see new listings in the Activities view
          try{
            const props = (propsData && (Array.isArray(propsData.properties) ? propsData.properties : (Array.isArray(propsData) ? propsData : []))) || [];
            const recent = (props||[]).slice(0,50).map(p=>({ _type: 'activity', title: 'New property: ' + (p.title || p.address || ('#'+(p.id||''))), body: p.description || p.address || '', time: p.created_at || p.createdAt || p.posted_at || p.postedAt || p.updated || p.updated_at || null, data: { propertyId: p.id, property: p } }));
            if(recent && recent.length) items.push(...recent);
          }catch(e){}

          // Also ensure property-like 'likes' show up: include any notifications that represent likes
          try{
            const likeNotifs = norm(notifications).filter(n=>{
              try{
                const cat = String((n.category||'')).toLowerCase();
                const t = n.data && (n.data.type||n.data.action) ? String(n.data.type||n.data.action).toLowerCase() : '';
                if(cat==='likes' || t==='like' || t==='liked') return true;
                const ttl = String(n.title||'').toLowerCase();
                if(ttl.indexOf('liked')!==-1 || ttl.indexOf('like')!==-1) return true;
              }catch(e){}
              return false;
            }).map(n=>Object.assign({ _type:'activity', title: n.title || 'Like', body: n.body || (n.data && n.data.summary) || '', time: n.created_at||n.createdAt||n.time, id: n.id, data: n.data }, n));
            if(likeNotifs && likeNotifs.length) items.push(...likeNotifs);
          }catch(e){}
        }
        // include DB-backed notifications (from /api/notifications)
        try{
          const dbNotifs = norm(notifications).map(n=>{
            const cat = (n.category || (n.data && n.data.category) || '').toString().toLowerCase();
            let t = 'notification';
            if(cat==='messages' || cat==='message') t = 'message';
            else if(cat==='alerts' || cat==='alert') t = 'alert';
            else if(cat==='activities' || cat==='activity') t = 'activity';
            else if(cat==='sent_alert' || cat==='sent') t = 'sent';
            // try to infer message/request/conversation
            if(n.data && n.data.type) t = n.data.type;
            return Object.assign({ _type: t, title: n.title|| (n.data && n.data.title) || '', body: n.body|| (n.data && n.data.body) || '', time: n.created_at||n.createdAt||n.time, id: n.id, is_read: n.is_read||n.read||false }, n);
          });
          if(dbNotifs && dbNotifs.length){
            if(view==='all') items.push(...dbNotifs);
            else if(view==='messages') items.push(...dbNotifs.filter(d=>['message','conversation','request'].indexOf(d._type)!==-1));
            else if(view==='alerts') items.push(...dbNotifs.filter(d=>d._type==='alert'));
            else if(view==='activities') items.push(...dbNotifs.filter(d=>d._type==='activity'));
          }
        }catch(e){ /* ignore DB notification parse errors */ }

        if(view==='all'){
          const s = norm(sent).map(x=>Object.assign({ _type:'sent', title: x.title||x.message||'Notification', body: x.message||x.body||'', time: x.sentAt||x.createdAt||x.time }, x));
          items.push(...s);
        }

        // If no items for this view, check localStorage fallbacks
        if(!items.length){
          const localKey = (view==='all' || view==='messages') ? 'chatNotifications' : ((view==='all' || view==='alerts') ? 'systemAlerts' : 'activities');
          try{ const fallback = JSON.parse(localStorage.getItem(localKey)||'[]'); if(Array.isArray(fallback) && fallback.length) fallback.forEach(x=>items.push(Object.assign({ _type: x._type || 'local', title: x.title||x.message||'', body: x.message||x.body||'', time: x.sentAt||x.createdAt||x.ts||Date.now() }, x))); }catch(e){}
        }

        if(!items.length){ out.innerHTML = '<div style="padding:12px;color:#666">No notifications.</div>'; return; }
        // deduplicate items by id or a content key to avoid repeats, then sort by time desc
        try{
          const seen = new Set();
          const uniq = [];
          items.forEach(it=>{
            const key = it && (it.id ? ('id:'+it.id) : ('type:'+ (it._type||'') + '|' + (it.title||'') + '|' + (it.time||'')));
            if(!key) return;
            if(!seen.has(key)) { seen.add(key); uniq.push(it); }
          });
          items = uniq;
        }catch(e){}
        items.sort((a,b)=>{ const ta = new Date(a.time||a.sentAt||a.createdAt||0).getTime()||0; const tb = new Date(b.time||b.sentAt||b.createdAt||0).getTime()||0; return tb-ta; });
        // add a small filter select at the top (helps mobile users switch views)
        const headerSelect = '<div style="margin-bottom:10px;display:flex;align-items:center;gap:8px;justify-content:space-between">'
               + '<div><label style="color:#666;font-size:13px">Filter:</label><select id="notifViewSelect" style="padding:8px;border:1px solid var(--border);border-radius:6px"><option value="all">All</option><option value="messages">Messages</option><option value="alerts">Alerts</option><option value="activities">Activities</option><option value="send">Send Alert</option></select></div>'
               + '<div style="display:flex;gap:8px;align-items:center"><button id="notifMarkAllBtn" class="tab-btn" style="white-space:nowrap">Mark All Read</button></div>'
               + '</div>';
        out.innerHTML = headerSelect + '<ul style="list-style:none;margin:0;padding:0">'+items.map(it=>{
          const dtype = escapeHtml(it._type||'');
          const rawId = (it.id||it._id||'');
          const did = escapeHtml(rawId||'');
          const isRead = (it.is_read===true || it.isRead===true || it.read===true) ? true : false;
          const numericId = String(rawId).match(/^\d+$/) ? String(rawId) : '';
          const markBtn = numericId ? `<button class="notif-mark-btn" data-id="${escapeHtml(numericId)}" style="margin-left:8px;padding:6px 8px;border-radius:6px;border:1px solid #e6eef7;background:#fff;cursor:pointer;font-size:12px">${isRead? 'Mark Unread':'Mark Read'}</button>` : '';
          const readClass = isRead ? 'notif-read' : '';
          const propId = (it.data && (it.data.propertyId || it.data.property_id)) || (it.property && it.property.id) || (it.meta && it.meta.property && it.meta.property.id) || null;
          const viewLink = propId ? `<a href="property-detail.html?id=${escapeHtml(propId)}" style="margin-left:8px;font-size:12px;color:#0e76a8">View property</a>` : '';
          return `<li class="${readClass}" style="padding:10px;border-bottom:1px solid #f6f9fc"><div style="display:flex;justify-content:space-between;align-items:flex-start"><a href="#" class="notif-link" data-type="${dtype}" data-id="${did}" style="text-decoration:none;color:inherit;display:block;flex:1"><div style="font-weight:700">${escapeHtml(it.title||it._type||'Notification')}</div><div style="color:#666;font-size:13px;margin-top:6px">${escapeHtml((it.body||'').slice(0,260))}</div><div style="font-size:12px;color:#999;margin-top:6px">${escapeHtml(it.time||it.sentAt||it.createdAt||'')}</div></a>${markBtn}${viewLink}</div></li>`;
        }).join('')+'</ul>';

        // cache items for detail view lookup by id
        try{
          window._notifItems = window._notifItems || {};
          items.forEach(it=>{ try{ if(it && (it.id||it._id)) window._notifItems[String(it.id||it._id)] = it; }catch(e){} });
        }catch(e){}
        // Wire "Mark All Read" button to mark visible notifications as read
        try{
          const markAllBtn = document.getElementById('notifMarkAllBtn');
          if(markAllBtn){
            markAllBtn.addEventListener('click', async function(){
              try{
                markAllBtn.disabled = true; markAllBtn.textContent = 'Marking...';
                const listRoot = document.getElementById('notificationsContent');
                if(!listRoot){ markAllBtn.disabled = false; markAllBtn.textContent = 'Mark All Read'; return; }
                const anchors = Array.from(listRoot.querySelectorAll('.notif-link'));
                const ids = anchors.map(a=>a.dataset.id).filter(Boolean);
                for(const id of ids){
                  try{
                    if(/^[0-9]+$/.test(String(id))){
                      await safeApi(`/api/admin/notifications/${encodeURIComponent(id)}/read`, { method: 'POST' }).catch(()=>null);
                    }
                    try{
                      const a = anchors.find(a=>String(a.dataset.id)===String(id));
                      const li = a ? a.closest('li') : null;
                      if(li) li.classList.add('notif-read');
                      const btn = li && li.querySelector('.notif-mark-btn'); if(btn) btn.textContent = 'Mark Unread';
                    }catch(e){}
                  }catch(e){ }
                }
                try{ const badge = document.getElementById('notifBadge'); if(badge){ badge.style.display='none'; badge.textContent='0'; } }catch(e){}
                markAllBtn.disabled = false; markAllBtn.textContent = 'Mark All Read';
              }catch(e){ markAllBtn.disabled = false; markAllBtn.textContent = 'Mark All Read'; }
            });
          }
        }catch(e){}

        // wire the filter select after rendering
        try{
          const sel = document.getElementById('notifViewSelect');
          if(sel){ sel.value = view || 'all'; sel.addEventListener('change', function(){ const v = this.value || 'all'; setActiveNotifTab(v); renderNotificationsView(v); }); }
        }catch(e){}
        // update header badge with unread count (try DB first, fallback to localStorage)
        (async function(){
          try{
            let unread = 0;
            try{
              const all = await safeApi('/api/notifications');
              const rows = (all && all.notifications) || all || [];
              if(Array.isArray(rows)) unread = rows.filter(r=>!(r.is_read===true || r.read===true || r.isRead===true)).length;
            }catch(e){
              try{ const local = JSON.parse(localStorage.getItem('notifications')||'[]'); unread = (local||[]).filter(r=>!r.is_read).length; }catch(e){}
            }
            const badge = document.getElementById('notifBadge');
            if(badge){ if(unread>0){ badge.style.display='inline-block'; badge.textContent = String(unread); } else { badge.style.display='none'; } }
          }catch(e){ /* ignore badge update failures */ }
        })();
      }catch(e){ console.error('renderNotificationsView failed', e); out.innerHTML = '<div style="padding:12px;color:#c33">Failed to load notifications.</div>'; }
    }

    // Wire notification controls
    document.addEventListener('DOMContentLoaded', function(){
      // header dropdown quick links
      document.querySelectorAll('.notifQuickLink').forEach(a=>a.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); const v = this.dataset.notifView || 'all'; notifDropdown.style.display='none'; switchTab('notifications'); setTimeout(()=>renderNotificationsView(v),50); }));

      // Wire header chat quick-search to chat list search input
      try{
        const hs = document.getElementById('chatHeaderSearch');
        if(hs){
          hs.addEventListener('input', function(e){ try{ const val = hs.value || ''; const si = document.getElementById('chatSearchInput'); if(si){ si.value = val; si.dispatchEvent(new Event('input')); } }catch(e){} });
        }
      }catch(e){}
      // notifOpenFull opens full notifications (all)
      const notifOpenFullEl = document.getElementById('notifOpenFull'); if(notifOpenFullEl) notifOpenFullEl.addEventListener('click', function(e){ e.preventDefault(); notifDropdown.style.display='none'; switchTab('notifications'); setTimeout(()=>renderNotificationsView('all'),50); });
      // notif-tab buttons removed; filter dropdown is used instead
      // set default active notif tab to All
      setActiveNotifTab('all');
      // clicks on notification items: open corresponding tab or chat
      const notifContent = document.getElementById('notificationsContent');
      if(notifContent){
        notifContent.addEventListener('click', function(ev){
          // Mark/unmark buttons
          const btn = ev.target.closest && ev.target.closest('.notif-mark-btn');
          if(btn){
            ev.preventDefault(); ev.stopPropagation();
            const nid = btn.dataset.id;
            if(!nid) return;
            // decide action based on current label
            const wantUnread = btn.textContent && btn.textContent.toLowerCase().indexOf('unread') !== -1;
            const endpoint = wantUnread ? `/api/admin/notifications/${nid}/unread` : `/api/admin/notifications/${nid}/read`;
            (async function(){
              try{
                const r = await safeApi(endpoint, { method: 'POST' });
                if(r && (r.notification || r.notifications || r.ok)){
                  // toggle button label
                  btn.textContent = wantUnread ? 'Mark Read' : 'Mark Unread';
                } else {
                  // try using fetch directly if safeApi failed
                  const rr = await fetch(endpoint, { method: 'POST', credentials: 'include' });
                  if(rr && rr.ok){ btn.textContent = wantUnread ? 'Mark Read' : 'Mark Unread'; }
                }
              }catch(e){ console.warn('Mark read/unread failed', e); }
            })();
            return;
          }

          const a = ev.target.closest && ev.target.closest('.notif-link');
          if(!a) return;
          ev.preventDefault(); ev.stopPropagation();
          const t = a.dataset.type || '';
          const id = a.dataset.id || '';

          // Try to show a detailed note/modal for this notification
          try{
            const cache = window._notifItems || {};
            const item = cache[String(id)] || null;
            if(item){
              openNotifDetail(item);
              return;
            }
          }catch(e){}

          // Fallback behaviour when detailed payload not available: try to mark read then navigate
          try{ if(id && /^\d+$/.test(id)) { safeApi(`/api/admin/notifications/${id}/read`, { method: 'POST' }).catch(()=>{}); } }catch(e){}

          if(t === 'conversation' || t === 'conversation' || t === 'conv'){
            switchTab('chat'); setTimeout(()=>{ if(id && typeof openAdminChat === 'function') openAdminChat(id); else renderAdminChatList(); },120);
            return;
          }
          if(t === 'message' || t === 'request'){
            if(t === 'request') switchTab('requests'); else switchTab('messages');
            return;
          }
          if(t === 'alert') { switchTab('alerts'); return; }
          if(t === 'activity') { switchTab('overview'); return; }
          // fallback: open notifications tab
          switchTab('notifications');
        });
      }
      // refresh button
      const refreshNot = document.getElementById('refreshNotifications'); if(refreshNot) refreshNot.addEventListener('click', ()=>renderNotificationsView('all'));
      // send alert main button removed (use filter/send view inside notifications)
    });

    // Properties
    let _propertiesCache = [];
    async function loadProperties(){
      const out = document.getElementById('propertiesList');
      out.textContent = 'Loading‚Ä¶';
      try{
        const data = await safeApi('/api/properties');
        if(!data) return;
        let rows = Array.isArray(data.properties) ? data.properties : (data || {}).properties || [];
        if(!Array.isArray(rows)) rows = [];
        _propertiesCache = rows;
        // show counts above list
        const header = document.getElementById('propertiesList');
        const total = rows.length;
        const sold = rows.filter(p => (p.post_to && String(p.post_to).toLowerCase()==='sold') || (p.status && String(p.status).toLowerCase()==='sold') || (p.sold===true)).length;
        const pending = Math.max(0, total - sold);
        header.innerHTML = `<div style="margin-bottom:8px"><strong>Total:</strong> ${total} ‚Äî <strong>Sold:</strong> ${sold} ‚Äî <strong>Pending:</strong> ${pending}</div>`;
        renderPropertiesList(rows);
      }catch(e){ out.textContent = 'Failed to load properties.' }
    }

    function renderPropertiesList(rows){
      const out = document.getElementById('propertiesList');
      const q = (document.getElementById('propSearch') && document.getElementById('propSearch').value || '').trim().toLowerCase();
      const type = (document.getElementById('propType') && document.getElementById('propType').value || '').trim().toLowerCase();
      const saleRent = (document.getElementById('propSaleRent') && document.getElementById('propSaleRent').value || '').trim().toLowerCase();
      let filtered = rows.filter(p => {
        if(q){ const hay = ((p.title||'')+' '+(p.address||'')+' '+(p.description||'')).toLowerCase(); if(hay.indexOf(q) === -1) return false; }
        if(type){ if(!p.type || String(p.type).toLowerCase().indexOf(type) === -1) return false; }
        if(saleRent){ if(!p.sale_rent || String(p.sale_rent).toLowerCase() !== saleRent) return false; }
        return true;
      });
      out.innerHTML = filtered.length ? '<ul>'+filtered.map(p=>`<li><strong>${escapeHtml(p.title||p.address||('Property #'+(p.id||'')))}</strong> ‚Äî id:${escapeHtml(p.id||'')}, images:${(p.images||[]).length || 0} <button data-id="${escapeHtml(p.id||'') }" class="delete-prop">Delete</button></li>`).join('')+'</ul>' : 'No properties.';
      // wire delete buttons
      out.querySelectorAll('.delete-prop').forEach(b=>b.addEventListener('click', async (e)=>{
        const id = b.dataset.id || e.target.getAttribute('data-id');
        if(!id) return alert('Missing id');
        if(!confirm('Delete property '+id+'?')) return;
        try{
          const res = window.apiFetch ? await window.apiFetch('/api/properties/'+encodeURIComponent(id), { method: 'DELETE' }) : await fetch('/api/properties/'+encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
          if(res && res.ok) { loadProperties(); } else { alert('Failed to delete property'); }
        }catch(err){ alert('Delete error'); }
      }));
    }

    // Users
    let _usersCache = [];
    async function loadUsers(){
      const out = document.getElementById('usersList');
      out.textContent = 'Loading‚Ä¶';
      try{
        const data = await safeApi('/api/users');
        if(!data) return;
        let rows = Array.isArray(data.users) ? data.users : (data && data.users) || [];
        if(!Array.isArray(rows)) rows = [];
        _usersCache = rows;
        // show total users above list
        const out = document.getElementById('usersList');
        out.innerHTML = `<div style="margin-bottom:8px"><strong>Total users:</strong> ${rows.length}</div>`;
        renderUsersList(rows);
      }catch(e){ out.textContent = 'Failed to load users.' }
    }

    function renderUsersList(rows){
      const out = document.getElementById('usersList');
      const q = (document.getElementById('userSearch') && document.getElementById('userSearch').value || '').trim().toLowerCase();
      const role = (document.getElementById('userRole') && document.getElementById('userRole').value || '').trim().toLowerCase();
      let filtered = rows.filter(u => {
        if(q){ const hay = ((u.full_name||'')+' '+(u.username||'')+' '+(u.email||'')).toLowerCase(); if(hay.indexOf(q) === -1) return false; }
        if(role){ if(!u.role || String(u.role).toLowerCase() !== role) return false; }
        return true;
      });
      if(!filtered || !filtered.length){ out.innerHTML = 'No users.'; return; }
      // Build a responsive horizontally-scrollable table
      const rowsHtml = filtered.map(u => {
        const id = escapeHtml(u.id || u.user_id || '');
        const name = escapeHtml(u.full_name || u.name || u.username || '');
        const email = escapeHtml(u.email || u.user_email || '');
        const location = escapeHtml(u.location || u.city || u.address || u.region || '');
        const phone = escapeHtml(u.phone || u.phone_number || u.mobile || u.phoneNumber || '');
        const created = escapeHtml(u.created_at || u.createdAt || u.created || '');
        return `<tr data-user-id="${id}"><td style="padding:8px">${id}</td><td style="padding:8px">${name}</td><td style="padding:8px">${email}</td><td style="padding:8px">${location}</td><td style="padding:8px">${phone}</td><td style="padding:8px">${created}</td><td style="padding:8px"><button class="user-view-btn tab-btn" data-id="${id}" style="margin-right:8px">View</button><button class="user-delete-btn tab-btn" data-id="${id}" style="background:#ff4d4f;color:#fff">Delete</button></td></tr>`;
      }).join('');
      out.innerHTML = `
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse;min-width:900px">
            <thead><tr style="text-align:left;border-bottom:1px solid #eef6fb"><th style="padding:8px">ID</th><th style="padding:8px">Name</th><th style="padding:8px">Email</th><th style="padding:8px">Location</th><th style="padding:8px">Phone</th><th style="padding:8px">Created At</th><th style="padding:8px">Actions</th></tr></thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
      `;

      // wire row action buttons
      try{
        const viewBtns = out.querySelectorAll('.user-view-btn');
        viewBtns.forEach(b=>b.addEventListener('click', (e)=>{
          const id = b.dataset.id; if(!id) return; const url = '/profile.html?id=' + encodeURIComponent(id); window.open(url, '_blank');
        }));
      }catch(e){}
      try{
        const delBtns = out.querySelectorAll('.user-delete-btn');
        delBtns.forEach(b=>b.addEventListener('click', async (e)=>{
          const id = b.dataset.id; if(!id) return; if(!confirm('Delete user '+id+'?')) return;
          try{
            const resp = await fetch('/api/users/'+encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
            if(resp && resp.ok){
              // remove row from table
              try{ const tr = b.closest('tr'); if(tr) tr.remove(); }catch(e){}
              return;
            }
            const text = await (resp && resp.text ? resp.text() : Promise.resolve(''));
            alert('Delete failed: ' + (resp && resp.status ? resp.status : '') + ' ' + text);
          }catch(err){ alert('Delete request failed'); }
        }));
      }catch(e){}
    }

    // Overview
    async function loadOverview(){
      const intro = document.getElementById('overviewIntro');
      const statsEl = document.getElementById('overviewStats');
      const recentsEl = document.getElementById('overviewRecents');
      intro.textContent = 'Loading admin overview‚Ä¶';
      statsEl.innerHTML = '';
      recentsEl.innerHTML = '';
      try{
        const [props, users, reqs, alerts, adminMsgs, sentNotifs] = await Promise.all([
          safeApi('/api/properties').catch(()=>null),
          safeApi('/api/users').catch(()=>null),
          safeApi('/api/property-requests').catch(()=>null),
          safeApi('/api/system-alerts').catch(()=>null),
          safeApi('/api/admin/messages').catch(()=>null),
          safeApi('/api/admin/sent-notifications').catch(()=>null)
        ]);

        const pCount = props && Array.isArray(props.properties) ? props.properties.length : 0;
        const uCount = users && Array.isArray(users.users) ? users.users.length : 0;
        const rCount = reqs && Array.isArray(reqs.requests) ? reqs.requests.length : 0;
        const aCount = alerts && Array.isArray(alerts.alerts) ? alerts.alerts.length : 0;
        const mCount = adminMsgs && Array.isArray(adminMsgs.messages) ? adminMsgs.messages.length : 0;
        const nCount = sentNotifs && Array.isArray(sentNotifs.notifications) ? sentNotifs.notifications.length : 0;

        function statCard(label, value){
          return `<div style="min-width:140px;padding:12px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)"><div style="font-size:1.25rem;font-weight:700">${escapeHtml(String(value))}</div><div style="font-size:0.85rem;color:#666;margin-top:6px">${escapeHtml(label)}</div></div>`;
        }

        statsEl.innerHTML = statCard('Properties', pCount)+statCard('Users', uCount)+statCard('Requests', rCount)+statCard('Alerts', aCount)+statCard('Admin messages', mCount)+statCard('Sent notifications', nCount);

        // Recents: show up to 3 recent properties and users
        const recentProps = props && Array.isArray(props.properties) ? props.properties.slice(0,3) : [];
        const recentUsers = users && Array.isArray(users.users) ? users.users.slice(0,3) : [];

        // Recent properties card
        let propsCard = '<div class="recent-props" style="min-width:320px"><h3>Recent Properties</h3>';
        if (recentProps.length) {
          propsCard += '<div style="overflow:auto;-webkit-overflow-scrolling:touch"><table style="width:100%;border-collapse:collapse;min-width:760px"><thead><tr style="text-align:left;border-bottom:1px solid #eef6fb"><th style="padding:6px">Title</th><th style="padding:6px">Price</th><th style="padding:6px">Location</th><th style="padding:6px">Created</th><th style="padding:6px">Images</th><th style="padding:6px">Videos</th></tr></thead><tbody>';
          propsCard += recentProps.map(p => {
            const title = escapeHtml(p.title || p.address || ('Property #'+(p.id||'')));
            const price = escapeHtml(p.price ? ('$' + Number(p.price).toLocaleString()) : (p.price_display || 'N/A'));
            const location = escapeHtml(p.location || p.address || '');
            const created = escapeHtml(p.created_at ? new Date(p.created_at).toLocaleDateString() : (p.createdAt ? new Date(p.createdAt).toLocaleDateString() : ''));
            const imagesCount = (Array.isArray(p.images) ? p.images.length : (p.photo_count || 0)) || 0;
            const videosCount = (Array.isArray(p.videos) ? p.videos.length : (p.video_count || 0)) || 0;
            return `<tr><td style="padding:6px">${title}</td><td style="padding:6px">${price}</td><td style="padding:6px">${location}</td><td style="padding:6px">${created}</td><td style="padding:6px;text-align:center">${imagesCount}</td><td style="padding:6px;text-align:center">${videosCount}</td></tr>`;
          }).join('');
          propsCard += '</tbody></table></div>';
          // Add a small action row with 'All' button to open the full Properties tab
          propsCard += '<div style="text-align:right;margin-top:8px"><button id="overviewPropsAllBtn" class="tab-btn">All</button></div>';
        } else {
          propsCard += '<div>No properties.</div>';
        }
        propsCard += '</div>';

        // Recent notifications card (separate)
        let notifsCard = '<div class="recent-notifs" style="min-width:320px"><h3>Recent Notifications</h3>';
        try {
          const recentNotifs = (sentNotifs && (Array.isArray(sentNotifs.notifications) ? sentNotifs.notifications : (Array.isArray(sentNotifs) ? sentNotifs : []))).slice(0,5);
          if (recentNotifs && recentNotifs.length) {
            notifsCard += '<div style="overflow:auto;-webkit-overflow-scrolling:touch"><table style="width:100%;border-collapse:collapse;min-width:680px"><thead><tr style="text-align:left;border-bottom:1px solid #eef6fb"><th style="padding:6px">Title</th><th style="padding:6px">Preview</th><th style="padding:6px">Time</th></tr></thead><tbody>';
            notifsCard += recentNotifs.map(n => {
              const title = escapeHtml(n.title || (n.message||'').slice(0,60) || 'Notification');
                // Prepare a safe preview for the notification body. If the body contains
                // simple HTML we allow it (after stripping script/style tags); otherwise
                // show escaped plain-text to avoid XSS and double-escaped output.
                const rawBody = (n.message || n.body || (n.data && (n.data.body||n.data.message)) || '');
                function sanitizePreviewHtml(str){
                  if(!str) return '';
                  try{
                    return String(str).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?>[\s\S]*?<\/style>/gi,'');
                  }catch(e){ return escapeHtml(String(str)); }
                }
                let body = String(rawBody).slice(0,140);
                if(/<\/?[a-z][\s\S]*>/i.test(body)){
                  body = sanitizePreviewHtml(body);
                } else {
                  body = escapeHtml(body);
                }
                const time = escapeHtml(n.sentAt || n.createdAt || n.time || n.ts || '');
                return `<tr><td style="padding:6px">${title}</td><td style="padding:6px">${body}</td><td style="padding:6px">${time}</td></tr>`;
            }).join('');
            notifsCard += '</tbody></table></div>';
          } else {
            notifsCard += '<div>No notifications.</div>';
          }
        } catch(e) { notifsCard += '<div>No notifications.</div>'; }
        notifsCard += '<div style="text-align:right;margin-top:8px"><button id="overviewNotifAllBtn" class="tab-btn">All</button></div>';
        notifsCard += '</div>';

        // Recent users card
        let usersCard = '<div class="recent-users" style="min-width:320px"><h3>Recent Users</h3>';
        if (recentUsers.length) {
          usersCard += '<div style="overflow:auto;-webkit-overflow-scrolling:touch"><table style="width:100%;border-collapse:collapse;min-width:520px"><thead><tr style="text-align:left;border-bottom:1px solid #eef6fb"><th style="padding:6px">Name</th><th style="padding:6px">Email</th><th style="padding:6px">Phone</th><th style="padding:6px">Location</th><th style="padding:6px">Created</th></tr></thead><tbody>';
          usersCard += recentUsers.map(u => {
            const name = escapeHtml(u.full_name || u.username || '');
            const email = escapeHtml(u.email || '');
            const phone = escapeHtml(u.phone || u.phone_number || u.mobile || '');
            const location = escapeHtml(u.location || u.city || u.address || '');
            const created = escapeHtml(u.created_at ? new Date(u.created_at).toLocaleDateString() : (u.createdAt ? new Date(u.createdAt).toLocaleDateString() : ''));
            return `<tr><td style="padding:6px">${name}</td><td style="padding:6px">${email}</td><td style="padding:6px">${phone}</td><td style="padding:6px">${location}</td><td style="padding:6px">${created}</td></tr>`;
          }).join('');
          usersCard += '</tbody></table></div>';
          usersCard += '<div style="text-align:right;margin-top:8px"><button id="overviewUsersAllBtn" class="tab-btn">All</button></div>';
        } else {
          usersCard += '<div>No users.</div>';
        }
        usersCard += '</div>';

        // Render three separate cards as siblings so each can scroll independently
        recentsEl.innerHTML = `<div class="overview-recents-flex">${propsCard}${notifsCard}${usersCard}</div>`;

        // Wire the 'All' buttons inside the Recent cards to open their respective tabs
        try{
          const notifAllBtn = document.getElementById('overviewNotifAllBtn');
          if(notifAllBtn){ notifAllBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('notifications'); setTimeout(()=>{ try{ renderNotificationsView('all'); }catch(_){ } }, 50); }); }
        }catch(e){}
        try{
          const propsAllBtn = document.getElementById('overviewPropsAllBtn');
          if(propsAllBtn){ propsAllBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('properties'); setTimeout(()=>{ try{ loadProperties(); }catch(_){ try{ renderPropertiesList(_propertiesCache); }catch(__){} } }, 50); }); }
        }catch(e){}
        try{
          const usersAllBtn = document.getElementById('overviewUsersAllBtn');
          if(usersAllBtn){ usersAllBtn.addEventListener('click', function(e){ e.preventDefault(); switchTab('users'); setTimeout(()=>{ try{ loadUsers(); }catch(_){ try{ renderUsersList(_usersCache); }catch(__){} } }, 50); }); }
        }catch(e){}

        intro.textContent = `Overview ‚Äî showing ${pCount} properties and ${uCount} users.`;
        // Company dashboard metrics
        try{
          const metricsEl = document.getElementById('companyMetrics');
          const breakdownEl = document.getElementById('companyBreakdown');
          metricsEl.innerHTML = '';
          breakdownEl.innerHTML = '';
          const propRows = props && Array.isArray(props.properties) ? props.properties : [];
          // if there's no data at all, show a friendly message
          if (!pCount && !uCount && !rCount && !aCount && !mCount && !nCount) {
            metricsEl.innerHTML = '<div style="padding:12px;color:#666">No company data yet.</div>';
            breakdownEl.innerHTML = '';
          } else {
            // avg price
            let avgPrice = 0;
            try{ const prices = propRows.map(p=>Number((p.price||0))); const valid = prices.filter(n=>!isNaN(n) && n>0); avgPrice = valid.length ? (valid.reduce((s,v)=>s+v,0)/valid.length) : 0; }catch(e){ avgPrice = 0 }
            function metricCard(label, value){ return `<div style="min-width:160px;padding:10px;border-radius:8px;background:#f8fafc"><div style="font-weight:700;font-size:1.15rem">${escapeHtml(String(value))}</div><div style="font-size:0.85rem;color:#555">${escapeHtml(label)}</div></div>` }
              // sold / pending
              const soldCount = propRows.filter(p => (p.post_to && String(p.post_to).toLowerCase()==='sold') || (p.status && String(p.status).toLowerCase()==='sold') || (p.sold===true)).length;
              const pendingCount = Math.max(0, pCount - soldCount);
              metricsEl.innerHTML = metricCard('Total Properties', pCount) + metricCard('Posted', pCount) + metricCard('Sold', soldCount) + metricCard('Pending', pendingCount) + metricCard('Total Users', uCount) + metricCard('Open Requests', rCount) + metricCard('Avg Price', avgPrice ? ('$'+Number(avgPrice).toFixed(2)) : 'N/A');
            // breakdown by property type
            const typeMap = {};
            for(const p of propRows){ const t = (p.type||'unknown'); typeMap[t] = (typeMap[t]||0)+1 }
            const typeHtml = `<div style="min-width:220px"><h4>Properties by Type</h4><ul>` + Object.keys(typeMap).map(k=>`<li>${escapeHtml(k)}: ${typeMap[k]}</li>`).join('') + `</ul></div>`;
            // recent signups
            const recentUsers = users && Array.isArray(users.users) ? users.users.slice(0,5) : [];
            const signupsHtml = `<div style="min-width:260px"><h4>Recent Signups</h4>` + (recentUsers.length?'<ul>'+recentUsers.map(u=>`<li>${escapeHtml(u.email||u.username||'user')} ‚Äî ${new Date(u.created_at).toLocaleDateString()}</li>`).join('')+'</ul>':'<div>No recent signups</div>') + `</div>`;
            breakdownEl.innerHTML = typeHtml + signupsHtml;
          }
        }catch(e){ /* ignore dashboard render errors */ }
      }catch(e){
        intro.textContent = 'Failed to load overview.';
      }
    }

    // Small helper to avoid XSS in rendered strings
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    document.getElementById('refreshRequests').addEventListener('click', loadRequests);
    document.getElementById('refreshMessages').addEventListener('click', loadMessages);
    document.getElementById('refreshAlerts').addEventListener('click', loadAlerts);
    document.getElementById('refreshNotifications').addEventListener('click', function(){ renderNotificationsView('all'); });
    document.getElementById('refreshProperties').addEventListener('click', loadProperties);
    document.getElementById('refreshUsers').addEventListener('click', loadUsers);
    // wire filters
    const propSearchEl = document.getElementById('propSearch');
    const propTypeEl = document.getElementById('propType');
    const propSaleRentEl = document.getElementById('propSaleRent');
    if(propSearchEl) propSearchEl.addEventListener('input', ()=>renderPropertiesList(_propertiesCache));
    if(propTypeEl) propTypeEl.addEventListener('input', ()=>renderPropertiesList(_propertiesCache));
    if(propSaleRentEl) propSaleRentEl.addEventListener('change', ()=>renderPropertiesList(_propertiesCache));
    const userSearchEl = document.getElementById('userSearch');
    const userRoleEl = document.getElementById('userRole');
    if(userSearchEl) userSearchEl.addEventListener('input', ()=>renderUsersList(_usersCache));
    if(userRoleEl) userRoleEl.addEventListener('change', ()=>renderUsersList(_usersCache));

    // Create post handler
    // helper to read files as data URLs (with optional compression for images)
    function readFilesAsDataURLs(fileList){
      return Promise.all(Array.from(fileList || []).map(f=>{
        if(window.fileToDataUrlWithCompression) return window.fileToDataUrlWithCompression(f);
        return new Promise((resolve,reject)=>{
          const r = new FileReader(); r.onload = ()=>resolve(r.result); r.onerror = ()=>reject(new Error('File read error')); r.readAsDataURL(f);
        });
      }));
    }

    // render previews for selected files
    const postFilesEl = document.getElementById('postImagesFiles');
    const postPreview = document.getElementById('postImagesPreview');
    if(postFilesEl){
      postFilesEl.addEventListener('change', (ev)=>{
        // clear existing previews
        try{ postPreview.innerHTML = ''; }catch(e){}
        const files = ev.target.files || [];
        Array.from(files).forEach(f=>{
          try{
            let mediaEl;
            let url = null;
            try{ url = URL.createObjectURL(f); }catch(e){ url = null; }
            if(f.type && f.type.indexOf('video/') === 0){
              mediaEl = document.createElement('video');
              if(url) { mediaEl.src = url; mediaEl.controls = true; mediaEl.muted = true; }
              mediaEl.style.width='140px'; mediaEl.style.height='80px'; mediaEl.style.objectFit='cover'; mediaEl.title = f.name;
            } else {
              mediaEl = document.createElement('img');
              if(url) mediaEl.src = url;
              mediaEl.style.width='120px'; mediaEl.style.height='80px'; mediaEl.style.objectFit='cover'; mediaEl.title = f.name;
            }
            // If URL.createObjectURL isn't available (some mobile browsers), fall back to FileReader
            if(!url){
              try{
                const reader = new FileReader();
                reader.onload = function(ev){ try{ if(mediaEl.tagName === 'IMG') mediaEl.src = ev.target.result; else mediaEl.src = ev.target.result; }catch(e){} };
                reader.readAsDataURL(f);
              }catch(e){}
            }
            mediaEl.style.borderRadius = '6px';
            const wrapper = document.createElement('div'); wrapper.style.position='relative'; wrapper.appendChild(mediaEl);
            const btn = document.createElement('button'); btn.textContent='‚úï'; btn.title='Remove'; btn.style.position='absolute'; btn.style.top='4px'; btn.style.right='4px'; btn.style.background='rgba(0,0,0,0.5)'; btn.style.color='#fff'; btn.style.border='0'; btn.style.borderRadius='50%'; btn.style.width='22px'; btn.style.height='22px'; btn.style.cursor='pointer';
            btn.addEventListener('click', ()=>{
              // remove file from input by rebuilding FileList via DataTransfer
              const dt = new DataTransfer(); Array.from(postFilesEl.files).forEach(existing => { if(existing !== f) dt.items.add(existing); }); postFilesEl.files = dt.files; wrapper.remove(); try{ if(url) URL.revokeObjectURL(url); }catch(e){}
            });
            wrapper.appendChild(btn);
            postPreview.appendChild(wrapper);
          }catch(e){ }
        });
      });
    }

    document.getElementById('createPostBtn').addEventListener('click', async function(e){
      e.preventDefault();
      const btn = this; btn.disabled = true;
      const status = document.getElementById('createPostStatus'); status.textContent = 'Creating post‚Ä¶';
      const title = (document.getElementById('postTitle').value || '').trim();
      if(!title){ status.textContent = 'Title is required'; btn.disabled = false; return; }
      const price = (document.getElementById('postPrice').value || '').trim();
      const address = (document.getElementById('postAddress').value || '').trim();
      const type = (document.getElementById('postType').value || '').trim();
      const saleRent = (document.getElementById('postFor').value || '').trim();
      const beds = parseInt(document.getElementById('postBeds').value || '0') || 0;
      const baths = parseInt(document.getElementById('postBaths').value || '0') || 0;
      const area = parseFloat(document.getElementById('postArea').value || '0') || 0;
      const description = (document.getElementById('postDescription').value || '').trim();
      const selectedFiles = (postFilesEl && postFilesEl.files && postFilesEl.files.length) ? Array.from(postFilesEl.files) : [];
      const postTo = (document.getElementById('postTo') && document.getElementById('postTo').value) ? document.getElementById('postTo').value : 'available';
      const notify = !!document.getElementById('postNotify').checked;

      const newProp = {
        title: title,
        address: address,
        price: price,
        type: type,
        sale_rent: saleRent,
        saleRent: saleRent,
        bedrooms: beds,
        bathrooms: baths,
        area: area,
        description: description,
        images: [],
        photoUrls: [],
        post_to: postTo
      };

      try{
        // If admin selected files, try to upload them first
        if(selectedFiles.length){
          try{
            const fd = new FormData(); selectedFiles.forEach(f=>fd.append('files', f));
            const poster = (typeof window !== 'undefined' && window.apiFetch) ? window.apiFetch : fetch;
            const upResp = await poster('/api/upload-photos', { method: 'POST', body: fd });
            if(upResp && upResp.ok){
              const upJson = await upResp.json();
              const urls = Array.isArray(upJson.urls) ? upJson.urls : (upJson && upJson.uploaded) ? upJson.uploaded : [];
              if(urls && urls.length){ newProp.images = urls; newProp.photoUrls = urls; }
            } else {
              // upload failed ‚Äî fallback to storing data-URLs locally
              const dataUrls = await readFilesAsDataURLs(selectedFiles);
              newProp.photoUrls = (newProp.photoUrls||[]).concat(dataUrls);
            }
          }catch(e){
            // fallback: read as data URLs and let saveProperty store them locally
            try{ const dataUrls = await readFilesAsDataURLs(selectedFiles); newProp.photoUrls = (newProp.photoUrls||[]).concat(dataUrls); }catch(e){}
          }
        }
        // saveProperty returns a Promise
        const savedProp = await saveProperty(newProp);
        status.textContent = 'Post created.';
        // Immediately show the created property in this admin session using the returned object
        try{
          const created = savedProp && (savedProp.property || savedProp) ? (savedProp.property || savedProp) : null;
          if(created && created.id){
            try{ _propertiesCache = _propertiesCache || []; _propertiesCache.unshift(created); renderPropertiesList(_propertiesCache); }catch(e){}
          } else {
            // fallback: refresh list from server
            try{ await loadProperties(); }catch(e){}
          }
        }catch(e){ try{ await loadProperties(); }catch(e){} }
        // optionally notify users via admin API
        if(notify){
            try{
              const titleNotif = 'New property: ' + title;
              const bodyNotif = (description && description.slice(0,240)) || ('Check out our new property: '+ title);
              const notifRes = await safeApi('/api/admin/sent-notifications', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: titleNotif, body: bodyNotif, data: { url: window.location.origin + '/src/property-detail.html?id='+ (newProp.id||''), property: newProp } }) });
              if(!notifRes){
                // API returned null (likely 401) ‚Äî queue for retry
                throw new Error('Admin notification not sent (unauthorized or failed)');
              }
              status.textContent = 'Post created and users notified.';
            }catch(e){
              console.error('Notification send failed, queuing for retry', e);
              try{
                const pendingKey = 'pendingNotifications';
                const item = { title: 'New property: ' + title, body: (description && description.slice(0,240)) || ('Check out our new property: '+ title), data: { url: window.location.origin + '/src/property-detail.html?id='+ (newProp.id||''), property: newProp }, createdAt: Date.now(), attempts: 0 };
                let pending = [];
                try{ pending = JSON.parse(localStorage.getItem(pendingKey) || '[]'); }catch(err){ pending = []; }
                pending.push(item);
                try{ localStorage.setItem(pendingKey, JSON.stringify(pending)); }catch(err){}
                status.textContent = 'Post created; notification queued and will retry when online.';
              }catch(err2){ console.error('Failed to queue notification', err2); status.textContent = 'Post created but failed to notify users.'; }
            }
        }
      }catch(err){
        console.error(err);
        try{ status.textContent = 'Failed to create post: ' + (err && err.message ? err.message : String(err)); }catch(e){ status.textContent = 'Failed to create post.' }
      }
      btn.disabled = false;
    });

    document.getElementById('createPostClear').addEventListener('click', function(e){ e.preventDefault(); ['postTitle','postPrice','postAddress','postType','postBeds','postBaths','postArea','postDescription'].forEach(id=>{ try{ document.getElementById(id).value=''; }catch(e){} }); try{ document.getElementById('postTo').value = 'available'; }catch(e){}; try{ postFilesEl.value = ''; postPreview.innerHTML = ''; }catch(e){}; document.getElementById('postNotify').checked = false; document.getElementById('createPostStatus').textContent=''; });

    // Init tab from hash or default and load data
    (function(){
      const raw = (location.hash && location.hash.slice(1)) || 'overview';
      const parts = String(raw).split('?');
      const hashPath = parts[0] || 'overview';
      const hashQuery = parts[1] || '';
      // Support legacy #conversation links by mapping them to the chat tab
      if (hashPath === 'conversation') {
        const params = new URLSearchParams(hashQuery);
        const convId = params.get('id') || params.get('conv') || null;
        switchTab('chat');
        // Load data then open the requested conversation (small delay ensures DOM panels are ready)
        loadProfile();
        loadOverview();
        loadRequests();
        loadMessages();
        loadAlerts();
        renderNotificationsView('all');
        loadProperties();
        loadUsers();
        // Open conversation when hash changes (supports admin.html#conversation?id=... links)
        window.addEventListener('hashchange', function(){
          try{
            const raw = (location.hash && location.hash.slice(1)) || '';
            const parts = String(raw).split('?');
            const path = parts[0] || '';
            const qs = parts[1] || '';
            if (path === 'conversation'){
              const params = new URLSearchParams(qs);
              const convId = params.get('id') || params.get('conv') || null;
              console.log('hashchange detected, conversation id=', convId);
              if (convId && typeof openAdminChat === 'function') openAdminChat(convId);
            }
          }catch(e){ console.error('hashchange handler error', e); }
        });
        setTimeout(() => {
          if (convId && typeof openAdminChat === 'function') openAdminChat(convId);
          else if (typeof renderAdminChatList === 'function') renderAdminChatList();
        }, 120);
        return;
      }
      // Default flow for other hashes
      switchTab(hashPath || 'overview');
      loadProfile();
      loadOverview();
      loadRequests();
      loadMessages();
      loadAlerts();
      renderNotificationsView('all');
      loadProperties();
      loadUsers();
    })();
  </script>
  <!-- Wispa admin debug panel: floating controls to test admin auth and retry queued notifications -->
  <div id="wispa-admin-debug" style="display:none;position:fixed;right:12px;bottom:12px;z-index:99999;background:rgba(255,255,255,0.95);border:1px solid #e6eef6;padding:8px;border-radius:8px;box-shadow:0 10px 30px rgba(8,24,50,0.08);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0">
    <div style="font-size:12px;color:#333;margin-bottom:6px;font-weight:600">Debug</div>
    <div style="display:flex;gap:6px;">
        <button id="wispa-debug-auth" type="button" style="padding:6px 8px;background:#fff;border:1px solid #dfeaf7;border-radius:6px;cursor:pointer">Test Admin Auth</button>
        <button id="wispa-retry-notifs" type="button" style="padding:6px 8px;background:#fff;border:1px solid #dfeaf7;border-radius:6px;cursor:pointer">Retry Notifications</button>
    </div>
  </div>
  <script>
    (function(){
        const qa = id => document.getElementById(id);
        qa('wispa-debug-auth').addEventListener('click', async function(){
            try{
                console.log('Calling debugAdminAuth...');
                if(window.debugAdminAuth) {
                    const r = await window.debugAdminAuth();
                    console.log('debugAdminAuth result', r);
                    alert('debugAdminAuth status: ' + (r && r.status ? r.status : JSON.stringify(r)));
                } else alert('debugAdminAuth not available');
            }catch(e){ console.error(e); alert('debugAdminAuth error: '+e); }
        });
        qa('wispa-retry-notifs').addEventListener('click', async function(){
            try{
                console.log('Calling retryPendingNotifications...');
                if(window.retryPendingNotifications){
                    await window.retryPendingNotifications();
                    alert('retryPendingNotifications executed ‚Äî check Network/Console.');
                } else alert('retryPendingNotifications not available');
            }catch(e){ console.error(e); alert('retryPendingNotifications error: '+e); }
        });
    })();
  </script>
  <script>
    // Notification detail modal helpers
    function openNotifDetail(item){
      try{
        const modal = document.getElementById('notifDetailModal');
        if(!modal) return;
        const titleEl = document.getElementById('notifDetailTitle');
        const timeEl = document.getElementById('notifDetailTime');
        const bodyEl = document.getElementById('notifDetailBody');
        const primaryBtn = document.getElementById('notifDetailPrimary');
        const markBtn = document.getElementById('notifDetailMark');
        const closeBtn = document.getElementById('notifDetailClose');

        const title = item.title || (item.data && item.data.title) || item.message || 'Notification';
        const body = item.body || (item.data && (item.data.body || item.data.message)) || item.message || '';
        const time = item.time || item.sentAt || item.createdAt || item.created || item.ts || null;

        titleEl.textContent = title;
        bodyEl.textContent = body;
        try{ timeEl.textContent = time ? new Date(time).toLocaleString() : ''; }catch(e){ timeEl.textContent = String(time||''); }

        modal.dataset.currentId = item.id || item._id || '';
        modal.dataset.currentType = item._type || (item.data && item.data.type) || '';

        // Primary action
        primaryBtn.onclick = function(ev){ ev.preventDefault(); try{
          // prefer explicit URL in data
          const url = (item.data && (item.data.url || item.data.link)) || item.url || item.link || null;
          const propId = (item.data && (item.data.propertyId || item.data.property_id)) || (item.property && item.property.id) || null;
          const t = (item._type || '').toLowerCase();
          if(url){ window.location.href = url; return; }
          if(propId){ window.location.href = 'property-detail.html?id=' + encodeURIComponent(propId); return; }
          if(t === 'conversation' || t === 'conv'){
            closeNotifDetail(); switchTab('chat'); setTimeout(()=>{ if(typeof openAdminChat === 'function') openAdminChat(item.id || item.convId || item.conversation_id); },120); return;
          }
          if(t === 'message' || t === 'request'){ closeNotifDetail(); if(t==='request') switchTab('requests'); else switchTab('messages'); return; }
          // default: close modal and open notifications
          closeNotifDetail(); switchTab('notifications');
        }catch(e){ console.warn(e); } };

        // Mark button wiring
        const isRead = !!(item.is_read===true || item.read===true || item.isRead===true);
        markBtn.textContent = isRead ? 'Mark Unread' : 'Mark Read';
        markBtn.onclick = async function(ev){ ev.preventDefault(); try{
          const id = modal.dataset.currentId;
          if(!id || !/^\d+$/.test(String(id))) return;
          const endpoint = isRead ? `/api/admin/notifications/${id}/unread` : `/api/admin/notifications/${id}/read`;
          try{ await safeApi(endpoint, { method: 'POST' }); }catch(e){ try{ await fetch(endpoint, { method:'POST', credentials:'include' }); }catch(e){} }
          // refresh view to reflect change
          try{ const current = document.getElementById('notifViewSelect') && document.getElementById('notifViewSelect').value ? document.getElementById('notifViewSelect').value : 'all'; renderNotificationsView(current); }catch(e){}
          // update cached item
          try{ if(window._notifItems && window._notifItems[String(id)]){ window._notifItems[String(id)].is_read = !isRead; } }catch(e){}
          closeNotifDetail();
        }catch(e){ console.warn('mark action failed', e); } };

        closeBtn.onclick = function(){ closeNotifDetail(); };

        // show modal
        modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
        // handle escape key to close
        function escHandler(ev){ if(ev.key === 'Escape'){ closeNotifDetail(); window.removeEventListener('keydown', escHandler); } }
        window.addEventListener('keydown', escHandler);
      }catch(e){ console.warn('openNotifDetail failed', e); }
    }

    function closeNotifDetail(){ try{ const modal = document.getElementById('notifDetailModal'); if(!modal) return; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); modal.dataset.currentId=''; modal.dataset.currentType=''; }catch(e){} }
  </script>
  <script>
    (function(){
      const selectors = '.overview-recents-flex .recent-props > div, .overview-recents-flex .recent-users > div, .overview-recents-flex .recent-notifs > div';
      function setup(){
        const els = document.querySelectorAll(selectors);
        if(!els || !els.length) return false;
        els.forEach(el => {
          const parent = el.parentElement;
          function update(){
            try{
              const canRight = el.scrollWidth > el.clientWidth + 1 && (el.scrollLeft + el.clientWidth) < el.scrollWidth - 1;
              const canLeft = el.scrollLeft > 1;
              if(parent){
                parent.classList.toggle('can-scroll-right', !!canRight);
                parent.classList.toggle('can-scroll-left', !!canLeft);
              }
            }catch(e){}
          }
          el.addEventListener('scroll', update, { passive: true });
          el.addEventListener('keydown', function(e){ if(e.key === 'ArrowRight') el.scrollBy({ left: 200, behavior: 'smooth' }); if(e.key === 'ArrowLeft') el.scrollBy({ left: -200, behavior: 'smooth' }); });
          // initial check
          setTimeout(update, 60);
          window.addEventListener('resize', update);
        });
        return true;
      }
      function trySetup(attempts){ if(setup()) return; if((attempts||0) < 8) setTimeout(()=>trySetup((attempts||0)+1), 250); }
      document.addEventListener('DOMContentLoaded', ()=>trySetup(0));
    })();
  </script>
    <script>
      // Wire inline settings & privacy form save handlers
      (function(){
        const postJson = (path, body)=>{
          if(typeof window.apiFetch === 'function') return window.apiFetch(path, { method: 'POST', body: JSON.stringify(body), headers:{'content-type':'application/json'} });
          return fetch(path, { method: 'POST', body: JSON.stringify(body), headers:{'content-type':'application/json'} }).catch(()=>null);
        };

        const el = id => document.getElementById(id);
        const setup = ()=>{
          const saveApp = el('saveAppSettingsInline'); if(saveApp) saveApp.addEventListener('click', async (e)=>{ e.preventDefault(); const body = { siteTitle: el('siteTitleInline').value, defaultLang: el('defaultLangInline').value, maintenanceMode: !!el('maintenanceModeInline').checked, allowRegistration: !!el('allowRegistrationInline').checked }; const r = await postJson('/api/admin/settings', body); if(r && r.ok) alert('App settings saved'); else alert('Save failed'); });
          const saveAdminDef = el('saveAdminDefaultsInline'); if(saveAdminDef) saveAdminDef.addEventListener('click', async (e)=>{ e.preventDefault(); const body = { itemsPerPage: Number(el('adminItemsPerPageInline').value)||20, emailAlerts: !!el('adminEmailAlertsInline').checked }; const r = await postJson('/api/admin/settings/admin-defaults', body); if(r && r.ok) alert('Admin defaults saved'); else alert('Save failed'); });
          const savePriv = el('savePrivacyInline'); if(savePriv) savePriv.addEventListener('click', async (e)=>{ e.preventDefault(); const body = { publicProfile: !!el('publicProfileInline').checked, showContactInfo: !!el('showContactInfoInline').checked, showPhoneButton: !!el('showPhoneButtonInline').checked, dataSharing: !!el('dataSharingInline').checked, analytics: !!el('analyticsInline').checked }; const r = await postJson('/api/admin/privacy', body); if(r && r.ok) alert('Privacy saved'); else alert('Save failed'); });
          const saveAdminPriv = el('saveAdminPrivacyInline'); if(saveAdminPriv) saveAdminPriv.addEventListener('click', async (e)=>{ e.preventDefault(); const body = { adminSeeUserContacts: !!el('adminSeeUserContactsInline').checked, adminExportData: !!el('adminExportDataInline').checked }; const r = await postJson('/api/admin/privacy/admin', body); if(r && r.ok) alert('Admin privacy saved'); else alert('Save failed'); });
        };
        try{ setup(); }catch(e){ console.warn('Inline settings init failed', e); }
      })();
    </script>
</body>
</html>
