<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Wispa Real Estate</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        * { box-sizing:border-box; }
        html, body { margin:0; padding:0; }
        
        .admin-layout { display:flex; background:transparent; max-width:1400px; margin:0 auto; }
        .admin-sidebar { display:none; }
        .admin-main { flex:1; margin-left:0; padding:24px 30px; }
        .admin-menu { list-style:none; padding:0; margin:0; }
        .header-nav { display:none; }
        .header-container { justify-content:flex-start; gap:0; }
        .header-left { flex:1; }
        .header-right { display:flex; gap:10px; }
        .btn-primary, .btn-sm { max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        
        .admin-menu a { display:flex; align-items:center; gap:12px; padding:12px 15px; font-size:15px; color:var(--text); text-decoration:none; border-radius:6px; }
        .admin-menu a.active { background:var(--primary-light); color:var(--primary); font-weight:600; }
        .dashboard-header { margin-bottom:30px; text-align:center; padding:0 20px; }
        .dashboard-header h1 { font-size:40px; margin:0 0 10px 0; color:var(--text); }
        .dashboard-header p { color:var(--text-light); margin:0; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin:0 auto 30px; max-width:1000px; }
        .stat-card { background:var(--white); padding:24px; border-radius:8px; box-shadow:var(--shadow); border-left:4px solid var(--primary); }
        .stat-card.secondary { border-left-color:#3498db; }
        .stat-card.success { border-left-color:#2ecc71; }
        .stat-card.warning { border-left-color:#f39c12; }
        .stat-label { font-size:15px; color:var(--text-light); text-transform:uppercase; font-weight:600; margin-bottom:8px; }
        .stat-value { font-size:40px; font-weight:700; color:var(--text); margin-bottom:8px; }
        .stat-change { font-size:14px; color:#2ecc71; }
        .stat-change.negative { color:#e74c3c; }
        .admin-section { background:var(--white); border-radius:8px; box-shadow:var(--shadow); padding:24px; margin-bottom:30px; }
        .admin-section h2 { font-size:28px; margin:0 0 20px 0; color:var(--text); border-bottom:2px solid var(--lighter); padding-bottom:15px; }
        .table-wrapper { overflow-x:auto; }
        .admin-table { width:100%; border-collapse:collapse; font-size:16px; }
        .admin-table thead { background:var(--lighter); border-bottom:2px solid var(--border); }
        .admin-table th { padding:15px; text-align:left; font-weight:600; color:var(--text); }
        .admin-table td { padding:15px; border-bottom:1px solid var(--border); color:var(--text); }
        .admin-table tr:hover { background:var(--lighter); }
        .badge { display:inline-block; padding:6px 14px; border-radius:20px; font-size:14px; font-weight:600; }
        .badge.active { background:#d4edda; color:#155724; }
        .badge.pending { background:#fff3cd; color:#856404; }
        .badge.sold { background:#f8d7da; color:#721c24; }
        .action-buttons { display:flex; gap:8px; }
        .btn-sm { padding:8px 14px; font-size:14px; border-radius:4px; border:none; cursor:pointer; }
        .btn-sm.edit { background:#3498db; color:white; }
        .btn-sm.delete { background:#e74c3c; color:white; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:10px; font-size:16px; font-weight:600; color:var(--text); }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px; font-size:16px; border:1px solid var(--border); border-radius:4px; background:var(--white); color:var(--text); }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; }
        .btn-primary { background:var(--primary); color:white; padding:14px 28px; border:none; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:var(--white); padding:30px; border-radius:8px; max-width:700px; width:90%; box-shadow:var(--shadow); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .modal-close { font-size:24px; background:none; border:none; cursor:pointer; color:var(--text-light); }
        .quick-actions { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px; margin:0 auto 30px; max-width:600px; }
        .action-icon { font-size:48px; margin-bottom:10px; }
        .action-name { font-size:15px; font-weight:600; color:var(--text); }
        .action-card { background:var(--white); padding:24px; border-radius:8px; text-align:center; box-shadow:var(--shadow); cursor:pointer; font-size:16px; }
        
        /* Admin Notification Tabs */
        .admin-notif-tab { padding:12px 20px; border:none; background:transparent; cursor:pointer; font-size:14px; font-weight:600; color:var(--text-light); border-bottom:3px solid transparent; transition:all 0.2s; white-space:nowrap; }
        .admin-notif-tab:hover { color:var(--text); }
        .admin-notif-tab.active { color:var(--primary); border-bottom-color:var(--primary); }
        .notif-tab-content { animation:fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        
        /* Alert Badges */
        .badge.info { background:#d1ecf1; color:#0c5460; }
        .badge.success { background:#d4edda; color:#155724; }
        .badge.warning { background:#fff3cd; color:#856404; }
        .badge.error { background:#f8d7da; color:#721c24; }
        
        @media (max-width:768px){
            body { overflow-x:hidden; width:100vw; }
            .admin-layout{ flex-direction:column; width:100%; overflow-x:hidden; }
            .admin-sidebar{
                width:100%;
                position:relative;
                height:auto;
                border-bottom:1px solid var(--border);
                display:block;
                overflow-x:auto;
                white-space:nowrap;
                padding:8px;
            }
            .admin-sidebar h3 { margin:4px 0 4px 0; font-size:12px; padding:0 8px; }
            .admin-sidebar .admin-menu { display:flex; gap:4px; padding:0; margin:0; }
            .admin-sidebar .admin-menu li { display:inline-block; }
            .admin-sidebar .admin-menu a { padding:6px 8px; font-size:12px; gap:4px; margin:0; }
            .admin-main{ margin-left:0; padding:10px; width:100%; box-sizing:border-box; overflow:hidden; }
            .dashboard-header { margin-bottom:14px; text-align:center; padding:0 8px; }
            .dashboard-header h1 { font-size:28px; margin:0 0 6px 0; }
            .dashboard-header p { font-size:12px; margin:0; }
            .stats-grid { grid-template-columns:repeat(2,1fr); gap:10px; margin:0 auto 14px; max-width:none; }
            .stat-card { padding:10px; border-radius:4px; width:100%; }
            .stat-label { font-size:12px; margin-bottom:2px; }
            .stat-value { font-size:24px; margin-bottom:2px; }
            .stat-change { font-size:10px; }
            .admin-section { padding:12px; margin-bottom:12px; border-radius:4px; width:100%; box-sizing:border-box; }
            .admin-section h2 { font-size:18px; margin:0 0 10px 0; padding-bottom:8px; }
            .quick-actions { grid-template-columns:repeat(2,1fr); gap:10px; margin:0 auto 14px; max-width:none; width:100%; }
            .action-card { padding:14px; font-size:14px; border-radius:4px; width:100%; }
            .action-icon { font-size:28px; margin-bottom:2px; }
            .admin-notif-tab { padding:10px 14px; font-size:12px; }
            .modal { position:fixed; width:100vw; left:0; }
            .modal-content { max-width:calc(100vw - 20px); width:100%; padding:12px; box-sizing:border-box; }
            .modal-header { margin-bottom:10px; }
            .modal-header h2 { font-size:16px; margin:0; }
            .action-buttons { gap:4px; flex-wrap:wrap; }
            .btn-primary, .btn-sm { padding:8px 12px; font-size:13px; }
            .form-group { margin-bottom:10px; width:100%; }
            .form-group label { margin-bottom:4px; font-size:12px; }
            .form-group input, .form-group select, .form-group textarea { font-size:14px; padding:6px; width:100%; box-sizing:border-box; }
            .form-grid { gap:10px; grid-template-columns:1fr; width:100%; }
            .admin-table { font-size:13px; width:100%; }
            .admin-table th { padding:6px; font-size:10px; }
            .admin-table td { padding:6px; }
            .table-wrapper { overflow-x:auto; width:100%; }
            .admin-tab { width:100%; overflow:hidden; }
        }
    </style>
</head>
<body>
    <script>
        // Use deployed backend API base provided by user
        window.WISPA_API_BASE = 'https://wispa-real-estate-2ew3.onrender.com';
    </script>
    <script>
        // Global API fetch wrapper: try same-origin then fallback to deployed backend
        window.apiFetch = async function(url, opts) {
            const API_BASE = (window.WISPA_API_BASE || '').replace(/\/$/, '');
            try {
                const r = await fetch(url, opts);
                if (r && r.ok) return r;
            } catch (e) { /* ignore */ }
            if (API_BASE) {
                try {
                    const full = API_BASE + url;
                    const r2 = await fetch(full, opts);
                    return r2;
                } catch (e) { /* ignore */ }
            }
            return null;
        };
        // Override window.fetch for relative /api/ calls so scripts using fetch() still fall back
        try {
            const _origFetch = window.fetch.bind(window);
            window.fetch = async function(input, init) {
                if (typeof input === 'string' && input.startsWith('/api/')) {
                    const API_BASE = (window.WISPA_API_BASE || '').replace(/\/$/, '');
                    if (API_BASE) {
                        try { return await _origFetch(API_BASE + input, init); } catch(e){}
                        return new Response(null, { status: 502 });
                    }
                    try {
                        const r = await _origFetch(input, init);
                        if (r && r.ok) return r;
                    } catch (e) {}
                    return new Response(null, { status: 404 });
                }
                return _origFetch(input, init);
            };
        } catch(e) {}
    </script>
    <!-- ADMIN HEADER -->
    <header class="admin-header" style="display:flex; align-items:center; justify-content:space-between; background:var(--white); border-bottom:1px solid var(--border); padding:18px 30px;">
        <style>
        .admin-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 1002;
            box-sizing: border-box;
        }
        .admin-layout {
            margin-top: 80px !important;
        }
        @media (max-width: 768px) {
            .admin-header { padding: 10px 5vw !important; }
            .admin-layout { margin-top: 70px !important; }
        }
        </style>
        <div class="header-left" style="display:flex; flex-direction:column;">
            <span style="font-size:25px; font-weight:500; color:black; margin-right: 30px; font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;">ADMIN PANEL</span>
        </div>
        <div class="header-right" style="display:flex; align-items:center; gap:18px; position:relative;">
            <span title="Search" id="header-search" class="header-icon" style="font-size:22px; cursor:pointer;">üîç</span>
            <span title="Notifications" id="header-notification" class="header-icon" style="font-size:22px; cursor:pointer;">üîî</span>
            <span title="Chat" id="header-chat" class="header-icon" style="font-size:22px; cursor:pointer;">üí¨</span>
            <div class="hamburger-menu" style="position:relative;">
                <input type="checkbox" id="hamburger-toggle" style="display:none;">
                <label for="hamburger-toggle" style="cursor:pointer; display:inline-block;">
                    <span style="font-size:28px;">‚ò∞</span>
                </label>
                <div class="menu-dropdown" style="display:none; position:absolute; top:40px; right:0; background:var(--white); border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow); min-width:180px; z-index:100;">
                    <a href="#overview" class="menu-link" data-page="overview" style="display:block; padding:12px 18px; text-decoration:none;">Overview</a>
                    <a href="admin-profile.html" class="menu-link" target="_blank" style="display:block; padding:12px 18px; text-decoration:none;">Profile</a>
                    <a href="#properties" class="menu-link" data-page="properties" style="display:block; padding:12px 18px; text-decoration:none;">Properties</a>
                    <a href="#users" class="menu-link" data-page="users" style="display:block; padding:12px 18px; text-decoration:none;">Users</a>
                    <a href="#agents" class="menu-link" data-page="agents" style="display:block; padding:12px 18px; text-decoration:none;">Agents</a>
                    <a href="#analytics" class="menu-link" data-page="analytics" style="display:block; padding:12px 18px; text-decoration:none;">Analytics</a>
                    <a href="#documents" class="menu-link" data-page="documents" style="display:block; padding:12px 18px; text-decoration:none;">Documents</a>
                    <a href="#settings" class="menu-link" data-page="settings" style="display:block; padding:12px 18px; text-decoration:none;">Settings</a>
                </div>
            </div>
            <script>
                // Hamburger menu dropdown toggle and header icon wiring
                document.addEventListener('DOMContentLoaded', function() {
                            // Restore last opened tab from localStorage
                            if (window.location.pathname.endsWith('admin.html')) {
                                var savedTab = '';
                                try { savedTab = localStorage.getItem('adminCurrentTab'); } catch(e){}
                                if (savedTab && document.getElementById(savedTab)) {
                                    setTimeout(function() { switchTab(savedTab); }, 50);
                                    // Update hash for consistency
                                    window.location.hash = '#' + savedTab;
                                }
                            }
                    var toggle = document.getElementById('hamburger-toggle');
                    var dropdown = document.querySelector('.menu-dropdown');
                    var label = document.querySelector('label[for="hamburger-toggle"]');
                    if(toggle && dropdown && label) {
                        toggle.addEventListener('change', function() {
                            dropdown.style.display = toggle.checked ? 'block' : 'none';
                        });
                        label.addEventListener('click', function(e) {
                            e.preventDefault();
                            toggle.checked = !toggle.checked;
                            dropdown.style.display = toggle.checked ? 'block' : 'none';
                        });
                        document.addEventListener('click', function(e) {
                            if (!dropdown.contains(e.target) && !label.contains(e.target)) {
                                toggle.checked = false;
                                dropdown.style.display = 'none';
                            }
                        });
                    }

                    // Header icon wiring
                    var searchIcon = document.getElementById('header-search');
                    var notifIcon = document.getElementById('header-notification');
                    var chatIcon = document.getElementById('header-chat');
                    function animateIcon(icon) {
                        if (!icon) return;
                        icon.classList.remove('icon-animate');
                        // Force reflow to restart animation
                        void icon.offsetWidth;
                        icon.classList.add('icon-animate');
                    }
                    if(searchIcon) {
                        searchIcon.addEventListener('click', function(){
                            animateIcon(searchIcon);
                            setTimeout(function(){
                                window.location.href = 'admin-search.html';
                            }, 300);
                        });
                    }
                    if(notifIcon) {
                        notifIcon.addEventListener('click', function(){
                            animateIcon(notifIcon);
                            setTimeout(function(){
                                window.location.hash = '#notification';
                                var notifTab = document.getElementById('notification');
                                if (notifTab) {
                                    var allTabs = document.querySelectorAll('.admin-tab');
                                    allTabs.forEach(function(tab){ tab.style.display = 'none'; });
                                    notifTab.style.display = 'block';
                                }
                            }, 300);
                        });
                    }
                    if(chatIcon) {
                        chatIcon.addEventListener('click', function(){
                            animateIcon(chatIcon);
                            setTimeout(function(){
                                window.location.href = 'admin-chat.html';
                            }, 300);
                        });
                    }

                    // Hamburger menu active nav highlight logic
                    function setActiveMenuLink() {
                        var menuLinks = document.querySelectorAll('.menu-link');
                        var current = window.location.pathname.split('/').pop();
                        var hash = window.location.hash.replace('#','');
                        // Remove all active/green styles first
                        menuLinks.forEach(function(link) {
                            link.classList.remove('active');
                            link.style.color = '';
                            link.style.fontWeight = '';
                        });
                        // Only one should be active: the one matching the current hash/tab
                        var found = false;
                        menuLinks.forEach(function(link) {
                            var href = link.getAttribute('href');
                            if (current === 'admin.html' && link.hasAttribute('data-page') && hash && href === '#' + hash) {
                                link.classList.add('active');
                                link.style.color = 'green';
                                link.style.fontWeight = '600';
                                found = true;
                            }
                        });
                        // If no hash match, default to overview
                        if (!found) {
                            var overviewLink = document.querySelector('.menu-link[data-page="overview"]');
                            if (overviewLink) {
                                overviewLink.classList.add('active');
                                overviewLink.style.color = 'green';
                                overviewLink.style.fontWeight = '600';
                            }
                        }
                    }
                    setActiveMenuLink();
                    window.addEventListener('hashchange', setActiveMenuLink);
                    // Hamburger menu links wiring
                    var menuLinks = document.querySelectorAll('.menu-link');
                    menuLinks.forEach(function(link){
                        // Only intercept links with data-page (internal tabs)
                        if(link.hasAttribute('data-page')) {
                            link.addEventListener('click', function(e){
                                e.preventDefault();
                                var page = link.getAttribute('data-page');
                                if(typeof switchTab === 'function') {
                                    switchTab(page);
                                    toggle.checked = false;
                                    dropdown.style.display = 'none';
                                }
                            });
                        }
                        // For links without data-page (external pages), let default action occur
                    });
                });
            </script>
        </div>
    </header>
        <script>
        // Admin API helpers ‚Äî use server-backed storage, not localStorage
        (function(){
            const mapping = {
                adminSentNotifications: '/api/admin/sent-notifications',
                adminProfile: '/api/admin/profile',
                propertyRequests: '/api/property-requests',
                contactMessages: '/api/contact-messages',
                notificationReactions: '/api/notification-reactions',
                systemAlerts: '/api/system-alerts',
                notifications: '/api/notifications',
                conversations: '/api/conversations'
            };

            function extractPayload(data) {
                if (!data) return data;
                if (Array.isArray(data)) return data;
                if (data.sent) return data.sent;
                if (data.profile) return data.profile;
                if (data.requests) return data.requests;
                if (data.contacts) return data.contacts;
                if (data.reactions) return data.reactions;
                if (data.alerts) return data.alerts;
                if (data.notifications) return data.notifications;
                if (data.conversations) return data.conversations;
                if (data.properties) return data.properties;
                if (data.users) return data.users;
                return data;
            }

            async function adminFetch(url, opts) {
                // prefer window.apiFetch if available (handles API_BASE fallback)
                try {
                    if (window.apiFetch) return await window.apiFetch(url, opts);
                    return await fetch(url, opts);
                } catch (e) {
                    try {
                        const base = (window.WISPA_API_BASE || '').replace(/\/$/, '');
                        if (base) return await fetch(base + url, opts);
                    } catch (e) {}
                }
                return null;
            }

            window.adminGet = async function(key) {
                const url = mapping[key];
                if (!url) return null;
                try {
                    const r = await adminFetch(url);
                    if (!r || !r.ok) return null;
                    const j = await r.json();
                    return extractPayload(j);
                } catch (e) { return null; }
            };

            window.adminSet = async function(key, value) {
                const url = mapping[key] || '/api/admin/sync';
                try {
                    if (url === '/api/admin/sync') {
                        await adminFetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key, value }) });
                        return true;
                    }
                    // POST to resource-specific endpoints for simple lists
                    await adminFetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(value) });
                    return true;
                } catch (e) { return false; }
            };

        })();
        </script>
        <script>
        // Populate an in-memory cache from server and shim localStorage to use it (no browser localStorage persistence)
        (async function(){
            const keys = ['adminSentNotifications','adminProfile','propertyRequests','contactMessages','notificationReactions','systemAlerts','notifications','conversations','properties','postCreationStatus','chatNotifications','systemAttackers','agentProfile','wispaUser','adminChats','adminCurrentTab'];
            window._adminCache = window._adminCache || {};
            for (const k of keys) {
                try {
                    const v = (window.adminGet) ? await window.adminGet(k) : null;
                    window._adminCache[k] = (v === undefined || v === null) ? null : JSON.stringify(v);
                } catch (e) { window._adminCache[k] = null; }
            }
            try {
                localStorage.getItem = function(key) { return window._adminCache[key] ?? null; };
                localStorage.setItem = function(key, value) {
                    window._adminCache[key] = value;
                    try {
                        const parsed = JSON.parse(value);
                        if (window.adminSet) window.adminSet(key, parsed).catch(()=>{});
                    } catch (e) {
                        if (window.adminSet) window.adminSet(key, value).catch(()=>{});
                    }
                };
            } catch (e) { /* ignore */ }
        })();
        </script>
    <!-- MAIN ADMIN LAYOUT -->
    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="admin-sidebar">
            <!-- Sidebar navs removed, space and hr cleared -->
            <style>
            .admin-sidebar { padding-top: 0 !important; padding-bottom: 0 !important; }
            </style>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="admin-main">
            <!-- OVERVIEW TAB -->
            <div id="overview" class="admin-tab">
                <div class="dashboard-header" style="border: none;">
                    <h2 style="font-weight: 500;">Dashboard</h2>
                    <h5 style="font-weight: 500;">Welcome to the Wispa Real Estate Admin Panel</h5>
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="openModal('addProperty')">
                        <div class="action-icon">‚ûï</div>
                        <div class="action-name">Add Property</div>
                    </div>
                    <div class="action-card" onclick="openModal('addAgent')">
                        <div class="action-icon">‚ú®</div>
                        <div class="action-name">Add Agent</div>
                    </div>
                    <div class="action-card" onclick="openModal('sendMessage')">
                        <div class="action-icon">üíå</div>
                        <div class="action-name">Send Notification</div>
                    </div>
                    <div class="action-card" onclick="switchTab('analytics')">
                        <div class="action-icon">üìä</div>
                        <div class="action-name">View Stats</div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Properties</div>
                        <div class="stat-value">324</div>
                        <div class="stat-change">‚Üë 12% from last month</div>
                    </div>
                    <div class="stat-card secondary">
                        <div class="stat-label">Active Users</div>
                        <div class="stat-value">1,847</div>
                        <div class="stat-change">‚Üë 8% from last month</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Completed Sales</div>
                        <div class="stat-value">156</div>
                        <div class="stat-change negative">‚Üì 3% from last month</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Pending Listings</div>
                        <div class="stat-value">48</div>
                        <div class="stat-change">‚Üë 5% from last month</div>
                    </div>
                </div>
                <div class="admin-section">
                    <h2 style="font-weight: 500; text-align: center;">Recent Properties</h2>
                    <div class="table-wrapper" style="max-height:340px; overflow-y:auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Property</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-properties-tbody"></tbody>
                        </table>
                    </div>
                    <div style="text-align:right; margin-top:8px;">
                        <button class="btn-primary" id="view-more-properties-btn" style="padding:8px 22px;">View More</button>
                    </div>
                    <script>
                    // Render recent properties using server-backed properties list
                    async function renderRecentPropertiesUnified() {
                        const tbody = document.getElementById('recent-properties-tbody');
                        if (!tbody) return;
                        // local helpers to match main properties table
                        function formatEightId(id){
                            const s = String(id || '');
                            if (s.length >= 8) return s.slice(-8);
                            return s.padStart(8, '0');
                        }
                        function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>\"]+/g, function(ch){ switch(ch){ case '&': return '&amp;'; case '<': return '&lt;'; case '>': return '&gt;'; case '"': return '&quot;'; } return ch; }); }

                        let props = [];
                        try {
                            const r = window.apiFetch ? await window.apiFetch('/api/properties') : await fetch('/api/properties');
                            if (!r) throw new Error('No response');
                            let data = null;
                            if (typeof r.json === 'function') data = await r.json(); else data = r;
                            if (Array.isArray(data)) props = data; else if (data && Array.isArray(data.properties)) props = data.properties; else props = [];
                        } catch (e) { props = []; }

                        props.sort((a, b) => new Date(b.posted || b.created || b.date || 0) - new Date(a.posted || a.created || a.date || 0));
                        const recent = props.slice(0, 5);
                        tbody.innerHTML = '';
                        if (recent.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#aaa;">No recent properties found</td></tr>';
                            return;
                        }
                        recent.forEach(p => {
                            const displayId = formatEightId(p.id || p.propertyId || Date.now());
                            const title = p.title || p.name || 'Untitled';
                            const type = p.type || p.postTo || '';
                            const price = p.price ? Number(p.price) : 0;
                            const location = p.location || p.address || '';
                            const status = p.status || (p.active ? 'Active' : 'Active');

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>#${displayId}</td>
                                <td>${escapeHtml(title)}</td>
                                <td>${escapeHtml(type)}</td>
                                <td>‚Ç¨${price.toLocaleString()}</td>
                                <td>${escapeHtml(location)}</td>
                                <td><span class="badge active">${escapeHtml(status)}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-sm edit" data-id="${displayId}" onclick="viewProperty('${p.id || displayId}')">View</button>
                                        <button class="btn-sm" style="background:#2ecc71;color:white;font-size:11px;" onclick="openPropertyDoc('${p.id || displayId}')">üìÑ</button>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    // View More button switches to properties tab
                    document.addEventListener('DOMContentLoaded', function() {
                        renderRecentPropertiesUnified();
                        var btn = document.getElementById('view-more-properties-btn');
                        if (btn) {
                            btn.onclick = function() {
                                if (typeof switchTab === 'function') switchTab('properties');
                                window.location.hash = '#properties';
                            };
                        }
                    });
                    // Use the same viewProperty and openPropertyDoc as properties tab
                    function viewProperty(id) {
                        window.location.href = 'property-detail.html?id=' + encodeURIComponent(id);
                    }
                    function openPropertyDoc(id) {
                        alert('Open property document for property ID: ' + id);
                    }
                    </script>
                </div>
            </div>

            <!-- PROPERTIES TAB -->
            <div id="properties" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Property Management</h1>
                    <p>Manage all property listings</p>
                </div>
                <div class="admin-section">
                    <h2>All Properties</h2>
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <button class="btn-primary" onclick="openModal('addProperty')">+ Add New Property</button>
                        <button class="btn-sm delete" type="button" onclick="clearAllProperties()" style="background:#e74c3c;color:#fff;padding:10px 14px;">Clear All Properties</button>
                    </div>
                    <div class="table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Property</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="properties-tbody"></tbody>
                        </table>
                        <script>
                        // Fetch and render properties from backend API
                        function formatEightId(id){
                            const s = String(id || '');
                            if (s.length >= 8) return s.slice(-8);
                            return s.padStart(8, '0');
                        }

                        async function renderPropertiesWithDocButton() {
                            const tbody = document.getElementById('properties-tbody');
                            if (!tbody) return;
                            tbody.innerHTML = '';
                            let props = [];
                            try {
                                const res = await window.apiFetch('/api/properties');
                                if (!res) throw new Error('No response');
                                // apiFetch may return a Response or parsed JSON
                                let data = null;
                                if (typeof res.json === 'function') {
                                    data = await res.json();
                                } else {
                                    data = res;
                                }
                                // support both { properties: [...] } and array responses
                                if (Array.isArray(data)) props = data;
                                else if (data && Array.isArray(data.properties)) props = data.properties;
                                else props = [];
                            } catch (e) {
                                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#aaa;">Failed to load properties</td></tr>';
                                return;
                            }
                            if (!Array.isArray(props) || props.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#aaa;">No properties found</td></tr>';
                                return;
                            }
                            props.forEach(p => {
                                const displayId = formatEightId(p.id || p.propertyId || Date.now());
                                const title = p.title || p.name || p.title || 'Untitled';
                                const type = p.type || p.postTo || (p.property_type || '') || '';
                                const price = p.price ? Number(p.price) : (p.price || 0);
                                const location = p.location || p.address || '';
                                const status = p.status || (p.active ? 'Active' : 'Active');

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>#${displayId}</td>
                                    <td>${escapeHtml(title)}</td>
                                    <td>${escapeHtml(type)}</td>
                                    <td>‚Ç¨${price.toLocaleString()}</td>
                                    <td>${escapeHtml(location)}</td>
                                    <td><span class="badge active">${escapeHtml(status)}</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-sm edit" data-id="${displayId}" onclick="editProperty('${displayId}')">Edit</button>
                                            <button class="btn-sm" style="background:#2ecc71;color:white;font-size:11px;" onclick="generatePropertyDocument('${p.id || displayId}')">üìÑ Generate Doc</button>
                                            <button class="btn-sm delete" onclick="deleteProperty('${p.id || displayId}')">Delete</button>
                                        </div>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });
                        }

                        // small helper to avoid injecting raw HTML
                        function escapeHtml(s){
                            if(s === null || s === undefined) return '';
                            return String(s).replace(/[&<>\"]+/g, function(ch){
                                switch(ch){ case '&': return '&amp;'; case '<': return '&lt;'; case '>': return '&gt;'; case '"': return '&quot;'; }
                                return ch;
                            });
                        }
                        function editProperty(id) { alert('Edit property: ' + id); }
                        async function deleteProperty(id) {
                            if (!confirm('Delete this property?')) return;
                            try {
                                const r = await window.apiFetch(`/api/properties/${id}`, { method: 'DELETE' });
                                if (!r || !r.ok) throw new Error('Delete failed');
                                renderPropertiesWithDocButton();
                                if (typeof renderPropertyDocuments === 'function') renderPropertyDocuments();
                            } catch (e) {
                                alert('Failed to delete property');
                            }
                        }
                        async function generatePropertyDocument(id) {
                            try {
                                const r = await window.apiFetch(`/api/properties/${id}/generate-document`, { method: 'POST' });
                                if (!r || !r.ok) throw new Error('Generate failed');
                                alert('Document generated for property #' + id);
                                renderPropertiesWithDocButton();
                                if (typeof renderPropertyDocuments === 'function') renderPropertyDocuments();
                            } catch (e) {
                                alert('Failed to generate document');
                            }
                        }
                        document.addEventListener('DOMContentLoaded', renderPropertiesWithDocButton);
                        </script>
                        </table>
                    </div>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="users" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>User Management</h1>
                    <p>Manage site users and accounts</p>
                </div>
                <div class="admin-section">
                    <h2>All Users</h2>
                    <div class="table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody"></tbody>
                                        <script>
                                        // Fetch and render users from backend API
                                        async function renderAdminAccounts() {
                                            const tbody = document.getElementById('users-tbody');
                                            if (!tbody) return;
                                            let users = [];
                                            try {
                                                const res = await (window.apiFetch ? window.apiFetch('/api/users') : fetch('/api/users'));
                                                const data = await res.json();
                                                users = data.users || [];
                                            } catch (e) {
                                                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#aaa;">Failed to load users</td></tr>';
                                                return;
                                            }
                                            tbody.innerHTML = (!Array.isArray(users) || users.length === 0) ? '<tr><td colspan="6" style="text-align:center;color:#aaa;">No user accounts found</td></tr>' :
                                                users.map(user => `
                                                    <tr>
                                                        <td>${user.full_name || user.username || 'Unknown'}</td>
                                                        <td>${user.email || 'N/A'}</td>
                                                        <td>${user.role || 'User'}</td>
                                                        <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                                                        <td>${user.status || 'Active'}</td>
                                                        <td><button class="btn-sm edit" onclick="editUser('${user.id}')">Edit</button></td>
                                                    </tr>
                                                `).join('');
                                        }
                                        document.addEventListener('DOMContentLoaded', renderAdminAccounts);
                                        function editUser(id) { alert('Edit user: ' + id); }
                                        </script>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AGENTS TAB -->
            <div id="agents" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Agent Management</h1>
                    <p>Manage real estate agents</p>
                </div>
                <div class="admin-section">
                    <h2>All Agents</h2>
                    <button class="btn-primary" onclick="openModal('addAgent')" style="margin-bottom: 20px;">+ Add New Agent</button>
                    <div class="table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Properties</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Emma Wilson</td>
                                    <td>emma.wilson@wispa.com</td>
                                    <td>+33 1 234 567</td>
                                    <td>24</td>
                                    <td>4.8 ‚≠ê</td>
                                    <td><div class="action-buttons"><button class="btn-sm edit">Edit</button></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="analytics" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Analytics</h1>
                    <p>Site performance and user statistics</p>
                </div>

                <div class="admin-section">
                    <h2>Overview Metrics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Visits (30d)</div>
                            <div class="stat-value" id="visits-30">0</div>
                            <div class="stat-change" id="visits-change">+0%</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-label">New Signups (30d)</div>
                            <div class="stat-value" id="signups-30">0</div>
                            <div class="stat-change" id="signups-change">+0%</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-label">Conversion</div>
                            <div class="stat-value" id="conversion">0%</div>
                            <div class="stat-change" id="conversion-change">+0%</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Revenue</div>
                            <div class="stat-value" id="revenue">‚Ç¨0</div>
                            <div class="stat-change" id="revenue-change">+0%</div>
                        </div>
                    </div>

                    <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:18px;">
                        <div style="flex:1;min-width:300px;background:var(--white);padding:18px;border-radius:8px;box-shadow:var(--shadow);">
                            <h3 style="margin:0 0 10px 0;font-size:16px;">Visits (Last 30 days)</h3>
                            <canvas id="visits-line" width="600" height="200" style="width:100%;height:160px;"></canvas>
                        </div>

                        <div style="width:360px;min-width:260px;background:var(--white);padding:18px;border-radius:8px;box-shadow:var(--shadow);">
                            <h3 style="margin:0 0 10px 0;font-size:16px;">Users by Role</h3>
                            <canvas id="users-pie" width="360" height="200" style="width:100%;height:160px;"></canvas>
                        </div>
                    </div>

                    <div style="margin-top:18px;background:var(--white);padding:18px;border-radius:8px;box-shadow:var(--shadow);">
                        <h3 style="margin:0 0 12px 0;font-size:16px;">Top Properties (by views)</h3>
                        <div class="table-wrapper" style="max-height:400px;overflow-y:auto;">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Location</th>
                                        <th>Views</th>
                                    </tr>
                                </thead>
                                <tbody id="top-properties-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DOCUMENTS TAB -->
            <div id="documents" class="admin-tab" style="display: none;">
                <div class="dashboard-header" style="text-align:center; border:none; margin-bottom:10px;">
                    <h1 style="font-size:2.2rem; font-weight:700; color:var(--primary); margin-bottom:6px;">üìÑ Property Documents</h1>
                    <p style="color:var(--text-light); font-size:1.1rem;">Download and manage all generated property documents here.</p>
                </div>
                <div class="admin-section" style="background:var(--lighter); box-shadow:none; border-radius:12px; padding:32px 18px; max-width:900px; margin:0 auto;">
                    <div id="property-docs-list-container">
                        <table style="width:100%; border-collapse:collapse; background:var(--white); border-radius:10px; overflow:hidden; box-shadow:var(--shadow);">
                            <thead style="background:var(--primary); color:#fff;">
                                <tr>
                                    <th style="padding:14px 8px; text-align:left;">Property</th>
                                    <th style="padding:14px 8px; text-align:left;">Location</th>
                                    <th style="padding:14px 8px; text-align:left;">Price</th>
                                    <th style="padding:14px 8px; text-align:left;">Format</th>
                                    <th style="padding:14px 8px; text-align:left;">Document</th>
                                </tr>
                            </thead>
                            <tbody id="property-docs-list">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                        <div id="no-documents-message" style="display:none; text-align:center; color:#aaa; padding:32px 0; font-size:1.2rem;">
                            <span style="font-size:2.5rem; display:block;">üìÇ</span>
                            No property documents found.
                        </div>
                    </div>
                    <script>
                    function renderPropertyDocuments() {
                        const tbody = document.getElementById('property-docs-list');
                        const noDocsMsg = document.getElementById('no-documents-message');
                        if (!tbody) return;
                        let properties = [];
                        try {
                            properties = JSON.parse(localStorage.getItem('properties') || '[]');
                        } catch (e) { properties = []; }
                        const docs = properties.filter(p => p.document);
                        if (docs.length === 0) {
                            tbody.innerHTML = '';
                            if (noDocsMsg) noDocsMsg.style.display = 'block';
                            return;
                        }
                        if (noDocsMsg) noDocsMsg.style.display = 'none';
                        tbody.innerHTML = docs.map(prop => `
                            <tr style="border-bottom:1px solid var(--border);">
                                <td style="padding:14px 8px; font-weight:600; color:var(--primary-dark);">
                                    <span style="font-size:1.1rem;">üè†</span> ${prop.name || prop.title || 'Untitled'}
                                </td>
                                <td style="padding:14px 8px; color:#555;">${prop.location || 'N/A'}</td>
                                <td style="padding:14px 8px; color:#333;">${prop.price ? '‚Ç¨' + prop.price : 'N/A'}</td>
                                <td style="padding:14px 8px; color:#333;">${prop.documentFormat || 'PDF'}</td>
                                <td style="padding:14px 8px;">
                                    ${prop.document ? `<a href="${prop.document}" target="_blank" style="color:var(--secondary);font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:6px;">‚¨áÔ∏è Download</a>` : '<span style="color:#aaa;">None</span>'}
                                </td>
                            </tr>
                        `).join('');
                    }
                    document.addEventListener('DOMContentLoaded', function() {
                        renderPropertyDocuments();
                        if (window.location.hash === '#documents') {
                            var docsTab = document.getElementById('documents');
                            if (docsTab) {
                                var allTabs = document.querySelectorAll('.admin-tab');
                                allTabs.forEach(function(tab){ tab.style.display = 'none'; });
                                docsTab.style.display = 'block';
                                renderPropertyDocuments();
                            }
                        }
                    });
                    if (typeof window.switchTab === 'function') {
                        const origSwitchTab = window.switchTab;
                        window.switchTab = function(tabName) {
                            origSwitchTab.apply(this, arguments);
                            if (tabName === 'documents') {
                                renderPropertyDocuments();
                            }
                        }
                    }
                    window.addEventListener('hashchange', function() {
                        if (window.location.hash === '#documents') {
                            var docsTab = document.getElementById('documents');
                            if (docsTab) {
                                var allTabs = document.querySelectorAll('.admin-tab');
                                allTabs.forEach(function(tab){ tab.style.display = 'none'; });
                                docsTab.style.display = 'block';
                                renderPropertyDocuments();
                            }
                        }
                    });
                    </script>
                </div>
            </div>

            <!-- PROPERTY DOCUMENTS TAB REMOVED: Now handled by #documents tab only -->

            <!-- SETTINGS TAB -->
            <div id="settings" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Settings</h1>
                    <p>Manage site settings and configuration</p>
                </div>
            </div>

            <!-- NOTIFICATIONS TAB -->
            <div id="alerts" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Alerts Management</h1>
                    <p>Create, manage and track system notifications</p>
                </div>

                <!-- ALERT STATS -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Alerts</div>
                        <div class="stat-value" id="alert-total">0</div>
                        <div class="stat-change">All time</div>
                    </div>
                    <div class="stat-card secondary">
                        <div class="stat-label">Active Alerts</div>
                        <div class="stat-value" id="alert-active">0</div>
                        <div class="stat-change">Currently displayed</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Unread</div>
                        <div class="stat-value" id="alert-unread">0</div>
                        <div class="stat-change">By users</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Sent</div>
                        <div class="stat-value" id="alert-sent">0</div>
                        <div class="stat-change">This month</div>
                    </div>
                </div>

                <!-- ALERTS TABS -->
                <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid var(--border);flex-wrap:wrap;">
                    <button class="admin-tab-btn active" onclick="switchAlertTab('create')" style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;color:var(--text);">üîî Notification Alerts</button>
                    <button class="admin-tab-btn" onclick="switchAlertTab('templates')" style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;color:var(--text);">üìã Templates</button>
                    <button class="admin-tab-btn" onclick="openModal('sendMessage')" style="padding:12px 20px;background:none;border:none;cursor:pointer;font-weight:600;border-bottom:3px solid transparent;color:var(--text);">‚ûï Create Alert</button>
                </div>

                <!-- CREATE ALERT TAB (NOTIFICATION FILTERS) -->
                <div id="alert-create-tab" class="alert-tab-content" style="margin:20px 0;">
                    <div class="admin-section">
                        <h2>Notification Alerts</h2>
                        <p style="color:var(--text-light);margin-bottom:20px;">View and manage notifications from different sources</p>
                        
                        <!-- Filter Buttons -->
                        <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
                            <button class="admin-notif-tab active" data-filter="all" onclick="filterNotificationAlerts('all')" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">üìä All</button>
                            <button class="admin-notif-tab" data-filter="chats" onclick="filterNotificationAlerts('chats')" style="padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">üí¨ Chats</button>
                            <button class="admin-notif-tab" data-filter="feedback" onclick="filterNotificationAlerts('feedback')" style="padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">üìù Feedback & Contacts</button>
                            <button class="admin-notif-tab" data-filter="inbox" onclick="filterNotificationAlerts('inbox')" style="padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">üì¨ Notification Inbox</button>
                            <button class="admin-notif-tab" data-filter="reactions" onclick="filterNotificationAlerts('reactions')" style="padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">üëç Post Reactions</button>
                        </div>

                        <!-- Filtered Results -->
                        <div class="table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Source</th>
                                        <th>Description</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="notification-alerts-tbody">
                                    <!-- Populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- TEMPLATES TAB -->
                <div id="alert-templates-tab" class="alert-tab-content" style="display:none;">
                    <div class="admin-section">
                        <h2>Alert Templates</h2>
                        <div id="templates-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin-bottom:20px;">
                            <!-- Templates populated here -->
                        </div>
                    </div>
                </div>


            </div>

            <!-- ALERT VIEW MODAL -->
            <div id="alertViewModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Alert Details</h2>
                        <button class="modal-close" onclick="closeModal('alertViewModal')">‚úï</button>
                    </div>
                    <div id="alert-detail-content" style="color:var(--text);line-height:1.6;">
                        <!-- Populated dynamically -->
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn-sm edit" onclick="editAlertFromModal()">‚úèÔ∏è Edit</button>
                        <button class="btn-sm delete" id="delete-alert-btn" onclick="deleteAlertFromModal()">üóëÔ∏è Delete</button>
                        <button class="btn-sm" style="background:#95a5a6;color:white;" onclick="closeModal('alertViewModal')">Close</button>
                    </div>
                </div>
            </div>

            <!-- ALERT EDIT MODAL -->
            <div id="alertEditModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Alert</h2>
                        <button class="modal-close" onclick="closeModal('alertEditModal')">‚úï</button>
                    </div>
                    <form id="alert-edit-form">
                        <input type="hidden" id="edit-alert-id" value="">
                        <div class="form-group">
                            <label for="edit-alert-title">Alert Title *</label>
                            <input type="text" id="edit-alert-title" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-alert-message">Alert Message *</label>
                            <textarea id="edit-alert-message" required rows="4"></textarea>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="edit-alert-type">Type</label>
                                <select id="edit-alert-type">
                                    <option value="info">‚ÑπÔ∏è Info</option>
                                    <option value="success">‚úÖ Success</option>
                                    <option value="warning">‚ö†Ô∏è Warning</option>
                                    <option value="error">‚ùå Error</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-alert-priority">Priority</label>
                                <select id="edit-alert-priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-alert-target">Target</label>
                                <select id="edit-alert-target">
                                    <option value="all">All Users</option>
                                    <option value="agents">All Agents</option>
                                    <option value="users">All Buyers/Renters</option>
                                    <option value="admins">Admin Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="edit-alert-status">Status</label>
                                <select id="edit-alert-status">
                                    <option value="active">Active</option>
                                    <option value="draft">Draft</option>
                                    <option value="scheduled">Scheduled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-alert-expiry">Expiry Date</label>
                                <input type="date" id="edit-alert-expiry">
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button class="btn-primary" type="submit">üíæ Save Changes</button>
                            <button class="btn-sm" style="background:#95a5a6;color:white;" type="button" onclick="closeModal('alertEditModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SEARCH TAB -->
            <div id="search" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Search</h1>
                    <p>Search and filter properties and users</p>
                </div>
            </div>

            <!-- ADMIN NOTIFICATION/ALERTS TAB -->
            <div id="notification" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Admin Notifications</h1>
                    <p>Manage feedbacks, sent notifications, reactions, and chat notifications</p>
                </div>

                <!-- Notification Tabs -->
                <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;border-bottom:2px solid var(--border);padding-bottom:15px;">
                    <button class="admin-notif-tab active" data-tab="all" onclick="switchNotificationTab('all')">üìã All</button>
                    <button class="admin-notif-tab" data-tab="sent" onclick="switchNotificationTab('sent')">üì® Sent</button>
                    <button class="admin-notif-tab" data-tab="received" onclick="switchNotificationTab('received')">üì• Received</button>
                    <button class="admin-notif-tab" data-tab="create" onclick="switchNotificationTab('create')">‚ûï Create Alert</button>
                                <!-- ALL TAB -->
                                <div id="all-content" class="notif-tab-content" style="display:none;">
                                    <div class="admin-section">
                                        <h2>All Alerts</h2>
                                        <p style="color:var(--text-light);margin:0 0 20px 0;">Combined list of all sent and received alerts.</p>
                                        <div class="table-wrapper">
                                            <table class="admin-table">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Source/Recipient</th>
                                                        <th>Title/Description</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="all-alerts-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- SENT TAB -->
                                <div id="sent-content" class="notif-tab-content" style="display:none;">
                                    <div class="admin-section">
                                        <h2>Sent Alerts</h2>
                                        <div class="table-wrapper">
                                            <table class="admin-table">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Recipient</th>
                                                        <th>Title/Description</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sent-alerts-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- RECEIVED TAB -->
                                <div id="received-content" class="notif-tab-content" style="display:none;">
                                    <div class="admin-section">
                                        <h2>Received Alerts</h2>
                                        <div class="table-wrapper">
                                            <table class="admin-table">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Source</th>
                                                        <th>Title/Description</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="received-alerts-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- CREATE ALERT TAB -->
                                <div id="create-content" class="notif-tab-content" style="display:none;">
                                    <div class="admin-section">
                                        <h2>Create Alert</h2>
                                        <button class="btn-primary" onclick="openModal('sendMessage')">Open Send Notify Page</button>
                                    </div>
                                </div>
                    <script>
                    // Render All Alerts (combines sent and received)
                    function renderAllAlerts() {
                        const sent = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                        const received = getReceivedAlerts();
                        const all = [
                            ...sent.map(s => ({
                                type: 'Sent',
                                source: s.recipient || s.to || 'User',
                                title: s.title || s.message || 'Alert',
                                date: s.sentAt || s.date || '',
                                status: s.status || 'Sent',
                                actions: ''
                            })),
                            ...received
                        ];
                        all.sort((a, b) => new Date(b.date) - new Date(a.date));
                        const tbody = document.getElementById('all-alerts-tbody');
                        if (!tbody) return;
                        tbody.innerHTML = all.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#aaa;">No alerts found</td></tr>' :
                            all.map(alert => `
                                <tr>
                                    <td>${alert.type}</td>
                                    <td>${alert.source}</td>
                                    <td>${alert.title}</td>
                                    <td>${alert.date ? new Date(alert.date).toLocaleString() : ''}</td>
                                    <td>${alert.status}</td>
                                    <td>${alert.actions}</td>
                                </tr>
                            `).join('');
                    }

                    // Render Sent Alerts (full width)
                    function renderSentAlerts() {
                        const sent = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                        const tbody = document.getElementById('sent-alerts-tbody');
                        if (!tbody) return;
                        tbody.innerHTML = sent.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#aaa;">No sent alerts</td></tr>' :
                            sent.map(s => `
                                <tr>
                                    <td>Sent</td>
                                    <td>${s.recipient || s.to || 'User'}</td>
                                    <td>${s.title || s.message || 'Alert'}</td>
                                    <td>${s.sentAt ? new Date(s.sentAt).toLocaleString() : (s.date ? new Date(s.date).toLocaleString() : '')}</td>
                                    <td>${s.status || 'Sent'}</td>
                                    <td></td>
                                </tr>
                            `).join('');
                    }

                    // Render Received Alerts (full width, all types)
                    function getReceivedAlerts() {
                        const received = [];
                        try {
                            // System Alerts
                            const systemAlerts = JSON.parse(localStorage.getItem('systemAlerts') || '[]');
                            systemAlerts.forEach(a => received.push({
                                type: 'System',
                                source: a.source || 'System',
                                title: a.title || a.message || 'System Alert',
                                date: a.date || '',
                                status: a.status || '',
                                actions: ''
                            }));
                            // Chats
                            const chats = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                            chats.forEach(c => received.push({
                                type: 'Chat',
                                source: c.userName || c.participantName || c.participantId || 'User',
                                title: c.conversationTitle || 'Chat Message',
                                date: c.lastMessageDate || c.timestamp || c.date || '',
                                status: c.read ? 'Read' : 'Unread',
                                actions: ''
                            }));
                            // Property Reactions
                            const reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
                            reactions.forEach(r => received.push({
                                type: 'Reaction',
                                source: r.user || 'User',
                                title: r.message || 'Post Reaction',
                                date: r.date || '',
                                status: r.read ? 'Read' : 'Unread',
                                actions: ''
                            }));
                            // Attacker Attempts
                            const attackers = JSON.parse(localStorage.getItem('systemAttackers') || '[]');
                            attackers.forEach(a => received.push({
                                type: 'Attacker',
                                source: a.ip || a.user || 'Unknown',
                                title: a.reason || 'Attack Attempt',
                                date: a.date || '',
                                status: a.status || 'Blocked',
                                actions: ''
                            }));
                            // Property Requests
                            const requests = JSON.parse(localStorage.getItem('propertyRequests') || '[]');
                            requests.forEach(req => received.push({
                                type: 'Property Request',
                                source: req.user || req.email || 'User',
                                title: req.message || req.request || 'Request',
                                date: req.date || '',
                                status: req.read ? 'Read' : 'Unread',
                                actions: ''
                            }));
                            // Contacts
                            const contacts = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                            contacts.forEach(msg => received.push({
                                type: 'Contact',
                                source: msg.name || msg.email || 'User',
                                title: msg.message || msg.subject || 'Contact Message',
                                date: msg.date || '',
                                status: msg.read ? 'Read' : 'Unread',
                                actions: ''
                            }));
                            // Post Creation Status
                            const postStatus = JSON.parse(localStorage.getItem('postCreationStatus') || '[]');
                            postStatus.forEach(p => received.push({
                                type: 'Post Creation',
                                source: p.user || 'User',
                                title: p.status || 'Post Created',
                                date: p.date || '',
                                status: p.status || '',
                                actions: ''
                            }));
                        } catch(e) {}
                        return received;
                    }
                    function renderReceivedAlerts() {
                        const received = getReceivedAlerts();
                        const tbody = document.getElementById('received-alerts-tbody');
                        if (!tbody) return;
                        tbody.innerHTML = received.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#aaa;">No received alerts</td></tr>' :
                            received.map(alert => `
                                <tr>
                                    <td>${alert.type}</td>
                                    <td>${alert.source}</td>
                                    <td>${alert.title}</td>
                                    <td>${alert.date ? new Date(alert.date).toLocaleString() : ''}</td>
                                    <td>${alert.status}</td>
                                    <td>${alert.actions}</td>
                                </tr>
                            `).join('');
                    }

                    // Tab switch logic
                    function switchNotificationTab(tabName) {
                        if (typeof window !== 'undefined') window.switchNotificationTab = switchNotificationTab;
                        document.querySelectorAll('.notif-tab-content').forEach(tab => {
                            tab.style.display = 'none';
                        });
                        document.querySelectorAll('.admin-notif-tab').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        const contentId = tabName + '-content';
                        const tabContent = document.getElementById(contentId);
                        if (tabContent) {
                            tabContent.style.display = 'block';
                        }
                        let btn = null;
                        if (event && event.target && event.target.classList.contains('admin-notif-tab')) {
                            btn = event.target;
                        } else {
                            btn = document.querySelector('.admin-notif-tab[data-tab="' + tabName + '"]');
                        }
                        if (btn) btn.classList.add('active');
                        if(tabName === 'all') renderAllAlerts();
                        if(tabName === 'sent') renderSentAlerts();
                        if(tabName === 'received') renderReceivedAlerts();
                    }
                    document.addEventListener('DOMContentLoaded', function(){
                        if(document.querySelector('.admin-notif-tab.active[data-tab="all"]')) renderAllAlerts();
                        if(document.querySelector('.admin-notif-tab.active[data-tab="sent"]')) renderSentAlerts();
                        if(document.querySelector('.admin-notif-tab.active[data-tab="received"]')) renderReceivedAlerts();
                    });
                    </script>
                </div>
                <!-- ALL TAB -->
                <div id="all-content" class="notif-tab-content" style="display:none;">
                    <div class="admin-section">
                        <h2>All Alerts</h2>
                        <p style="color:var(--text-light);margin:0 0 20px 0;">Combined list of all sent and received alerts.</p>
                        <div class="table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Source/Recipient</th>
                                        <th>Title/Description</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-alerts-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
<script>
// Render All Alerts (combines sent and received)
function renderAllAlerts() {
    const sent = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
    const received = [];
    // Combine received from various sources
    try {
        const chats = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
        chats.forEach(c => received.push({
            type: 'Chat',
            source: c.userName || c.participantName || c.participantId || 'User',
            title: c.conversationTitle || 'Chat Message',
            date: c.lastMessageDate || c.timestamp || c.date || '',
            status: c.read ? 'Read' : 'Unread',
            actions: ''
        }));
        const reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
        reactions.forEach(r => received.push({
            type: 'Reaction',
            source: r.user || 'User',
            title: r.message || 'Post Reaction',
            date: r.date || '',
            status: r.read ? 'Read' : 'Unread',
            actions: ''
        }));
        const requests = JSON.parse(localStorage.getItem('propertyRequests') || '[]');
        requests.forEach(req => received.push({
            type: 'Property Request',
            source: req.user || req.email || 'User',
            title: req.message || req.request || 'Request',
            date: req.date || '',
            status: req.read ? 'Read' : 'Unread',
            actions: ''
        }));
        const contacts = JSON.parse(localStorage.getItem('contactMessages') || '[]');
        contacts.forEach(msg => received.push({
            type: 'Contact',
            source: msg.name || msg.email || 'User',
            title: msg.message || msg.subject || 'Contact Message',
            date: msg.date || '',
            status: msg.read ? 'Read' : 'Unread',
            actions: ''
        }));
        const attackers = JSON.parse(localStorage.getItem('systemAttackers') || '[]');
        attackers.forEach(a => received.push({
            type: 'Attacker',
            source: a.ip || a.user || 'Unknown',
            title: a.reason || 'Attack Attempt',
            date: a.date || '',
            status: a.status || 'Blocked',
            actions: ''
        }));
    } catch(e) {}
    // Combine sent and received
    const all = [];
    sent.forEach(s => all.push({
        type: 'Sent',
        source: s.recipient || s.to || 'User',
        title: s.title || s.message || 'Alert',
        date: s.sentAt || s.date || '',
        status: s.status || 'Sent',
        actions: ''
    }));
    received.forEach(r => all.push(r));
    // Sort by date descending if possible
    all.sort((a, b) => new Date(b.date) - new Date(a.date));
    const tbody = document.getElementById('all-alerts-tbody');
    if (!tbody) return;
    tbody.innerHTML = all.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#aaa;">No alerts found</td></tr>' :
        all.map(alert => `
            <tr>
                <td>${alert.type}</td>
                <td>${alert.source}</td>
                <td>${alert.title}</td>
                <td>${alert.date ? new Date(alert.date).toLocaleString() : ''}</td>
                <td>${alert.status}</td>
                <td>${alert.actions}</td>
            </tr>
        `).join('');
}
// Optionally render on load if All tab is default
document.addEventListener('DOMContentLoaded', function(){
    if(document.querySelector('.admin-notif-tab.active[data-tab="all"]')) renderAllAlerts();
});
</script>

                <!-- SENT TAB -->
                <div id="sent-content" class="notif-tab-content" style="display:block;">
                    <div class="admin-section">
                        <h2>Sent Alerts</h2>
                        <div class="table-wrapper">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Recipient</th>
                                        <th>Title</th>
                                        <th>Message</th>
                                        <th>Sent At</th>
                                        <th>Status</th>
                                        <th>Attachment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sent-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- REACTIONS & REPLIES TAB -->
                <div id="reactions-content" class="notif-tab-content" style="display:none;">
                    <div class="admin-section">
                        <!-- RECEIVED TAB -->
                        <div id="received-content" class="notif-tab-content" style="display:none;">
                            <div class="admin-section">
                                <h2>Received Alerts</h2>
                                <p style="color:var(--text-light);margin:0 0 20px 0;">All incoming alerts: chat, post reactions, property requests, contacts, and system attacker attempts.</p>
                                <div class="table-wrapper">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Source</th>
                                                <th>Description</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="received-alerts-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- CREATE ALERT TAB -->
                        <div id="create-content" class="notif-tab-content" style="display:none;">
                            <div class="admin-section" style="text-align:center;">
                                <h2>Create & Send Alert</h2>
                                <button class="btn-primary" onclick="openModal('sendMessage')" style="font-size:1.2rem;padding:18px 36px;margin-top:24px;">Open Send Notification Page</button>
                            </div>
                        </div>

            <!-- CHAT TAB -->
            <div id="chat" class="admin-tab" style="display: none;">
                <div class="dashboard-header">
                    <h1>Chat</h1>
                    <p>Direct messaging with users and agents</p>
                </div>
                <div class="admin-section" style="background:var(--white);padding:12px;border-radius:8px;box-shadow:var(--shadow);">
                    <div id="chat-section" style="display:flex;flex-direction:column;gap:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;flex-direction:column;">
                                <div style="font-size:18px;font-weight:700;">Conversations</div>
                                <div style="font-size:12px;color:var(--text-light);">Manage conversations with users and agents</div>
                            </div>
                            <div>
                                <button class="btn-sm" onclick="adminNewConversation()">+ New</button>
                            </div>
                        </div>

                        <div style="width:100%;">
                            <input id="admin-chat-search" placeholder="Search users or emails..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;" oninput="adminSearchUsers(this.value)">
                            <div id="admin-chat-search-results" style="display:none;background:var(--white);border:1px solid var(--border);border-top:none;max-height:220px;overflow:auto;margin-top:6px;border-radius:6px;position:relative;z-index:50;"></div>
                        </div>

                        <div id="admin-chats-list" style="width:100%;display:block;margin-top:8px;"></div>

                        <div id="chat-fullview" style="display:none;border-top:1px solid var(--border);padding-top:12px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                                <div>
                                    <button class="btn-sm" onclick="backToChatList()">‚Üê Back</button>
                                </div>
                                <div style="text-align:right;">
                                    <div id="chat-full-title" style="font-weight:700;"></div>
                                    <div id="chat-full-sub" style="font-size:12px;color:var(--text-light);"></div>
                                </div>
                            </div>
                            <div id="chat-full-messages" style="background:var(--lighter);padding:12px;border-radius:8px;min-height:240px;max-height:56vh;overflow:auto;margin-bottom:8px;"></div>
                            <div style="display:flex;gap:8px;">
                                <input id="chat-full-input" placeholder="Write a message..." style="flex:1;padding:10px;border:1px solid var(--border);border-radius:6px;" disabled>
                                <button class="btn-primary" onclick="sendAdminMessage()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="addProperty" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Property</h2>
                <button class="modal-close" onclick="closeModal('addProperty')">‚úï</button>
            </div>
            <form id="add-property-form">
                <input type="hidden" name="property-id" value="">
                <div class="form-group">
                    <label for="property-title">Property Title</label>
                    <input id="property-title" type="text" name="title" placeholder="e.g., Modern Apartment" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="property-type">Property Type</label>
                        <select id="property-type" name="type" required>
                            <option value="">Select type...</option>
                            <option>Apartment</option>
                            <option>House</option>
                            <option>Villa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="property-saleRent">For</label>
                        <select id="property-saleRent" name="saleRent" required>
                            <option value="sale">For Sale</option>
                            <option value="rent">For Rent</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="property-price">Price (‚Ç¨)</label>
                        <input id="property-price" type="number" name="price" placeholder="500000" required>
                    </div>
                    <div class="form-group">
                        <label for="property-location">Location</label>
                        <input id="property-location" type="text" name="location" placeholder="City, Country" required>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="property-area">Property Area (m¬≤)</label>
                        <input id="property-area" type="number" name="area" placeholder="e.g., 156" min="0">
                    </div>
                    <div class="form-group">
                        <label for="property-bedrooms">Bedrooms (optional)</label>
                        <input id="property-bedrooms" type="number" name="bedrooms" placeholder="e.g., 3" min="0">
                    </div>
                    <div class="form-group">
                        <label for="property-bathrooms">Bathrooms (optional)</label>
                        <input id="property-bathrooms" type="number" name="bathrooms" placeholder="e.g., 2" min="0">
                    </div>
                    <div class="form-group">
                        <label for="property-postTo">Post to</label>
                        <select id="property-postTo" name="postTo">
                            <option value="available">‚úÖ Available</option>
                            <option value="featured">‚≠ê Featured</option>
                            <option value="hot">üî• Hot</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="property-description">Property Description</label>
                    <textarea id="property-description" name="description" placeholder="Enter a detailed description for this property (shown on property detail page)" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label for="property-media">Upload Photos & Videos</label>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <input id="property-media" type="file" name="media" accept="image/*,video/*" multiple style="flex:1;min-width:200px;">
                        <button type="button" class="btn-sm edit" onclick="document.querySelector('#property-media').click();" style="white-space:nowrap;">üì∏ Browse Files</button>
                    </div>
                </div>
                <button class="btn-primary" type="submit">Save Property</button>
            </form>
        </div>
    </div>

    <div id="addAgent" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Agent</h2>
                <button class="modal-close" onclick="closeModal('addAgent')">‚úï</button>
            </div>
            <form>
                <div class="form-group">
                    <label for="agentName">Full Name</label>
                    <input type="text" id="agentName" name="agentName" placeholder="Agent Name" required>
                </div>
                <div class="form-group">
                    <label for="agentEmail">Email</label>
                    <input type="email" id="agentEmail" name="agentEmail" placeholder="agent@wispa.com" required>
                </div>
                <button class="btn-primary" type="submit">Add Agent</button>
            </form>
        </div>
    </div>

    <div id="sendMessage" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h2>Create Alert</h2>
                <button class="modal-close" onclick="closeModal('sendMessage')">‚úï</button>
            </div>
            <form id="send-notification-form" onsubmit="handleSendNotification(event)">
                <!-- 1. Recipient Type Selection -->
                <div class="form-group">
                    <label for="recipient-type">Select Recipients *</label>
                    <select id="recipient-type" onchange="updateRecipientOptions()" required style="padding:10px;border:1px solid var(--border);border-radius:4px;width:100%;font-size:14px;">
                        <option value="">-- Choose Recipient Type --</option>
                        <option value="all-users">üë• All Users</option>
                        <option value="agents">üè¢ All Agents</option>
                        <option value="single-user">üë§ A User</option>
                    </select>
                </div>

                <!-- User Search (Only shown when "A User" is selected) -->
                <div class="form-group" id="user-search-group" style="display:none;">
                    <label for="user-search-input">Search User (Email, Username, or ID)</label>
                    <div style="position:relative;">
                        <input type="text" id="user-search-input" placeholder="e.g., john@email.com or john_doe or user#123" autocomplete="off">
                        <div id="user-search-results" style="position:absolute;top:100%;left:0;right:0;background:var(--white);border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;display:none;z-index:100;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                    <input type="hidden" id="selected-user-id">
                    <div id="selected-user-display" style="margin-top:8px;padding:10px;background:var(--light);border-radius:4px;display:none;">
                        <strong>Selected:</strong> <span id="selected-user-text"></span>
                        <button type="button" class="btn-sm" style="float:right;background:#e74c3c;color:white;padding:4px 8px;" onclick="clearUserSelection()">‚úï</button>
                    </div>
                </div>

                <!-- 2. Notification Type Selection -->
                <div class="form-group">
                    <label for="notification-type">Notification Type *</label>
                    <select id="notification-type" onchange="updateNotificationContent()" required style="padding:10px;border:1px solid var(--border);border-radius:4px;width:100%;font-size:14px;">
                        <option value="">-- Select Notification Type --</option>
                        <option value="system">‚öôÔ∏è System Update</option>
                        <option value="announcement">üì¢ Announcement</option>
                        <option value="alert">üö® Important Alert</option>
                        <option value="property">üè† Property Notification</option>
                        <option value="promotion">üéâ Promotion</option>
                        <option value="maintenance">üîß Maintenance Notice</option>
                        <option value="security">üîê Security Alert</option>
                    </select>
                </div>

                <!-- 3. Message Content (Auto-populated) -->
                <div class="form-group">
                    <label for="notif-message">Message Content *</label>
                    <textarea id="notif-message" placeholder="Message will auto-populate based on notification type and recipient..." style="min-height:150px;padding:10px;border:1px solid var(--border);border-radius:4px;font-size:14px;" disabled></textarea>
                    <small style="color:var(--text-light);display:block;margin-top:5px;">Message will be automatically personalized for each recipient with their name.</small>
                </div>

                <!-- Attachment (Optional) -->
                <div class="form-group">
                    <label for="notif-file">Attachment (Optional)</label>
                    <input type="file" id="notif-file" accept=".pdf,.doc,.docx,.txt,.jpg,.png,.gif">
                    <small style="color:var(--text-light);">Maximum file size: 5MB</small>
                    <div id="file-preview" style="margin-top:8px;display:none;">
                        <strong>Selected file:</strong> <span id="file-name"></span>
                        <button type="button" class="btn-sm" style="float:right;background:#e74c3c;color:white;padding:4px 8px;" onclick="clearFileSelection()">‚úï</button>
                    </div>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button type="button" class="btn-sm" style="background:#95a5a6;color:white;" onclick="closeModal('sendMessage')">Cancel</button>
                    <button type="submit" class="btn-primary">üì® Send Alert</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Document Modal -->
    <div id="viewDocModal" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h2>Property Document</h2>
                <button class="modal-close" onclick="closeModal('viewDocModal')">‚úï</button>
            </div>
            <div style="padding:16px;">
                <div style="margin-bottom:8px;color:var(--text-light);">You can view the generated property document below. Use the Download button to save it locally.</div>
                <div id="view-doc-content" style="background:#fff;color:#222;padding:18px;border-radius:8px;max-height:64vh;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;font-size:14px;"></div>
                <div style="margin-top:12px;text-align:right;">
                    <button id="download-doc-btn" class="btn-primary">Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="viewMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Message</h2>
                <button class="modal-close" onclick="closeModal('viewMessageModal')">‚úï</button>
            </div>
            <div style="padding:16px;">
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px;">
                    <div>
                        <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;">Name</label>
                        <div id="msg-name" style="font-size:16px;margin-top:4px;color:var(--text);">-</div>
                    </div>
                    <div>
                        <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;">Email</label>
                        <div id="msg-email" style="font-size:16px;margin-top:4px;color:var(--text);">-</div>
                    </div>
                    <div>
                        <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;">Phone</label>
                        <div id="msg-phone" style="font-size:16px;margin-top:4px;color:var(--text);">-</div>
                    </div>
                    <div>
                        <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;">Date</label>
                        <div id="msg-date" style="font-size:16px;margin-top:4px;color:var(--text);">-</div>
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;">Subject</label>
                    <div id="msg-subject" style="font-size:16px;margin-top:4px;color:var(--text);">-</div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;display:block;margin-bottom:8px;">Message</label>
                    <div id="msg-content" style="background:var(--lighter);padding:12px;border-radius:4px;color:var(--text);line-height:1.6;">-</div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn-sm edit" onclick="replyToMessage()" style="background:#3498db;color:white;">‚úâÔ∏è Reply via Email</button>
                    <button class="btn-sm delete" onclick="deleteMessage()" style="background:#e74c3c;color:white;">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
    // === ADMIN NOTIFICATIONS MANAGEMENT ===
    function switchNotificationTab(tabName) {
        // Ensure switchNotificationTab is globally available for inline onclick
        if (typeof window !== 'undefined') window.switchNotificationTab = switchNotificationTab;
        // Hide all tabs
        document.querySelectorAll('.notif-tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        // Remove active class from buttons
        document.querySelectorAll('.admin-notif-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        // Show selected tab
        const contentId = tabName + '-content';
        const tabContent = document.getElementById(contentId);
        if (tabContent) {
            tabContent.style.display = 'block';
        }
        // Add active class to button
        // If called from click, event.target is the button; otherwise, find the button
        let btn = null;
        if (event && event.target && event.target.classList.contains('admin-notif-tab')) {
            btn = event.target;
        } else {
            btn = document.querySelector('.admin-notif-tab[data-tab="' + tabName + '"]');
        }
        if (btn) btn.classList.add('active');
        // Render All Alerts if needed
        if(tabName === 'all') renderAllAlerts();
    }
    // Optionally render on load if All tab is default
    document.addEventListener('DOMContentLoaded', function(){
        if(document.querySelector('.admin-notif-tab.active[data-tab="all"]')) renderAllAlerts();
    });
    </script>
    <script>
        // Ensure badge updates on page load
        if(document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if(window.updateNavUnreadCounts) {
                    setTimeout(() => window.updateNavUnreadCounts(), 100);
                }
                // Initialize alerts with 'All' filter
                setTimeout(() => {
                    if(window.filterNotificationAlerts) {
                        window.filterNotificationAlerts('all');
                    }
                }, 150);
            });
        } else {
            if(window.updateNavUnreadCounts) {
                setTimeout(() => window.updateNavUnreadCounts(), 100);
            }
            // Initialize alerts with 'All' filter
            setTimeout(() => {
                if(window.filterNotificationAlerts) {
                    window.filterNotificationAlerts('all');
                }
            }, 150);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => tab.style.display = 'none');
            const activeTab = document.getElementById(tabName);
            if (activeTab) activeTab.style.display = 'block';
            document.querySelectorAll('.admin-menu a').forEach(link => link.classList.remove('active'));
            const selector = `.admin-menu a[href="#${tabName}"]`;
            const link = document.querySelector(selector);
            if (link) link.classList.add('active');

            // Persist current tab in localStorage
            try { localStorage.setItem('adminCurrentTab', tabName); } catch(e){}

            // Update hash for consistency
            if (window.location.hash !== '#' + tabName) {
                window.location.hash = '#' + tabName;
            }

            // Refresh alert stats when switching to alerts tab
            if (tabName === 'alerts') {
                getAlertStats();
                renderAlertsTable();
            }

            // Refresh property documents when switching to documents tab
            if (tabName === 'documents') {
                if (typeof renderPropertyDocuments === 'function') {
                    renderPropertyDocuments();
                }
            }

            // Also refresh alert stats on overview tab for dashboard display
            if (tabName === 'overview') {
                if (typeof getAlertStats === 'function') {
                    getAlertStats();
                }
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }

        // === NOTIFICATION SENDING FUNCTIONS ===
        let allUsers = []; // Cache for users
        
        function loadAllUsers() {
            // Get all users from the system
            const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
            const users = [];
            
            // Add current logged-in user
            if (wispaUser && wispaUser.username) {
                users.push({
                    id: 'user-' + Date.now(),
                    username: wispaUser.username,
                    email: wispaUser.email || '',
                    avatar: wispaUser.avatar || '',
                    storageKey: 'wispaUser'
                });
            }
            
            // In a real system, you'd fetch all users from a database
            // For now, we'll allow searching by any identifier
            return users;
        }
        
        // Restore original flexible search used by notification user picker (allows custom entries)
        function searchUsers(query) {
            if (!query || !query.trim()) return [];
            const results = [];
            const queryLower = query.toLowerCase();
            // Check wispaUser
            const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
            if (wispaUser && (wispaUser.email?.toLowerCase().includes(queryLower) || wispaUser.username?.toLowerCase().includes(queryLower))) {
                results.push({ id: wispaUser.email || wispaUser.username, username: wispaUser.username, email: wispaUser.email, avatar: wispaUser.avatar || 'üë§', type: 'user' });
            }
            // Allow admin to enter any email or username for notification
            results.push({ id: query, username: query.includes('@') ? query.split('@')[0] : query, email: query.includes('@') ? query : '', avatar: 'üì®', type: 'custom' });
            return results;
        }

        // Separate function that searches only registered users (used by chat search)
        function searchRegisteredUsers(query){
            if(!query || !query.trim()) return [];
            const q = query.trim().toLowerCase();
            const results = [];
            // Load users directly from localStorage to avoid depending on loadUsers()
            let users = JSON.parse(localStorage.getItem('users') || 'null');
            if(!users || !Array.isArray(users)) users = [];
            users.forEach(u=>{
                const email = (u.email||'').toLowerCase();
                const name = (u.name||u.username||'').toLowerCase();
                if(email.includes(q) || name.includes(q)){
                    results.push({ id: u.email || u.id || u.username, username: u.name || u.username || u.email, email: u.email || '' });
                }
            });
            try{
                const wispa = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                if(wispa && (wispa.email || wispa.username)){
                    const ident = (wispa.email||wispa.username||'').toLowerCase();
                    if(ident.includes(q)){
                        results.push({ id: wispa.email || wispa.username, username: wispa.username || ident, email: wispa.email || '' });
                    }
                }
            }catch(e){}
            return results;
        }
        
        // Setup user search listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('user-search-input');
            const searchResults = document.getElementById('user-search-results');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    if (!query) {
                        searchResults.style.display = 'none';
                        return;
                    }
                    
                    const results = searchUsers(query);
                    if (results.length === 0) {
                        searchResults.innerHTML = '<div style="padding:10px;color:var(--text-light);">No users found</div>';
                        searchResults.style.display = 'block';
                        return;
                    }
                    
                    searchResults.innerHTML = results.map(user => `
                        <div style="padding:10px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.2s;" 
                             onmouseover="this.style.background='var(--light)'" 
                             onmouseout="this.style.background='transparent'"
                             onclick="selectUser('${user.id}', '${user.email || user.username}', '${user.username}'); updateNotificationContent();">
                            <div style="display:flex;gap:10px;align-items:center;">
                                <span style="font-size:24px;">${user.avatar}</span>
                                <div>
                                    <div style="font-weight:600;color:var(--text);">${user.username}</div>
                                    ${user.email ? `<div style="font-size:12px;color:var(--text-light);">${user.email}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    searchResults.style.display = 'block';
                });
            }
        });
        
        function selectUser(userId, email, username) {
            document.getElementById('selected-user-id').value = userId;
            document.getElementById('user-search-input').value = '';
            document.getElementById('user-search-results').style.display = 'none';
            document.getElementById('selected-user-display').style.display = 'block';
            document.getElementById('selected-user-text').textContent = `${username}${email ? ` (${email})` : ''}`;
            updateNotificationContent();
        }
        
        function clearUserSelection() {
            document.getElementById('selected-user-id').value = '';
            document.getElementById('user-search-input').value = '';
            document.getElementById('selected-user-display').style.display = 'none';
            document.getElementById('user-search-results').style.display = 'none';
        }
        
        function clearFileSelection() {
            document.getElementById('notif-file').value = '';
            document.getElementById('file-preview').style.display = 'none';
        }

        // === NEW RECIPIENT TYPE SYSTEM ===
        function updateRecipientOptions() {
            const recipientType = document.getElementById('recipient-type').value;
            const userSearchGroup = document.getElementById('user-search-group');
            const selectedUserDisplay = document.getElementById('selected-user-display');
            
            if (recipientType === 'single-user') {
                userSearchGroup.style.display = 'block';
            } else {
                userSearchGroup.style.display = 'none';
                selectedUserDisplay.style.display = 'none';
                clearUserSelection();
            }
            
            // Clear notification content when recipient changes
            document.getElementById('notification-type').value = '';
            document.getElementById('notif-message').value = '';
        }

        // === NOTIFICATION TYPE TEMPLATES ===
        const notificationTemplates = {
            'system': {
                title: 'System Update',
                content: (recipientName) => `Dear ${recipientName},\n\nWe have completed important system maintenance and updates to improve your experience. Our platform is now running at optimal performance.\n\nThank you for your patience.\n\nBest regards,\nWispa Real Estate Team`
            },
            'announcement': {
                title: 'Important Announcement',
                content: (recipientName) => `Hello ${recipientName},\n\nWe are excited to share important news with our community. This update will enhance your experience and provide valuable new features.\n\nStay tuned for more updates!\n\nBest regards,\nWispa Real Estate Team`
            },
            'alert': {
                title: 'Important Alert',
                content: (recipientName) => `Alert for ${recipientName},\n\nPlease take note of this important information. Your immediate attention may be required.\n\nFor more details, please log in to your account.\n\nBest regards,\nWispa Real Estate Team`
            },
            'property': {
                title: 'Property Notification',
                content: (recipientName) => `Dear ${recipientName},\n\nWe have an exciting property update for you! Based on your interests and preferences, we found something that matches your criteria.\n\nVisit your dashboard to explore this opportunity.\n\nBest regards,\nWispa Real Estate Team`
            },
            'promotion': {
                title: 'Special Promotion',
                content: (recipientName) => `Hi ${recipientName},\n\nExclusive offer just for you! We have a special promotion running that you might be interested in.\n\nDon't miss out on this limited-time offer!\n\nBest regards,\nWispa Real Estate Team`
            },
            'maintenance': {
                title: 'Scheduled Maintenance',
                content: (recipientName) => `Dear ${recipientName},\n\nWe will be performing scheduled maintenance on our platform. During this time, services may be temporarily unavailable.\n\nThank you for your understanding.\n\nBest regards,\nWispa Real Estate Team`
            },
            'security': {
                title: 'Security Alert',
                content: (recipientName) => `Alert for ${recipientName},\n\nFor your security, please review your account activity. If you notice any unauthorized access, please change your password immediately.\n\nYour account safety is our priority.\n\nBest regards,\nWispa Real Estate Security Team`
            }
        };

        function updateNotificationContent() {
            const notificationType = document.getElementById('notification-type').value;
            const recipientType = document.getElementById('recipient-type').value;
            const messageField = document.getElementById('notif-message');
            
            if (!notificationType || !recipientType) {
                messageField.value = '';
                return;
            }
            
            // Get recipient name(s)
            let recipientName = 'User';
            
            if (recipientType === 'all-users') {
                recipientName = 'All Users';
            } else if (recipientType === 'agents') {
                recipientName = 'All Agents';
            } else if (recipientType === 'single-user') {
                const selectedText = document.getElementById('selected-user-text').textContent;
                if (selectedText) {
                    recipientName = selectedText.split('(')[0].trim();
                } else {
                    messageField.value = 'Please select a user first';
                    return;
                }
            }
            
            // Get template and generate message
            const template = notificationTemplates[notificationType];
            if (template) {
                messageField.value = template.content(recipientName);
            }
        }
        
        function handleSendNotification(event) {
            event.preventDefault();
            
            const recipientType = document.getElementById('recipient-type').value;
            const notificationType = document.getElementById('notification-type').value;
            const message = document.getElementById('notif-message').value;
            const fileInput = document.getElementById('notif-file');
            
            if (!recipientType || !notificationType || !message) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Determine recipients
            let recipients = [];
            
            if (recipientType === 'all-users') {
                // Get all users from localStorage
                const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                if (wispaUser && wispaUser.email) {
                    recipients.push({
                        id: wispaUser.email,
                        email: wispaUser.email,
                        username: wispaUser.username,
                        type: 'user'
                    });
                }
            } else if (recipientType === 'agents') {
                // Get all agents
                const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                if (wispaUser && wispaUser.role === 'agent') {
                    recipients.push({
                        id: wispaUser.email,
                        email: wispaUser.email,
                        username: wispaUser.username,
                        type: 'agent'
                    });
                }
            } else if (recipientType === 'single-user') {
                const userId = document.getElementById('selected-user-id').value;
                const selectedText = document.getElementById('selected-user-text').textContent;
                if (!userId) {
                    alert('Please select a user');
                    return;
                }
                recipients.push({
                    id: userId,
                    email: userId.includes('@') ? userId : '',
                    username: selectedText.split('(')[0].trim(),
                    type: 'user'
                });
            }
            
            if (recipients.length === 0) {
                alert('No recipients found for the selected type');
                return;
            }
            
            // Get template title
            const template = notificationTemplates[notificationType];
            const title = template.title;
            
            // Process file if exists
            let fileData = null;
            let totalNotificationsToSend = recipients.length;
            let sentCount = 0;
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size exceeds 5MB limit');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    
                    // Send notifications with file
                    recipients.forEach(recipient => {
                        const notification = {
                            id: 'admin-notif-' + Date.now() + '-' + Math.random(),
                            type: 'admin',
                            title: title,
                            message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                            fullMessage: message,
                            timestamp: new Date().toISOString(),
                            read: false,
                            targetUser: recipient.id,
                            sentBy: 'Admin',
                            notificationType: notificationType,
                            file: fileData,
                            details: {
                                'From': 'Administrator',
                                'Sent': new Date().toLocaleString(),
                                'Priority': 'Important'
                            }
                        };
                        saveNotificationToUser(recipient.id, notification);
                        sentCount++;
                        
                        // If all notifications sent, finish up
                        if (sentCount === totalNotificationsToSend) {
                            completeNotificationSend(recipientType, totalNotificationsToSend);
                        }
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // Send notifications without file
                recipients.forEach(recipient => {
                    const notification = {
                        id: 'admin-notif-' + Date.now() + '-' + Math.random(),
                        type: 'admin',
                        title: title,
                        message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                        fullMessage: message,
                        timestamp: new Date().toISOString(),
                        read: false,
                        targetUser: recipient.id,
                        sentBy: 'Admin',
                        notificationType: notificationType,
                        file: null,
                        details: {
                            'From': 'Administrator',
                            'Sent': new Date().toLocaleString(),
                            'Priority': 'Important'
                        }
                    };
                    saveNotificationToUser(recipient.id, notification);
                    sentCount++;
                    
                    // If all notifications sent, finish up
                    if (sentCount === totalNotificationsToSend) {
                        completeNotificationSend(recipientType, totalNotificationsToSend);
                    }
                });
            }
        }
        
        function completeNotificationSend(recipientType, count) {
            let recipientLabel = recipientType === 'all-users' ? 'all users' : 
                                recipientType === 'agents' ? 'all agents' : 'the selected user';
            
            // Reset form
            document.getElementById('send-notification-form').reset();
            clearUserSelection();
            clearFileSelection();
            document.getElementById('recipient-type').value = '';
            document.getElementById('notification-type').value = '';
            document.getElementById('user-search-group').style.display = 'none';
            document.getElementById('notif-message').value = '';
            
            // Close modal
            closeModal('sendMessage');
            
            // Show success message
            alert('‚úÖ Alert sent successfully to ' + recipientLabel + '!\\n\\nTotal notifications sent: ' + count);
            
            // Refresh sent notifications if on that tab
            if (document.getElementById('sent-content') && document.getElementById('sent-content').style.display !== 'none') {
                loadSentNotifications();
            }
        }
        
        function saveNotificationToUser(userId, notification) {
                    // Try to persist notification to backend; fallback to localStorage
                    (async function(){
                        try {
                            await fetch('/api/notifications', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId: userId, notification: notification })
                            });
                        } catch (e) {
                            // fallback: keep existing localStorage behavior
                            try {
                                const currentUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                                if (currentUser && (currentUser.email === userId || currentUser.username === userId || currentUser.id === userId)) {
                                    const key = 'notifications_' + userId;
                                    const userNotifications = JSON.parse(localStorage.getItem(key) || '[]');
                                    userNotifications.push(notification);
                                    localStorage.setItem(key, JSON.stringify(userNotifications));
                                    try { localStorage.setItem('notifications_signal_' + userId, String(Date.now())); } catch(e){}
                                } else {
                                    const pendingKey = 'pendingUserNotifications';
                                    const pendingNotifications = JSON.parse(localStorage.getItem(pendingKey) || '{}');
                                    if (!pendingNotifications[userId]) pendingNotifications[userId] = [];
                                    pendingNotifications[userId].push(notification);
                                    localStorage.setItem(pendingKey, JSON.stringify(pendingNotifications));
                                }
                            } catch (err) { console.warn('Failed to persist notification locally', err); }
                        }

                        // Also record the sent notification in admin sent-notifications history (best-effort)
                        try {
                            await fetch('/api/admin/sent-notifications', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ to: userId, title: notification.title || '', message: notification.fullMessage || notification.message || '' })
                            });
                        } catch (e) { /* ignore */ }
                    })();
            
            // Track sent notification in admin panel
            let adminSentNotifications = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
            const sentRecord = {
                id: 'sent-' + Date.now(),
                targetUser: userId,
                title: notification.title,
                message: notification.message,
                fullMessage: notification.fullMessage || notification.message,
                timestamp: new Date(),
                read: wispaUser && (wispaUser.email === userId || wispaUser.username === userId),
                file: notification.file || null
            };
            adminSentNotifications.push(sentRecord);
            localStorage.setItem('adminSentNotifications', JSON.stringify(adminSentNotifications));

            // Also create a conversation / chat message for the target user so it shows in their chat list
            try {
                const convId = 'admin-' + (notification.id || Date.now());
                const msg = {
                    sender: 'admin',
                    text: notification.fullMessage || notification.message || notification.title || '',
                    ts: Date.now()
                };

                // If the recipient is the currently logged-in user (on this tab), write directly to their conversation storage
                if (wispaUser && (wispaUser.email === userId || wispaUser.username === userId)) {
                    const convsKey = 'conversations_' + userId;
                    const convs = JSON.parse(localStorage.getItem(convsKey) || '[]');
                    const existing = convs.find(c => c.id === convId);
                    const now = Date.now();
                    if (existing) {
                        existing.last = String(msg.text).slice(0, 140);
                        existing.updated = now;
                        existing.unread = (existing.unread || 0) + 1;
                    } else {
                        convs.unshift({ id: convId, agent: 'Administrator', last: String(msg.text).slice(0,140), unread: 1, updated: now });
                    }
                    localStorage.setItem(convsKey, JSON.stringify(convs));

                    // Save the conversation messages under the per-conversation key
                    const convKey = 'wispaMessages_' + userId + '_' + convId;
                    const list = JSON.parse(localStorage.getItem(convKey) || '[]');
                    list.push(msg);
                    localStorage.setItem(convKey, JSON.stringify(list));

                    // Also record as unread chatNotification so admin chat nav shows badge
                    const chatNotifs = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                    const chatIdx = chatNotifs.findIndex(c => c.id === convId);
                    const chatEntry = {
                        id: convId,
                        userName: 'User',
                        conversationTitle: 'Notification',
                        lastMessage: String(msg.text).slice(0, 100),
                        timestamp: new Date(msg.ts).toISOString(),
                        read: false
                    };
                    if(chatIdx > -1) chatNotifs[chatIdx] = chatEntry; else chatNotifs.unshift(chatEntry);
                    localStorage.setItem('chatNotifications', JSON.stringify(chatNotifs));

                    // signal other tabs and trigger badge update in this tab
                    try { localStorage.setItem('wispaMessageSignal_' + userId, String(Date.now())); } catch(e){}
                    if(window.updateNavUnreadCounts) window.updateNavUnreadCounts();
                } else {
                    // For other (offline) users, record pending conversations so they'll be processed on login
                    const pendingConvs = JSON.parse(localStorage.getItem('pendingUserConversations') || '{}');
                    if (!pendingConvs[userId]) pendingConvs[userId] = [];
                    pendingConvs[userId].push({ id: convId, agent: 'Administrator', last: String(msg.text).slice(0,140), unread: 1, updated: Date.now(), messages: [msg] });
                    localStorage.setItem('pendingUserConversations', JSON.stringify(pendingConvs));
                    // Trigger badge update
                    if(window.updateNavUnreadCounts) window.updateNavUnreadCounts();
                }
            } catch (e) {
                console.error('Error creating admin conversation for user', e);
            }
            
            // Track activity
            let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
            activityLog.push({
                type: 'admin-notification-sent',
                targetUser: userId,
                title: notification.title,
                timestamp: new Date().toISOString(),
                details: `Alert sent to ${userId}`
            });
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        function switchAlertTab(tabName){
            document.querySelectorAll('.alert-tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.style.borderBottomColor = 'transparent');
            const tabId = 'alert-' + tabName + '-tab';
            const tab = document.getElementById(tabId);
            if(tab) tab.style.display = 'block';
            if(event && event.target) event.target.style.borderBottomColor = 'var(--primary)';
            
            // Load notification alerts if in create tab
            if(tabName === 'create') {
                setTimeout(() => filterNotificationAlerts('all'), 50);
            }
        }

        // === NOTIFICATION ALERTS FUNCTIONS ===
        function filterNotificationAlerts(filterType) {
            // Update active button styling
            document.querySelectorAll('.admin-notif-tab').forEach(btn => {
                btn.style.background = btn.dataset.filter === filterType ? '#3498db' : '#95a5a6';
            });

            const tbody = document.getElementById('notification-alerts-tbody');
            if (!tbody) return;

            const notifications = [];

            // Helper to normalize date
            const normDate = (obj) => {
                if (!obj) return new Date(0);
                const d = obj.timestamp || obj.date || obj.ts || obj.time || obj.created || obj.sent || obj.timestamp;
                if (!d) return new Date(0);
                return new Date(d);
            };

            // CHATS: simple message notifications
            if (filterType === 'all' || filterType === 'chats') {
                const chats = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                chats.forEach(chat => notifications.push({
                    type: 'üí¨ Message',
                    source: 'Conversation',
                    description: `User ${chat.userName || chat.participantName || chat.user || 'User'} sent you a message`,
                    date: chat.timestamp || chat.date || chat.ts || new Date().toISOString(),
                    status: chat.read ? '‚úì Read' : '‚ö† Unread',
                    originalData: chat
                }));
            }

            // INBOX: property requests (scan property conversation keys)
            if (filterType === 'all' || filterType === 'inbox') {
                for (let i = 0; i < localStorage.length; i++){
                    const key = localStorage.key(i);
                    if(!key) continue;
                    if(/^wispaMessages_[^_]+_property-/.test(key)){
                        try{
                            const msgs = JSON.parse(localStorage.getItem(key) || '[]');
                            if(!Array.isArray(msgs) || msgs.length === 0) continue;
                            const last = msgs[msgs.length-1];
                            const userMsg = msgs.find(m => (m.sender === 'user' || m.from === 'user')) || last;
                            const match = key.match(/^wispaMessages_(.+?)_property-(.+)$/);
                            const propertyId = match ? match[2] : '';
                            notifications.push({
                                type: 'üì¨ Property Request',
                                source: 'Property Chat',
                                description: `${userMsg.userName || userMsg.name || 'User'} requested information about property ${propertyId}`,
                                date: last.ts ? new Date(last.ts).toISOString() : (last.timestamp || last.date || new Date().toISOString()),
                                status: userMsg.read ? '‚úì Read' : '‚ö† Unread',
                                originalData: { key, messages: msgs }
                            });
                        }catch(e){/* ignore parse errors */}
                    }
                }
            }

            // CONTACTS: contact form messages
            if (filterType === 'all' || filterType === 'contacts') {
                const contacts = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                contacts.forEach(contact => notifications.push({
                    type: '‚úâÔ∏è Contact',
                    source: 'Contact Form',
                    description: contact.subject || contact.message || 'Contact message',
                    date: contact.date || contact.timestamp || new Date().toISOString(),
                    status: contact.read ? '‚úì Read' : '‚ö† Unread',
                    originalData: contact
                }));
            }

            // POST: likes, admin posts, and activity related to posts
            if (filterType === 'all' || filterType === 'post') {
                const reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
                reactions.forEach(reaction => notifications.push({
                    type: 'üëç Like',
                    source: 'Post Like',
                    description: `${reaction.userName || 'User'} liked your post: ${reaction.postTitle || reaction.notificationTitle || 'Post'}`,
                    date: reaction.timestamp || reaction.date || new Date().toISOString(),
                    status: reaction.read ? '‚úì Read' : '‚ö† Unread',
                    originalData: reaction
                }));

                const sentNotifications = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                sentNotifications.filter(s => s.notificationType === 'property' || s.notificationType === 'post').forEach(notif => notifications.push({
                    type: 'üì∞ Post Notification',
                    source: 'Admin Post',
                    description: notif.title || notif.message || 'Post action',
                    date: notif.timestamp || notif.date || new Date().toISOString(),
                    status: notif.read ? '‚úì Read' : '‚ö† Unread',
                    originalData: notif
                }));

                try{
                    const activity = JSON.parse(localStorage.getItem('activityLog') || '[]');
                    activity.forEach(a => {
                        if(a && typeof a.type === 'string' && /post|property|admin-post|post-created|post-edit/i.test(a.type)){
                            notifications.push({
                                type: 'üì∞ Post Activity',
                                source: 'Activity Log',
                                description: a.title || a.details || a.type,
                                date: a.timestamp || a.date || new Date().toISOString(),
                                status: a.read ? '‚úì Read' : '‚ö† Unread',
                                originalData: a
                            });
                        }
                    });
                }catch(e){}
            }

            // sort by normalized date desc
            notifications.sort((a,b)=> new Date(b.date || b.timestamp || b.ts) - new Date(a.date || a.timestamp || a.ts));

            // render
            tbody.innerHTML = '';
            if (notifications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No notifications found.</td></tr>';
                return;
            }

            notifications.forEach(function(notif, index) {
                const dateObj = new Date(notif.date || notif.timestamp || notif.ts || Date.now());
                const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${notif.type}</td>
                    <td>${notif.source}</td>
                    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${notif.description}</td>
                    <td>${dateStr}</td>
                    <td>${notif.status || ''}</td>
                    <td>
                        <button class="btn-sm edit" onclick="viewNotificationAlert('${filterType}', ${index})">View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewNotificationAlert(filterType, index) {
            const notifications = [];

            // Build same aggregated list as filterNotificationAlerts so indices match
            if (filterType === 'all' || filterType === 'chats') {
                const chats = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                chats.forEach(n => notifications.push(Object.assign({ _type: 'chat', date: n.timestamp || n.date || n.ts }, n)));
            }
            if (filterType === 'all' || filterType === 'inbox') {
                for (let i = 0; i < localStorage.length; i++){
                    const key = localStorage.key(i);
                    if(!key) continue;
                    if(/^wispaMessages_[^_]+_property-/.test(key)){
                        try{
                            const msgs = JSON.parse(localStorage.getItem(key) || '[]');
                            if(!Array.isArray(msgs) || msgs.length === 0) continue;
                            const last = msgs[msgs.length-1];
                            notifications.push(Object.assign({ _type: 'property', date: last.ts || last.timestamp || last.date }, { key, messages: msgs }));
                        }catch(e){}
                    }
                }
            }
            if (filterType === 'all' || filterType === 'contacts') {
                const contacts = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                contacts.forEach(n => notifications.push(Object.assign({ _type: 'contact', date: n.timestamp || n.date }, n)));
            }
            if (filterType === 'all' || filterType === 'post') {
                const reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
                reactions.forEach(n => notifications.push(Object.assign({ _type: 'reaction', date: n.timestamp || n.date }, n)));
                const sent = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]').filter(s => s.notificationType === 'property' || s.notificationType === 'post');
                sent.forEach(n => notifications.push(Object.assign({ _type: 'post', date: n.timestamp || n.date }, n)));
                try{ const activity = JSON.parse(localStorage.getItem('activityLog') || '[]'); activity.filter(a => a && typeof a.type === 'string' && /post|property|admin-post|post-created|post-edit/i.test(a.type)).forEach(n => notifications.push(Object.assign({ _type: 'activity', date: n.timestamp || n.date }, n))); }catch(e){}
            }

            notifications.sort((a,b)=> new Date(b.date || b.timestamp || b.ts) - new Date(a.date || a.timestamp || a.ts));

            if (index < 0 || index >= notifications.length) return;
            const notif = notifications[index];
            const content = JSON.stringify(notif, null, 2);
            alert(`Notification Details\n\nType: ${notif._type || 'notification'}\nDate: ${notif.date || notif.timestamp || notif.ts}\n\nContent:\n${content.substring(0, 1000)}`);
        }
        

        // === PROPERTY DOCUMENT FUNCTIONS (Global Scope) ===
        function loadPropertyDocs(){
            return JSON.parse(localStorage.getItem('propertyDocs')||'[]');
        }

        function savePropertyDocs(docs){
            localStorage.setItem('propertyDocs', JSON.stringify(docs));
        }

        function generatePropertyDocument(property){
            const doc = {
                id: `doc-${property.id}-${Date.now()}`,
                propertyId: property.id,
                title: `Property Document - ${property.title}`,
                type: 'property',
                propertyTitle: property.title,
                propertyType: property.type,
                location: property.location,
                price: property.price,
                area: property.area,
                bedrooms: property.bedrooms != null ? property.bedrooms : null,
                bathrooms: property.bathrooms != null ? property.bathrooms : null,
                postTo: property.postTo,
                saleRent: property.saleRent,
                generated: new Date().toLocaleString(),
                format: 'pdf',
                size: Math.round(Math.random()*200 + 50) + ' KB'
            };
            let docs = loadPropertyDocs();
            docs.unshift(doc);
            savePropertyDocs(docs);
            return doc;
        }

        function viewPropertyDoc(docId){
            const docs = loadPropertyDocs();
            const doc = docs.find(d=>d.id === docId);
            if(!doc) return;
            
            const docDate = new Date();
            const certNo = `WISPA-CERT-${doc.propertyId}-${String(Date.now()).slice(-6)}`;
            
            const content = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                            ‚ïë
‚ïë                    üè† WISPA REAL ESTATE PLATFORM üè†                       ‚ïë
‚ïë                                                                            ‚ïë
‚ïë                  OFFICIAL PROPERTY OWNERSHIP CERTIFICATE                   ‚ïë
‚ïë                                                                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

COMPANY INFORMATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Company Name:          WISPA Real Estate Platform
Registration No.:      WISPA-2024-EU-001
License:               EU Real Estate License #WRP-2024-001
Headquarters:          European Union, EU
Platform URL:          www.wispa-realestate.com
Contact:               support@wispa.com
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

CERTIFICATE INFORMATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Certificate Number:    ${certNo}
Issue Date:            ${docDate.toLocaleDateString()} ${docDate.toLocaleTimeString()}
Document ID:           ${doc.id}
Validity:              Perpetual (Linked to Property Registry)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

PROPERTY DETAILS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Property Title:        ${doc.propertyTitle}
Property Type:         ${doc.propertyType}
Location:              ${doc.location}
Property Area:         ${doc.area ? doc.area + ' m¬≤' : 'Not Specified'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

TRANSACTION INFORMATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Transaction Type:      ${doc.saleRent === 'sale' ? 'SALE' : 'LEASE/RENTAL'}
Listed Price:          ‚Ç¨${doc.price.toLocaleString()}
Listing Category:      ${doc.postTo.toUpperCase()}  ${
                            doc.postTo === 'hot' ? 'üî•' : 
                            doc.postTo === 'featured' ? '‚≠ê' : '‚úÖ'
                        }
Listing Status:        ACTIVE & VERIFIED
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

OWNERSHIP DECLARATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

This document certifies that the above-described property has been registered
and verified on the WISPA Real Estate Platform. The property details have been
independently verified and cross-referenced with official property records.

This certificate serves as formal proof of:
  ‚úì Property Registration on WISPA Platform
  ‚úì Ownership Verification
  ‚úì Legal Listing Confirmation
  ‚úì Transaction Eligibility

WISPA Platform maintains all property documentation and transaction records in
accordance with EU Real Estate Guidelines and GDPR regulations.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

OFFICIAL SEAL:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                    ‚ïë   üîê WISPA VERIFIED‚Ñ¢ üîê    ‚ïë
                    ‚ïë   OFFICIAL DOCUMENT         ‚ïë
                    ‚ïë   [Digitally Signed]        ‚ïë
                    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

IMPORTANT NOTICE:
This document is an official publication of WISPA Real Estate Platform and
serves as digital proof of ownership and property registration. Unauthorized
reproduction or modification is prohibited by law.

For verification, contact: legal@wispa.com

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  WISPA Real Estate - Trusted by Thousands | Securing Your Property Future ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;
            // Build a styled HTML view for the document and show it in the modal
            const viewEl = document.getElementById('view-doc-content');
            if (viewEl) {
                const html = `
                    <style>
                        .doc-container{background:#fff;max-width:794px;margin:8px auto;padding:36px;border:1px solid #f0f0f0;box-shadow:0 10px 30px rgba(11,61,145,0.06);position:relative;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;color:#222}
                        .doc-watermark{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);opacity:0.06;font-size:96px;color:#0b3d91;pointer-events:none;font-weight:800}
                        .doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
                        .doc-title{ text-align:center;margin:6px 0 18px}
                        .doc-grid{display:flex;gap:22px;align-items:flex-start}
                        .doc-left{flex:1;padding:6px 0}
                        .doc-right{width:320px;flex-shrink:0;border-left:1px solid #f3f3f3;padding-left:18px}
                        .doc-footer{display:flex;justify-content:space-between;align-items:flex-end;margin-top:24px}
                        @media (max-width:720px){
                            .doc-container{padding:18px}
                            .doc-watermark{font-size:56px;top:52%}
                            .doc-header{flex-direction:column;align-items:flex-start}
                            .doc-grid{flex-direction:column}
                            .doc-right{width:100%;border-left:none;padding-left:0;border-top:1px solid #f3f3f3;padding-top:12px;margin-top:10px}
                        }
                    </style>
                    <div class="doc-container">
                        <div class="doc-watermark" style="font-size:60px; text-align:center;">WISPA Real Estate</div>
                        <div class="doc-header">
                            <div>
                                <div style="font-weight:800;font-size:20px;color:#0b3d91;letter-spacing:0.4px;">WISPA Real Estate</div>
                                <div style="font-size:12px;color:#666;margin-top:6px;">Seller / Registrar ‚Ä¢ EU Registration: WISPA-2024-EU-001</div>
                                <div style="font-size:12px;color:#666;">legal@wispa.com ‚Ä¢ www.wispa-realestate.com</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:12px;color:#666">Issued: ${doc.generated}</div>
                                <div style="margin-top:8px;">
                                    <svg width="84" height="84" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                        <circle cx="50" cy="50" r="42" fill="#fff" stroke="#c0392b" stroke-width="3" />
                                        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="12" fill="#c0392b" font-weight="700">WISPA</text>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="doc-title">
                            <div style="font-size:18px;font-weight:700;color:#222;">Official Property Ownership Certificate</div>
                            <div style="font-size:12px;color:#666;margin-top:6px;">Certificate No: <strong>${doc.id}</strong></div>
                        </div>
                        <div class="doc-grid">
                            <div class="doc-left">
                                <table style="width:100%;font-size:14px;color:#222;">
                                    <tr><td style="padding:8px 0;color:#666;width:170px">Property Title</td><td style="padding:8px 0">${doc.propertyTitle}</td></tr>
                                    <tr><td style="padding:8px 0;color:#666">Property Type</td><td style="padding:8px 0">${doc.propertyType || '‚Äî'}</td></tr>
                                    <tr><td style="padding:8px 0;color:#666">Location</td><td style="padding:8px 0">${doc.location || '‚Äî'}</td></tr>
                                    <tr><td style="padding:8px 0;color:#666">Area</td><td style="padding:8px 0">${doc.area ? doc.area + ' m¬≤' : 'Not Specified'}</td></tr>
                                    <tr><td style="padding:8px 0;color:#666">Bedrooms</td><td style="padding:8px 0">${doc.bedrooms != null ? doc.bedrooms : '‚Äî'}</td></tr>
                                    <tr><td style="padding:8px 0;color:#666">Bathrooms</td><td style="padding:8px 0">${doc.bathrooms != null ? doc.bathrooms : '‚Äî'}</td></tr>
                                </table>
                            </div>
                            <div class="doc-right">
                                <div style="font-size:13px;font-weight:700;color:#0b3d91;margin-bottom:8px;">Seller / Registrar</div>
                                <div style="font-size:13px;color:#222;font-weight:600;">WISPA Real Estate</div>
                                <div style="font-size:12px;color:#666;margin-top:6px;">Reg. No: WISPA-2024-EU-001</div>
                                <div style="font-size:12px;color:#666;margin-top:6px;">12 Market Square, EU</div>
                                <div style="font-size:12px;color:#666;margin-top:6px;">support@wispa.com ‚Ä¢ +EU-SUPPORT-LINE</div>
                                <div style="margin-top:10px;font-size:12px;color:#666">Listing Category: <strong>${(doc.postTo||'Available').toUpperCase()}</strong></div>
                                <div style="margin-top:6px;font-size:12px;color:#666">Transaction: <strong>${doc.saleRent === 'sale' ? 'SALE' : 'RENT/LEASE'}</strong></div>
                            </div>
                        </div>
                        <div style="margin-top:18px;border-top:1px dashed #eee;padding-top:14px;color:#444;font-size:13px;line-height:1.45;">
                            <p style="margin:0 0 8px;">This certificate confirms that the above property has been registered on the WISPA Real Estate Platform and verified by our compliance team. Information here reflects platform records at time of issuance.</p>
                            <p style="margin:0 0 8px;">For legal title verification, consult appropriate governmental land registries. This certificate serves as a platform verification and listing confirmation.</p>
                        </div>
                        <div class="doc-footer">
                            <div style="font-size:11px;color:#999">Document generated by WISPA Platform ‚Ä¢ ${new Date().toLocaleDateString()}</div>
                            <div style="text-align:right">
                                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                                    <svg width="220" height="70" viewBox="0 0 220 70" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="overflow:visible;">
                                        <path d="M6 44 C28 10, 60 6, 86 38 C106 62, 150 18, 178 44 C196 62, 220 20, 212 14" stroke="#000" stroke-width="2.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M18 48 C30 44, 44 46, 58 38" stroke="#000" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
                                    </svg>
                                    <div style="font-size:12px;color:#666">Chief Compliance Officer</div>
                                </div>
                                <div style="margin-top:10px;display:inline-block;padding:6px 10px;border-radius:6px;background:#fff;border:2px solid #c0392b;color:#c0392b;font-weight:700;">WISPA OFFICIAL SEAL</div>
                            </div>
                        </div>
                        <div style="margin-top:12px;text-align:center;font-size:11px;color:#999;">WISPA Real Estate ‚Ä¢ Registered in EU ‚Ä¢ www.wispa-realestate.com</div>
                    </div>
                `;
                viewEl.innerHTML = html;
            }

            // Wire up download button to download the original plaintext content
            const downloadBtn = document.getElementById('download-doc-btn');
            if (downloadBtn) {
                downloadBtn.onclick = function() {
                    const blob = new Blob([content], {type:'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `WISPA-${doc.propertyId}-ownership-proof.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };
            }

            // Open modal
            const viewModal = document.getElementById('viewDocModal');
            if (viewModal) viewModal.classList.add('active');
        }

        function openPropertyDoc(propertyId){
            const docs = loadPropertyDocs();
            const doc = docs.find(d => d.propertyId === propertyId);
            if(!doc){
                alert('No document for this property yet.');
                return;
            }
            viewPropertyDoc(doc.id);
        }

        function renderPropertyDocsInReports(){
            const docs = loadPropertyDocs();
            const tbody = document.getElementById('property-docs-tbody');
            if(!tbody) return;
            
            tbody.innerHTML = '';
            if(docs.length === 0){
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No property documents yet.</td></tr>';
                return;
            }
            
            docs.forEach(doc=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${doc.propertyTitle}</strong></td>
                    <td>${doc.location}</td>
                    <td>‚Ç¨${doc.price.toLocaleString()}</td>
                    <td>${doc.generated}</td>
                    <td>${doc.format.toUpperCase()}</td>
                    <td><div class="action-buttons"><button class="btn-sm edit" onclick="viewPropertyDoc('${doc.id}')">üìÑ View</button><button class="btn-sm delete" data-id="${doc.id}">Delete</button></div></td>
                `;
                tbody.appendChild(tr);
            });
            
            tbody.querySelectorAll('.delete').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const id = this.dataset.id;
                    if(!confirm('Delete this document?')) return;
                    let docs = loadPropertyDocs();
                    docs = docs.filter(d=>d.id !== id);
                    savePropertyDocs(docs);
                    renderPropertyDocsInReports();
                });
            });
        }
        // === END PROPERTY DOCUMENT FUNCTIONS ===

        // === REPORT FUNCTIONS (Global Scope) ===
        function loadReports(){
            let reports = JSON.parse(localStorage.getItem('reports')||'[]');
            return reports;
        }

        function saveReports(reports){
            localStorage.setItem('reports', JSON.stringify(reports));
        }

        function generateReport(type, startDate, endDate, format){
            const timestamp = new Date().toLocaleString();
            const report = {
                id: String(Date.now()),
                type: type,
                startDate: startDate,
                endDate: endDate,
                format: format,
                generated: timestamp,
                size: Math.round(Math.random() * 500 + 100) + ' KB'
            };
            let reports = loadReports();
            reports.unshift(report);
            saveReports(reports);
            renderReportHistory();
            downloadReport(report);
        }

        function generateQuickReport(type){
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30*24*60*60*1000);
            const startDate = thirtyDaysAgo.toISOString().split('T')[0];
            const endDate = today.toISOString().split('T')[0];
            generateReport(type, startDate, endDate, 'pdf');
        }

        function downloadReport(report){
            const reportDate = new Date();
            const content = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                            ‚ïë
‚ïë                    üè† WISPA REAL ESTATE PLATFORM üè†                       ‚ïë
‚ïë                                                                            ‚ïë
‚ïë                    OFFICIAL BUSINESS REPORT & ANALYSIS                     ‚ïë
‚ïë                                                                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

COMPANY INFORMATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Company Name:          WISPA Real Estate Platform
License:               EU Real Estate License #WRP-2024-001
Report Generated By:   WISPA Analytics System
Platform URL:          www.wispa-realestate.com
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

REPORT DETAILS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Report Type:           ${report.type.toUpperCase()} REPORT
Date Generated:        ${report.generated}
Analysis Period:       ${report.startDate} to ${report.endDate}
Report Format:         ${report.format.toUpperCase()}
Report ID:             WISPA-${report.type.substring(0,3)}-${String(Date.now()).slice(-8)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

EXECUTIVE SUMMARY:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

This comprehensive ${report.type} report has been prepared by the WISPA Real 
Estate Analytics Department. The data presented herein reflects information 
collected from our verified properties and user activities during the specified
reporting period.

REPORT CONTENT:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${
  report.type === 'properties' ? `
PROPERTIES ANALYSIS:
  ‚Ä¢ Total Properties Listed
  ‚Ä¢ Active Property Count
  ‚Ä¢ Property Type Distribution
  ‚Ä¢ Price Range Analysis
  ‚Ä¢ Location-Based Statistics
  ‚Ä¢ Featured vs Standard Listings
` : report.type === 'users' ? `
USER ANALYTICS:
  ‚Ä¢ Total Registered Users
  ‚Ä¢ User Engagement Metrics
  ‚Ä¢ Account Activity Overview
  ‚Ä¢ User Demographics
  ‚Ä¢ Role-Based Distribution
  ‚Ä¢ Account Status Summary
` : report.type === 'sales' ? `
SALES & REVENUE REPORT:
  ‚Ä¢ Total Transactions
  ‚Ä¢ Revenue Overview
  ‚Ä¢ Average Transaction Value
  ‚Ä¢ Payment Method Distribution
  ‚Ä¢ Sales Trends
  ‚Ä¢ Revenue Forecasting
` : report.type === 'agents' ? `
AGENT PERFORMANCE METRICS:
  ‚Ä¢ Total Active Agents
  ‚Ä¢ Properties Per Agent
  ‚Ä¢ Agent Rating Analysis
  ‚Ä¢ Performance Indicators
  ‚Ä¢ Transaction History
  ‚Ä¢ Certification Status
` : `
TRAFFIC & ANALYTICS:
  ‚Ä¢ Website Visits
  ‚Ä¢ User Traffic Patterns
  ‚Ä¢ Page View Analytics
  ‚Ä¢ Conversion Rates
  ‚Ä¢ Device Type Distribution
  ‚Ä¢ Geographic Analysis
`
}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

OFFICIAL CERTIFICATION:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                    ‚ïë   üîê WISPA VERIFIED‚Ñ¢ üîê    ‚ïë
                    ‚ïë   OFFICIAL REPORT           ‚ïë
                    ‚ïë   [Digitally Certified]     ‚ïë
                    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

CONFIDENTIALITY NOTICE:
This report is confidential and prepared solely for authorized WISPA 
administrators and authorized parties. Unauthorized access, use, or 
reproduction is prohibited by law.

For data verification and additional information, contact:
reports@wispa.com | +EU-SUPPORT-LINE

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  WISPA Real Estate - Trusted by Thousands | Innovative Property Solutions ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WISPA-${report.type}-report-${report.id}.${report.format === 'pdf' ? 'txt' : report.format}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderReportHistory(){
            const tbody = document.getElementById('reports-history-tbody');
            if(!tbody) return;
            const reports = loadReports();
            tbody.innerHTML = '';
            if(reports.length === 0){
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No reports generated yet.</td></tr>';
                return;
            }
            reports.forEach(rep=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${rep.type}</strong></td>
                    <td>${rep.generated}</td>
                    <td>${rep.startDate} to ${rep.endDate}</td>
                    <td>${rep.format.toUpperCase()}</td>
                    <td>${rep.size}</td>
                    <td><div class="action-buttons"><button class="btn-sm edit" onclick="downloadReport(JSON.parse('${JSON.stringify(rep).replace(/'/g,"\\'")}'))">üì• Download</button><button class="btn-sm delete" data-id="${rep.id}">Delete</button></div></td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.delete').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const id = this.dataset.id;
                    if(!confirm('Delete this report?')) return;
                    let reports = loadReports();
                    reports = reports.filter(r=>r.id !== id);
                    saveReports(reports);
                    renderReportHistory();
                });
            });
        }
        // === END REPORT FUNCTIONS ===

        document.addEventListener('DOMContentLoaded', function() {
            // Modal click-outside listeners
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) this.classList.remove('active');
                });
            });

            const hamburgerBtn = document.getElementById('hamburger-btn');
            const headerNav = document.getElementById('header-nav');
            if (hamburgerBtn && headerNav) {
                hamburgerBtn.addEventListener('click', function() {
                    headerNav.classList.toggle('active');
                });
            }

            function capitalize(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

            // Load properties saved by admin. Do NOT generate system defaults here.
            function loadProperties(){
                let props = JSON.parse(localStorage.getItem('properties') || 'null');
                if(!props || !Array.isArray(props)){
                    props = [];
                    try { localStorage.setItem('properties', JSON.stringify(props)); } catch(e){}
                }
                return props;
            }

            function saveProperties(props){
                localStorage.setItem('properties', JSON.stringify(props));
                try {
                    localStorage.setItem('propertiesUpdated', String(Date.now()));
                } catch(e){}
                console.debug('admin.saveProperties: saved properties length=', Array.isArray(props) ? props.length : 'na');

                // Attempt to sync each property to server (server-first, localStorage fallback)
                if (typeof window !== 'undefined') {
                    const poster = window.apiFetch ? window.apiFetch : fetch;
                    props.forEach(async (p, idx) => {
                        try {
                            // If already synced to server, skip
                            if (p._serverId) return;

                            // build backend shape
                            // If images contains data: URLs, convert to blobs and upload them first to avoid huge JSON bodies
                            async function dataURLtoBlob(dataurl) {
                                const parts = dataurl.split(',');
                                const header = parts[0];
                                const base64 = parts[1];
                                const mime = header.match(/:(.*?);/)[1];
                                const byteChars = atob(base64);
                                const byteNumbers = new Array(byteChars.length);
                                for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                                return new Blob([new Uint8Array(byteNumbers)], { type: mime });
                            }

                            let photoUrls = Array.isArray(p.images) ? p.images.slice() : (p.photos ? p.photos.slice() : []);
                            // detect data URLs
                            const dataImgs = photoUrls.filter(u => typeof u === 'string' && u.startsWith('data:'));
                            if (dataImgs.length) {
                                try {
                                    const form = new FormData();
                                    for (let i = 0; i < dataImgs.length; i++){
                                        const blob = await dataURLtoBlob(dataImgs[i]);
                                        form.append('files', blob, 'upload-' + Date.now() + '-' + i + '.png');
                                    }
                                    const poster = window.apiFetch ? window.apiFetch : fetch;
                                    const upRes = await poster('/api/upload-photos', { method: 'POST', body: form });
                                    if (upRes && typeof upRes.json === 'function') {
                                        const upJson = await upRes.json();
                                        if (Array.isArray(upJson.urls) && upJson.urls.length) {
                                            // replace data URLs with returned URLs (preserve non-data URLs)
                                            const uploaded = upJson.urls;
                                            let ui = 0;
                                            photoUrls = photoUrls.map(u => (typeof u === 'string' && u.startsWith('data:')) ? (uploaded[ui++] || '') : u).filter(Boolean);
                                        }
                                    }
                                } catch (e) {
                                    console.warn('admin.saveProperties: failed to upload embedded images', e);
                                    // fall back to stripping data URLs to avoid huge POST
                                    photoUrls = photoUrls.filter(u => !(typeof u === 'string' && u.startsWith('data:')));
                                }
                            }

                            const body = {
                                property: {
                                    user_id: p.user_id || null,
                                    title: p.title || p.name || '',
                                    description: p.description || p.type || '',
                                    price: p.price || 0,
                                    address: p.address || p.location || '',
                                    city: p.city || '',
                                    state: p.state || '',
                                    zip_code: p.zip_code || p.postal || '',
                                    image_url: (photoUrls && photoUrls[0]) || p.image || null
                                },
                                photoUrls: photoUrls
                            };

                            console.debug('admin.saveProperties: posting property to API', body);
                            // Log outgoing body for debugging (no localStorage usage)
                            try { console.info('lastPropertyPost', { time: Date.now(), body }); } catch (e) {}
                            const res = await poster('/api/properties', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(body)
                            });
                            // If the response is a Response and not ok, capture text for debugging
                            if (res && typeof res.ok === 'boolean' && !res.ok) {
                                try {
                                    const t = await res.text();
                                    console.error('admin.saveProperties: API returned non-ok', res.status, t);
                                    try { console.error('lastPropertyPost error', { time: Date.now(), body, status: res.status, responseText: t }); } catch(e){}
                                } catch (e) { console.error('admin.saveProperties: API returned non-ok and text read failed', e); }
                            }
                            // apiFetch may return parsed JSON
                            let data;
                            if (res && typeof res.json === 'function') data = await res.json(); else data = res;
                            if (data) {
                                // If server returned full property object, merge it into local props
                                if (data.property) {
                                    props[idx] = Object.assign({}, props[idx] || {}, data.property);
                                    props[idx]._serverId = data.propertyId || data.property.id || props[idx]._serverId;
                                } else if (data.propertyId) {
                                    props[idx]._serverId = data.propertyId;
                                }
                                try { localStorage.setItem('properties', JSON.stringify(props)); } catch(e){}
                            }
                        } catch (e) {
                            // leave in localStorage as fallback
                            console.warn('admin.saveProperties: server sync failed for a property', e);
                        }
                    });
                }
            }

            function clearAllProperties(){
                if(!confirm('This will remove ALL properties from the system for now. Continue?')) return;
                try{
                    localStorage.removeItem('properties');
                    localStorage.setItem('propertiesUpdated', String(Date.now()));
                }catch(e){console.warn('clearAllProperties failed', e)}
                console.debug('admin.clearAllProperties: cleared properties');
                renderPropertiesTable();
                alert('All properties cleared from storage. User homepage will update on reload or automatically if open.');
            }

            function renderPropertiesTable(){
                const props = loadProperties();
                const tbody = document.getElementById('properties-tbody');
                if(!tbody) return;
                tbody.innerHTML = '';
                props.slice(0, 10).forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${p.id}</td>
                        <td>${p.title}</td>
                        <td>${p.type || ''}</td>
                        <td>‚Ç¨${(p.price||0).toLocaleString()}</td>
                        <td>${p.location || ''}</td>
                        <td><span class="badge active">${p.status||'Active'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm edit" data-id="${p.id}" onclick="alert('Edit feature coming soon!')">Edit</button>
                                <button class="btn-sm" style="background:#2ecc71;color:white;font-size:11px;" onclick="openPropertyDoc('${p.id}')">üìÑ</button>
                                <button class="btn-sm delete" data-id="${p.id}">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', function(){
                        const id = this.dataset.id;
                        if(!confirm('Delete this property?')) return;
                        let props = loadProperties();
                        props = props.filter(x => String(x.id) !== String(id));
                        saveProperties(props);
                        renderPropertiesTable();
                    });
                });
            }

            function loadUsers(){
                let users = JSON.parse(localStorage.getItem('users') || 'null');
                if(!users || !Array.isArray(users)){
                    users = [
                        {id:1,name:'John Smith',email:'john@example.com',role:'Admin',joined:'Jan 15, 2024',status:'Active'},
                        {id:2,name:'Sarah Johnson',email:'sarah@example.com',role:'Agent',joined:'Feb 1, 2024',status:'Active'},
                    ];
                    localStorage.setItem('users', JSON.stringify(users));
                }
                // Merge currently signed-up user (wispaUser) if present
                try{
                    const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                    if(wispaUser && (wispaUser.email || wispaUser.username)){
                        const ident = wispaUser.email || wispaUser.username;
                        const exists = users.find(u => (u.email || '').toLowerCase() === (ident||'').toLowerCase() || (u.name || '').toLowerCase() === (ident||'').toLowerCase());
                        if(!exists){
                            users.unshift({ id: Date.now(), name: wispaUser.username || ident, email: wispaUser.email || '', role: 'User', joined: new Date().toLocaleDateString(), status: 'Active' });
                            localStorage.setItem('users', JSON.stringify(users));
                        }
                    }
                }catch(e){}
                return users;
            }

            function renderUsersTable(){
                const users = loadUsers();
                const tbody = document.getElementById('users-tbody');
                if(!tbody) return;
                tbody.innerHTML = '';
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.role}</td>
                        <td>${u.joined}</td>
                        <td><span class="badge active">${u.status}</span></td>
                        <td><div class="action-buttons"><button class="btn-sm edit">Edit</button></div></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const addForm = document.getElementById('add-property-form');
            if(addForm){
                addForm.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const form = e.target;
                    let props = loadProperties();
                    const id = form['property-id'].value;
                    const files = Array.from(form['media'].files || []);
                    const mediaFiles = files.length;

                    // helper to read a File to data URL
                    function fileToDataURL(file){
                        return new Promise((res, rej) => {
                            const reader = new FileReader();
                            reader.onload = () => res({ name: file.name, type: file.type, src: reader.result });
                            reader.onerror = rej;
                            reader.readAsDataURL(file);
                        });
                    }

                    // read uploaded files (if any)
                    let mediaEntries = [];
                    if(mediaFiles > 0){
                        try{
                            mediaEntries = await Promise.all(files.map(f => fileToDataURL(f)));
                        } catch(err){
                            console.warn('Failed reading uploaded media', err);
                            mediaEntries = [];
                        }
                    }

                    let savedProperty = null;
                    if(id){
                        const prop = props.find(x => String(x.id) === String(id));
                        if(prop) {
                            const postToVal = form['postTo'].value;
                            Object.assign(prop, {
                                title: form['title'].value,
                                price: Number(form['price'].value),
                                description: form['description'] ? form['description'].value : (prop.description || ''),
                                type: form['type'].value,
                                saleRent: form['saleRent'].value,
                                location: form['location'].value,
                                area: form['area'].value ? Number(form['area'].value) : null,
                                bedrooms: form['bedrooms'] && form['bedrooms'].value !== '' ? Number(form['bedrooms'].value) : null,
                                bathrooms: form['bathrooms'] && form['bathrooms'].value !== '' ? Number(form['bathrooms'].value) : null,
                                postTo: postToVal,
                                featured: postToVal === 'featured',
                                hot: postToVal === 'hot',
                                mediaCount: mediaFiles
                            });

                            // replace images/media only if new files uploaded
                            if(mediaEntries.length > 0){
                                // store only data URLs (src) for backward compatibility
                                prop.images = mediaEntries.map(m => m.src);
                            }
                            savedProperty = prop;
                        }
                    } else {
                        const newId = String(Date.now()).slice(-8);
                        const postToVal = form['postTo'].value;
                        const newProperty = {
                            id: newId,
                            title: form['title'].value,
                            description: form['description'] ? form['description'].value : '',
                            price: Number(form['price'].value),
                            type: form['type'].value,
                            saleRent: form['saleRent'].value,
                            location: form['location'].value,
                            area: form['area'].value ? Number(form['area'].value) : null,
                            bedrooms: form['bedrooms'] && form['bedrooms'].value !== '' ? Number(form['bedrooms'].value) : null,
                            bathrooms: form['bathrooms'] && form['bathrooms'].value !== '' ? Number(form['bathrooms'].value) : null,
                            postTo: postToVal,
                            featured: postToVal === 'featured',
                            hot: postToVal === 'hot',
                            images: mediaEntries.length > 0 ? mediaEntries.map(m => m.src) : [getRandomPropertyImage()],
                            date: 'Today',
                            status: 'Active',
                            mediaCount: mediaFiles
                        };
                        props.unshift(newProperty);
                        savedProperty = newProperty;
                    }
                    saveProperties(props);

                    // Generate property document
                    if(savedProperty){
                        generatePropertyDocument(savedProperty);
                    }

                    renderPropertiesTable();
                    closeModal('addProperty');
                    form.reset();
                    form['property-id'].value = '';
                    alert(mediaFiles > 0 ? `‚úÖ Property saved with ${mediaFiles} file(s) + document generated!` : '‚úÖ Property saved + document generated!');
                });
            }

            // Render tables without clearing stored properties (preserve admin posts)
            renderPropertiesTable();
            renderUsersTable();
            
            // MESSAGE MANAGEMENT FUNCTIONS
            let currentMessageId = null;
            
            function loadMessages(){
                return JSON.parse(localStorage.getItem('contactMessages') || '[]');
            }

            async function saveMessages(messages){
                // Try to persist each message to backend; fallback to localStorage
                try {
                    for (const m of messages) {
                        try {
                            await fetch('/api/contact-messages', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(m)
                            });
                        } catch(e) {
                            // ignore per-message failure and continue
                        }
                    }
                    localStorage.setItem('contactMessages', JSON.stringify(messages));
                } catch (err) {
                    localStorage.setItem('contactMessages', JSON.stringify(messages));
                }
            }
            
            function renderMessagesTable(){
                const messages = loadMessages();
                const tbody = document.getElementById('messages-tbody');
                if(!tbody) return;
                
                tbody.innerHTML = '';
                
                if(messages.length === 0){
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-light);">No messages received yet.</td></tr>';
                    return;
                }
                
                messages.forEach(msg => {
                    const tr = document.createElement('tr');
                    const statusIcon = msg.read ? '‚úì' : '‚óè';
                    const statusColor = msg.read ? 'var(--text-light)' : 'var(--primary)';
                    
                    tr.innerHTML = `
                        <td><span style="color:${statusColor};font-size:18px;">${statusIcon}</span></td>
                        <td><strong>${msg.name}</strong></td>
                        <td><a href="mailto:${msg.email}" style="color:var(--primary);text-decoration:none;">${msg.email}</a></td>
                        <td>${msg.phone}</td>
                        <td>${msg.subject}</td>
                        <td style="font-size:14px;color:var(--text-light);">${msg.timestamp}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm edit" onclick="viewMessage('${msg.id}')" style="background:#3498db;color:white;padding:6px 10px;font-size:12px;">View</button>
                                <button class="btn-sm delete" onclick="deleteMessage('${msg.id}')" style="background:#e74c3c;color:white;padding:6px 10px;font-size:12px;">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            function viewMessage(msgId){
                const messages = loadMessages();
                const msg = messages.find(m => m.id === msgId);
                if(!msg) return;
                
                currentMessageId = msgId;
                
                // Mark as read
                msg.read = true;
                saveMessages(messages);
                
                // Populate modal
                document.getElementById('msg-name').textContent = msg.name;
                document.getElementById('msg-email').textContent = msg.email;
                document.getElementById('msg-phone').textContent = msg.phone;
                document.getElementById('msg-date').textContent = msg.timestamp;
                document.getElementById('msg-subject').textContent = msg.subject;
                document.getElementById('msg-content').textContent = msg.message;
                
                openModal('viewMessageModal');
                
                // Refresh table to show read status
                renderMessagesTable();
            }
            
            function replyToMessage(){
                if(!currentMessageId) return;
                const messages = loadMessages();
                const msg = messages.find(m => m.id === currentMessageId);
                if(!msg) return;
                
                // Open email client
                window.open(`mailto:${msg.email}?subject=Re: ${msg.subject}`);
            }
            
            function deleteMessage(msgId){
                if(!msgId && currentMessageId){
                    msgId = currentMessageId;
                }
                if(!msgId) return;
                
                if(!confirm('Delete this message?')) return;
                
                let messages = loadMessages();
                messages = messages.filter(m => m.id !== msgId);
                // persist deletion to server (best-effort) by overwriting server copy
                try {
                    try { window.apiFetch('/api/admin/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'contactMessages', value: messages }) }).catch(()=>{}); } catch(e){}
                } catch(e){}
                saveMessages(messages);
                
                closeModal('viewMessageModal');
                currentMessageId = null;
                renderMessagesTable();
            }
            
            function markAllMessagesAsRead(){
                const messages = loadMessages();
                messages.forEach(msg => msg.read = true);
                try { window.apiFetch('/api/admin/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'contactMessages', value: messages }) }).catch(()=>{}); } catch(e){}
                saveMessages(messages);
                renderMessagesTable();
            }
            
            function deleteAllMessages(){
                if(!confirm('Delete all messages? This cannot be undone.')) return;
                try { window.apiFetch('/api/admin/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'contactMessages', value: [] }) }).catch(()=>{}); } catch(e){}
                localStorage.setItem('contactMessages', '[]');
                renderMessagesTable();
            }
            
            function getUnreadMessageCount(){
                const messages = loadMessages();
                return messages.filter(m => !m.read).length;
            }
            
            function updateMessageStats(){
                const messages = loadMessages();
                const totalMessages = messages.length;
                const unreadCount = getUnreadMessageCount();
                
                const statMessagesEl = document.getElementById('stat-messages');
                const statUnreadEl = document.getElementById('stat-messages-unread');
                
                if(statMessagesEl) statMessagesEl.textContent = totalMessages;
                if(statUnreadEl){
                    if(unreadCount === 0){
                        statUnreadEl.textContent = 'All read';
                        statUnreadEl.style.color = '#2ecc71';
                    } else {
                        statUnreadEl.textContent = `${unreadCount} unread`;
                        statUnreadEl.style.color = '#e74c3c';
                    }
                }
            }

            // === ADMIN NOTIFICATIONS MANAGEMENT ===
            function switchNotificationTab(tabName) {
                            // ...existing code...
                // Ensure switchNotificationTab is globally available for inline onclick
                if (typeof window !== 'undefined') window.switchNotificationTab = switchNotificationTab;
                // Hide all tabs
                document.querySelectorAll('.notif-tab-content').forEach(tab => {
                    tab.style.display = 'none';
                });
                // Remove active class from buttons
                document.querySelectorAll('.admin-notif-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Show selected tab
                const contentId = tabName + '-content';
                const tabContent = document.getElementById(contentId);
                if (tabContent) {
                    tabContent.style.display = 'block';
                }
                // Add active class to button
                // If called from click, event.target is the button; otherwise, find the button
                let btn = null;
                if (event && event.target && event.target.classList.contains('admin-notif-tab')) {
                    btn = event.target;
                } else {
                    btn = document.querySelector('.admin-notif-tab[data-tab="' + tabName + '"]');
                }
                if (btn) btn.classList.add('active');
                // Render All Alerts if needed
                if(tabName === 'all') renderAllAlerts();
            }

            function loadAdminNotifications() {
                loadFeedbacks();
                loadSentNotifications();
                loadReactions();
                loadChatNotifications();
                loadContactMessages();
            }

            // === FEEDBACKS MANAGEMENT ===
            function loadFeedbacks() {
                const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                const tbody = document.getElementById('feedbacks-tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (feedbacks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-light);">No feedbacks yet.</td></tr>';
                    return;
                }

                feedbacks.forEach(fb => {
                    const tr = document.createElement('tr');
                    const statusIcon = fb.read ? '‚úì' : '‚óè';
                    const statusColor = fb.read ? 'var(--text-light)' : 'var(--primary)';
                    const typeEmoji = fb.type === 'bug' ? 'üêõ' : fb.type === 'feature' ? '‚ú®' : 'üí≠';
                    
                    tr.innerHTML = `
                        <td><span style="color:${statusColor};font-size:18px;">${statusIcon}</span></td>
                        <td><strong>${fb.name || 'Anonymous'}</strong></td>
                        <td>${fb.email || 'N/A'}</td>
                        <td>${typeEmoji} ${fb.type || 'General'}</td>
                        <td>${fb.message.substring(0, 50)}${fb.message.length > 50 ? '...' : ''}</td>
                        <td style="font-size:14px;color:var(--text-light);">${new Date(fb.timestamp).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm edit" onclick="viewFeedback('${fb.id}')" style="background:#3498db;color:white;padding:6px 10px;font-size:12px;">View</button>
                                <button class="btn-sm delete" onclick="deleteFeedback('${fb.id}')" style="background:#e74c3c;color:white;padding:6px 10px;font-size:12px;">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function viewFeedback(fbId) {
                const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                const fb = feedbacks.find(f => f.id === fbId);
                if (!fb) return;

                // Mark as read
                fb.read = true;
                localStorage.setItem('userFeedbacks', JSON.stringify(feedbacks));

                alert(`üìù Feedback from ${fb.name}\n\nType: ${fb.type}\nEmail: ${fb.email}\n\nMessage:\n${fb.message}`);
                loadFeedbacks();
            }

            function deleteFeedback(fbId) {
                if (!confirm('Delete this feedback?')) return;
                let feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                feedbacks = feedbacks.filter(f => f.id !== fbId);
                localStorage.setItem('userFeedbacks', JSON.stringify(feedbacks));
                loadFeedbacks();
            }

            function markAllFeedbacksAsRead() {
                let feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                feedbacks.forEach(fb => fb.read = true);
                localStorage.setItem('userFeedbacks', JSON.stringify(feedbacks));
                loadFeedbacks();
            }

            function deleteAllFeedbacks() {
                if (!confirm('Delete all feedbacks? This cannot be undone.')) return;
                localStorage.setItem('userFeedbacks', '[]');
                loadFeedbacks();
            }

            // === SENT NOTIFICATIONS MANAGEMENT ===
            function loadSentNotifications() {
                const sentNotifications = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                const tbody = document.getElementById('sent-tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (sentNotifications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-light);">No notifications sent yet.</td></tr>';
                    return;
                }

                sentNotifications.forEach(notif => {
                    const tr = document.createElement('tr');
                    const statusBadge = notif.read ? '‚úì Read' : '‚óè Sent';
                    const statusColor = notif.read ? '#2ecc71' : '#3498db';
                    const attachmentInfo = notif.file ? `üìé ${notif.file.name}` : 'None';
                    
                    tr.innerHTML = `
                        <td><strong>${notif.targetUser}</strong></td>
                        <td>${notif.title}</td>
                        <td>${notif.message.substring(0, 40)}${notif.message.length > 40 ? '...' : ''}</td>
                        <td style="font-size:12px;color:var(--text-light);">${new Date(notif.timestamp).toLocaleDateString()}</td>
                        <td><span style="color:${statusColor};font-weight:600;">${statusBadge}</span></td>
                        <td>${attachmentInfo}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm edit" onclick="viewSentNotification('${notif.id}')" style="background:#3498db;color:white;padding:6px 10px;font-size:12px;">View</button>
                                <button class="btn-sm delete" onclick="deleteSentNotification('${notif.id}')" style="background:#e74c3c;color:white;padding:6px 10px;font-size:12px;">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function viewSentNotification(notifId) {
                const sentNotifications = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                const notif = sentNotifications.find(n => n.id === notifId);
                if (!notif) return;

                alert(`üì® Notification Details\n\nTo: ${notif.targetUser}\nTitle: ${notif.title}\nSent: ${new Date(notif.timestamp).toLocaleString()}\nStatus: ${notif.read ? 'Read' : 'Sent'}\n\nMessage:\n${notif.fullMessage}`);
            }

            function deleteSentNotification(notifId) {
                if (!confirm('Delete this sent notification?')) return;
                let sentNotifications = JSON.parse(localStorage.getItem('adminSentNotifications') || '[]');
                sentNotifications = sentNotifications.filter(n => n.id !== notifId);
                localStorage.setItem('adminSentNotifications', JSON.stringify(sentNotifications));
                loadSentNotifications();
            }

            function refreshSentNotifications() {
                loadSentNotifications();
                alert('‚úì Notifications refreshed');
            }

            function deleteAllSentNotifications() {
                if (!confirm('Delete all sent notifications? This cannot be undone.')) return;
                localStorage.setItem('adminSentNotifications', '[]');
                loadSentNotifications();
            }

            // === REACTIONS & REPLIES MANAGEMENT ===
            function loadReactions() {
                const reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
                const tbody = document.getElementById('reactions-tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (reactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No reactions or replies yet.</td></tr>';
                    return;
                }

                reactions.forEach(reaction => {
                    const tr = document.createElement('tr');
                    const reactionEmoji = reaction.reaction || 'üëç';
                    
                    tr.innerHTML = `
                        <td><strong>${reaction.userName}</strong></td>
                        <td>${reaction.notificationTitle.substring(0, 30)}...</td>
                        <td>${reaction.reply ? reaction.reply.substring(0, 40) + '...' : '-'}</td>
                        <td style="font-size:20px;">${reactionEmoji}</td>
                        <td style="font-size:12px;color:var(--text-light);">${new Date(reaction.timestamp).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-sm delete" onclick="deleteReaction('${reaction.id}')" style="background:#e74c3c;color:white;padding:6px 10px;font-size:12px;">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function deleteReaction(reactionId) {
                if (!confirm('Delete this reaction?')) return;
                let reactions = JSON.parse(localStorage.getItem('notificationReactions') || '[]');
                reactions = reactions.filter(r => r.id !== reactionId);
                localStorage.setItem('notificationReactions', JSON.stringify(reactions));
                loadReactions();
            }

            // === CHAT NOTIFICATIONS MANAGEMENT ===
            function loadChatNotifications() {
                const chatNotifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                const tbody = document.getElementById('chats-tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (chatNotifications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No chat notifications yet.</td></tr>';
                    return;
                }

                chatNotifications.forEach(chat => {
                    const tr = document.createElement('tr');
                    const statusIcon = chat.read ? '‚úì' : '‚óè';
                    const statusColor = chat.read ? 'var(--text-light)' : 'var(--primary)';
                    
                    tr.innerHTML = `
                        <td><span style="color:${statusColor};font-size:18px;">${statusIcon}</span></td>
                        <td><strong>${chat.userName}</strong></td>
                        <td>${chat.conversationTitle}</td>
                        <td>${chat.lastMessage.substring(0, 40)}${chat.lastMessage.length > 40 ? '...' : ''}</td>
                        <td style="font-size:12px;color:var(--text-light);">${new Date(chat.timestamp).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm edit" onclick="viewChatNotification('${chat.id}')" style="background:#3498db;color:white;padding:6px 10px;font-size:12px;">View</button>
                                <button class="btn-sm delete" onclick="deleteChatNotification('${chat.id}')" style="background:#e74c3c;color:white;padding:6px 10px;font-size:12px;">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function viewChatNotification(chatId) {
                const chatNotifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                const chat = chatNotifications.find(c => c.id === chatId);
                if (!chat) return;

                // Mark as read
                chat.read = true;
                localStorage.setItem('chatNotifications', JSON.stringify(chatNotifications));

                alert(`üí¨ Chat Notification\n\nFrom: ${chat.userName}\nConversation: ${chat.conversationTitle}\nDate: ${new Date(chat.timestamp).toLocaleString()}\n\nMessage:\n${chat.lastMessage}`);
                loadChatNotifications();
            }

            function deleteChatNotification(chatId) {
                if (!confirm('Delete this chat notification?')) return;
                let chatNotifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                chatNotifications = chatNotifications.filter(c => c.id !== chatId);
                localStorage.setItem('chatNotifications', JSON.stringify(chatNotifications));
                loadChatNotifications();
            }

            function markAllChatsAsRead() {
                let chatNotifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                chatNotifications.forEach(chat => chat.read = true);
                localStorage.setItem('chatNotifications', JSON.stringify(chatNotifications));
                loadChatNotifications();
            }

            function deleteAllChatNotifications() {
                if (!confirm('Delete all chat notifications? This cannot be undone.')) return;
                localStorage.setItem('chatNotifications', '[]');
                loadChatNotifications();
            }

            // === CONTACT MESSAGES MANAGEMENT ===
            function loadContactMessages() {
                const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                const tbody = document.getElementById('contacts-tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                if (messages.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No contact messages yet.</td></tr>';
                    return;
                }

                messages.forEach((msg, index) => {
                    const isRead = msg.read || false;
                    const date = new Date(msg.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    
                    const row = document.createElement('tr');
                    row.style.backgroundColor = isRead ? 'transparent' : 'rgba(52, 152, 219, 0.08)';
                    row.innerHTML = `
                        <td style="text-align:center;">
                            <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${isRead ? '#95a5a6' : '#3498db'};"></span>
                        </td>
                        <td><strong>${msg.name || 'Anonymous'}</strong></td>
                        <td>${msg.email || 'N/A'}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${msg.subject || 'No subject'}</td>
                        <td style="font-size:0.9em;color:var(--text-light);">${dateStr}</td>
                        <td style="text-align:center;">
                            <button class="btn-sm edit" onclick="viewContactMessage(${index})">View</button>
                            <button class="btn-sm delete" onclick="deleteContactMessage(${index})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function viewContactMessage(index) {
                const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                const msg = messages[index];
                if (!msg) return;

                // Mark as read
                msg.read = true;
                messages[index] = msg;
                localStorage.setItem('contactMessages', JSON.stringify(messages));

                // Show modal with message details
                alert(`Contact Message\n\nName: ${msg.name || 'Anonymous'}\nEmail: ${msg.email || 'N/A'}\nPhone: ${msg.phone || 'N/A'}\nSubject: ${msg.subject || 'No subject'}\n\nMessage:\n${msg.message || 'No content'}`);
                loadContactMessages();
            }

            function deleteContactMessage(index) {
                if (!confirm('Delete this contact message?')) return;
                const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                messages.splice(index, 1);
                localStorage.setItem('contactMessages', JSON.stringify(messages));
                loadContactMessages();
            }

            function markAllContactsAsRead() {
                const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                messages.forEach(msg => {
                    msg.read = true;
                });
                localStorage.setItem('contactMessages', JSON.stringify(messages));
                loadContactMessages();
            }

            function deleteAllContactMessages() {
                if (!confirm('Delete all contact messages? This cannot be undone.')) return;
                localStorage.setItem('contactMessages', '[]');
                loadContactMessages();
            }
            
            // Analytics rendering with enhanced visuals
            function drawLineChart(canvas, points, color){
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const w = canvas.width; const h = canvas.height;
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
                
                const max = Math.max(...points); const min = Math.min(...points);
                const padL = 40, padR = 10, padT = 10, padB = 30;
                const chartW = w - padL - padR;
                const chartH = h - padT - padB;
                const len = points.length;
                
                // Gridlines and Y-axis labels
                ctx.strokeStyle = '#e0e0e0'; ctx.lineWidth = 1; ctx.font = '11px sans-serif'; ctx.fillStyle = '#666';
                for(let i = 0; i <= 4; i++){
                    const yVal = min + (max - min) * (i / 4);
                    const y = padT + (1 - i/4) * chartH;
                    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + chartW, y); ctx.stroke();
                    ctx.textAlign = 'right'; ctx.fillText(Math.round(yVal).toString(), padL - 8, y + 4);
                }
                
                // X-axis
                ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(padL, padT + chartH); ctx.lineTo(padL + chartW, padT + chartH); ctx.stroke();
                
                // Y-axis
                ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, padT + chartH); ctx.stroke();
                
                // Line
                ctx.strokeStyle = color || '#3498db'; ctx.lineWidth = 2.5; ctx.beginPath();
                points.forEach((p,i)=>{
                    const x = padL + (i/(len-1))*chartW;
                    const y = padT + (1 - (p - min)/(max - min || 1))*chartH;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                });
                ctx.stroke();
                
                // Points
                ctx.fillStyle = color || '#3498db';
                points.forEach((p,i)=>{
                    const x = padL + (i/(len-1))*chartW;
                    const y = padT + (1 - (p - min)/(max - min || 1))*chartH;
                    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
                });
            }

            function drawPieChart(canvas, segments){
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const w=canvas.width, h=canvas.height;
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
                
                const total = segments.reduce((s,s2)=>s+s2.value,0);
                let start = -Math.PI/2;
                const cx = w/2 - 40, cy = h/2, r = Math.min(w,h)/2.5 - 10;
                
                segments.forEach(seg=>{
                    const slice = (seg.value/total)*(Math.PI*2);
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, r, start, start+slice);
                    ctx.closePath();
                    ctx.fillStyle = seg.color;
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    start += slice;
                });
                
                // Legend
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'left';
                segments.forEach((seg, i)=>{
                    const legX = cx + r + 30;
                    const legY = cy - (segments.length - 1) * 12 + i * 24;
                    ctx.fillStyle = seg.color;
                    ctx.fillRect(legX, legY - 10, 14, 14);
                    ctx.fillStyle = '#333';
                    ctx.fillText(`${seg.label} (${Math.round((seg.value/total)*100)}%)`, legX + 20, legY);
                });
            }

            function renderTopPropertiesTable(items){
                const tbody = document.getElementById('top-properties-tbody'); if(!tbody) return; tbody.innerHTML='';
                items.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.title}</td><td>${it.location}</td><td>${it.views}</td>`; tbody.appendChild(tr); });
            }

            function renderAnalytics(){
                // sample data (or read from localStorage if available)
                let analytics = JSON.parse(localStorage.getItem('analytics')||'null');
                if(!analytics){
                    analytics = {
                        visits: Array.from({length:30},(_,i)=>Math.round(200 + Math.sin(i/4)*40 + Math.random()*30)),
                        usersByRole: [{label:'Admin',value:5,color:'#3498db'},{label:'Agent',value:25,color:'#2ecc71'},{label:'User',value:120,color:'#f39c12'}],
                        topProperties: [{title:'Elegant Mansion',location:'Cannes',views:1245},{title:'City Apartment',location:'Lisbon',views:984},{title:'Beach House',location:'Tarifa',views:812}],
                        signups: 48, revenue: 12450
                    };
                    localStorage.setItem('analytics', JSON.stringify(analytics));
                }

                document.getElementById('visits-30').textContent = analytics.visits.reduce((s,n)=>s+n,0).toLocaleString();
                document.getElementById('signups-30').textContent = (analytics.signups||0);
                document.getElementById('conversion').textContent = Math.round(((analytics.signups||0)/(analytics.visits.reduce((s,n)=>s+n,0)||1))*100) + '%';
                document.getElementById('revenue').textContent = '‚Ç¨' + (analytics.revenue||0).toLocaleString();

                const visitsCanvas = document.getElementById('visits-line');
                const pieCanvas = document.getElementById('users-pie');
                drawLineChart(visitsCanvas, analytics.visits, '#3498db');
                drawPieChart(pieCanvas, analytics.usersByRole.map(r=>({value:r.value,color:r.color,label:r.label})));
                renderTopPropertiesTable(analytics.topProperties);
            }

            renderAnalytics();

            // Report functions now defined in global scope
            const reportForm = document.getElementById('report-form');
            if(reportForm){
                reportForm.addEventListener('submit', function(e){
                    e.preventDefault();
                    const type = document.getElementById('report-type').value;
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;
                    const format = document.getElementById('report-format').value;
                    if(!type){ alert('Please select a report type'); return; }
                    generateReport(type, startDate||'', endDate||'', format);
                    this.reset();
                });
            }

            renderReportHistory();
            renderPropertyDocsInReports();
            let currentAlertSortOrder = 'desc';
            
            const ALERT_TEMPLATES = [
                { name: 'System Maintenance', type: 'warning', title: 'System Maintenance Scheduled', message: 'We will be performing scheduled system maintenance. Service may be temporarily unavailable.' },
                { name: 'New Feature', type: 'success', title: 'New Feature Available', message: 'Check out our latest feature designed to improve your experience!' },
                { name: 'Security Alert', type: 'error', title: 'Security Notice', message: 'We have detected unusual activity. Please review your account settings.' },
                { name: 'Update Available', type: 'info', title: 'Platform Update', message: 'A new update is available. Please refresh to get the latest version.' }
            ];

            function loadAlerts(){
                let alerts = JSON.parse(localStorage.getItem('alerts') || '[]');
                return alerts;
            }

            function saveAlerts(alerts){
                localStorage.setItem('alerts', JSON.stringify(alerts));
            }

            function renderTemplates(){
                const grid = document.getElementById('templates-grid');
                if(!grid) return;
                grid.innerHTML = ALERT_TEMPLATES.map(template => `
                    <div style="background:var(--white);padding:15px;border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all 0.3s;box-shadow:var(--shadow);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="useTemplate('${template.name}', '${template.type}', '${template.title}', '${template.message}')">
                        <div style="font-weight:600;margin-bottom:8px;">${template.name}</div>
                        <div style="font-size:12px;color:var(--text-light);margin-bottom:8px;">${template.message.substring(0, 60)}...</div>
                        <span class="badge ${template.type}">${template.type}</span>
                    </div>
                `).join('');
            }

            function useTemplate(name, type, title, message){
                document.getElementById('alert-title').value = title;
                document.getElementById('alert-message').value = message;
                document.getElementById('alert-type').value = type;
                switchAlertTab('create');
            }

            function getAlertStats(){
                const alerts = loadAlerts();
                const activeAlerts = alerts.filter(a => a.status === 'active');
                const unreadCount = alerts.reduce((sum, a) => sum + (a.unreadCount || 0), 0);
                const thisMonth = alerts.filter(a => {
                    const date = new Date(a.created);
                    const now = new Date();
                    return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                }).length;

                const totalElem = document.getElementById('alert-total');
                const activeElem = document.getElementById('alert-active');
                const unreadElem = document.getElementById('alert-unread');
                const sentElem = document.getElementById('alert-sent');
                
                if(totalElem) totalElem.textContent = alerts.length;
                if(activeElem) activeElem.textContent = activeAlerts.length;
                if(unreadElem) unreadElem.textContent = unreadCount;
                if(sentElem) sentElem.textContent = thisMonth;
                
                console.log('Alert Stats Updated:', { total: alerts.length, active: activeAlerts.length, unread: unreadCount, sent: thisMonth });
            }

            function sortAlertsBy(field){
                currentAlertSort = field;
                currentAlertSortOrder = currentAlertSortOrder === 'asc' ? 'desc' : 'asc';
                const searchInput = document.getElementById('alert-search');
                const typeFilter = document.getElementById('alert-filter-type');
                const priorityFilter = document.getElementById('alert-filter-priority');
                renderAlertsTable(typeFilter.value, priorityFilter.value, searchInput.value);
            }

            function clearAlertFilters(){
                document.getElementById('alert-search').value = '';
                document.getElementById('alert-filter-type').value = '';
                document.getElementById('alert-filter-priority').value = '';
                renderAlertsTable();
            }

            function exportAlerts(){
                const alerts = loadAlerts().filter(a => a.status === 'active' || a.status === 'draft');
                if(alerts.length === 0){
                    alert('No alerts to export');
                    return;
                }
                const csv = 'Title,Type,Priority,Target,Status,Created\n' + alerts.map(a => `"${a.title}","${a.type}","${a.priority}","${a.target}","${a.status}","${new Date(a.created).toLocaleString()}"`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'alerts-' + new Date().toISOString().slice(0,10) + '.csv';
                a.click();
            }

            function renderAlertsTable(filterType = '', filterPriority = '', searchText = ''){
                const alerts = loadAlerts().filter(a => a.status === 'active' || a.status === 'draft');
                const tbody = document.getElementById('alerts-tbody');
                if(!tbody) return;

                let filtered = alerts;
                if(filterType) filtered = filtered.filter(a => a.type === filterType);
                if(filterPriority) filtered = filtered.filter(a => a.priority === filterPriority);
                if(searchText) filtered = filtered.filter(a => a.title.toLowerCase().includes(searchText.toLowerCase()) || a.message.toLowerCase().includes(searchText.toLowerCase()));

                // Sort
                filtered.sort((a, b) => {
                    let aVal = a[currentAlertSort] || a.created;
                    let bVal = b[currentAlertSort] || b.created;
                    if(currentAlertSort === 'priority'){
                        const order = { critical: 0, high: 1, medium: 2, low: 3 };
                        aVal = order[aVal] || 99;
                        bVal = order[bVal] || 99;
                    } else if(currentAlertSort === 'created'){
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    return currentAlertSortOrder === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
                });

                tbody.innerHTML = '';
                if(filtered.length === 0){
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-light);">No alerts found.</td></tr>';
                    return;
                }

                filtered.forEach((alert, idx) => {
                    const typeIcon = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' }[alert.type] || 'üì¢';
                    const priorityColor = { low: '#2ecc71', medium: '#f39c12', high: '#e74c3c', critical: '#c0392b' }[alert.priority] || '#3498db';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="width:30px;"><input type="checkbox" class="alert-checkbox" data-id="${alert.id}" style="width:16px;height:16px;"></td>
                        <td><strong>${alert.title.substring(0, 30)}${alert.title.length > 30 ? '...' : ''}</strong></td>
                        <td><span class="badge ${alert.type}">${typeIcon}</span></td>
                        <td><span style="padding:4px 8px;border-radius:16px;background:${priorityColor};color:white;font-size:11px;font-weight:600;">${alert.priority}</span></td>
                        <td style="font-size:12px;">${alert.target}</td>
                        <td><span class="badge ${alert.status === 'active' ? 'active' : 'pending'}">${alert.status}</span></td>
                        <td style="font-size:12px;">${new Date(alert.created).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons" style="flex-wrap:nowrap;">
                                <button class="btn-sm edit" onclick="viewAlertDetails('${alert.id}')" style="font-size:11px;">View</button>
                                <button class="btn-sm" style="background:#f39c12;color:white;font-size:11px;" onclick="editAlert('${alert.id}')">Edit</button>
                                <button class="btn-sm delete" data-id="${alert.id}" style="font-size:11px;">Del</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Checkboxes
                const selectAllCb = document.getElementById('select-all-alerts');
                if(selectAllCb){
                    selectAllCb.addEventListener('change', function(){
                        document.querySelectorAll('.alert-checkbox').forEach(cb => cb.checked = this.checked);
                    });
                }

                // Delete buttons
                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', function(){
                        const id = this.dataset.id;
                        if(!confirm('Delete this alert?')) return;
                        let alerts = loadAlerts();
                        alerts = alerts.filter(a => a.id !== id);
                        saveAlerts(alerts);
                        renderAlertsTable(filterType, filterPriority, searchText);
                        getAlertStats();
                    });
                });
            }

            function viewAlertDetails(id){
                const alerts = loadAlerts();
                const alert = alerts.find(a => a.id === id);
                if(!alert) return;

                const typeIcon = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' }[alert.type] || 'üì¢';
                const det = document.getElementById('alert-detail-content');
                det.innerHTML = `
                    <p><strong>Title:</strong> ${alert.title}</p>
                    <p><strong>Type:</strong> ${typeIcon} ${alert.type}</p>
                    <p><strong>Priority:</strong> ${alert.priority}</p>
                    <p><strong>Target Audience:</strong> ${alert.target}</p>
                    <p><strong>Status:</strong> ${alert.status}</p>
                    <p><strong>Message:</strong></p>
                    <p style="background:var(--lighter);padding:10px;border-radius:4px;white-space:pre-wrap;border-left:3px solid var(--primary);">${alert.message}</p>
                    <p><strong>Created:</strong> ${new Date(alert.created).toLocaleString()}</p>
                    ${alert.schedule ? '<p><strong>Scheduled:</strong> ' + new Date(alert.schedule).toLocaleString() + '</p>' : ''}
                    ${alert.expiry ? '<p><strong>Expires:</strong> ' + alert.expiry + '</p>' : ''}
                    <p><strong>Users Seen:</strong> ${alert.unreadCount || 0}</p>
                `;
                window.currentAlertId = id;
                openModal('alertViewModal');
            }

            function editAlert(id){
                const alerts = loadAlerts();
                const alert = alerts.find(a => a.id === id);
                if(!alert) return;

                document.getElementById('edit-alert-id').value = id;
                document.getElementById('edit-alert-title').value = alert.title;
                document.getElementById('edit-alert-message').value = alert.message;
                document.getElementById('edit-alert-type').value = alert.type;
                document.getElementById('edit-alert-priority').value = alert.priority;
                document.getElementById('edit-alert-target').value = alert.target;
                document.getElementById('edit-alert-status').value = alert.status;
                document.getElementById('edit-alert-expiry').value = alert.expiry || '';
                
                closeModal('alertViewModal');
                openModal('alertEditModal');
            }

            function editAlertFromModal(){
                editAlert(window.currentAlertId);
            }

            function deleteAlertFromModal(){
                if(!window.currentAlertId) return;
                if(!confirm('Delete this alert permanently?')) return;
                let alerts = loadAlerts();
                alerts = alerts.filter(a => a.id !== window.currentAlertId);
                saveAlerts(alerts);
                closeModal('alertViewModal');
                renderAlertsTable();
                getAlertStats();
            }

            function renderArchive(){
                const alerts = loadAlerts().filter(a => {
                    if(a.status === 'inactive' || a.status === 'archived') return true;
                    if(a.expiry){
                        const exp = new Date(a.expiry);
                        return exp < new Date();
                    }
                    return false;
                });
                const tbody = document.getElementById('archive-tbody');
                if(!tbody) return;

                tbody.innerHTML = '';
                if(alerts.length === 0){
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">No archived alerts.</td></tr>';
                    return;
                }

                alerts.forEach(alert => {
                    const typeIcon = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' }[alert.type] || 'üì¢';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${alert.title}</strong></td>
                        <td><span class="badge ${alert.type}">${typeIcon}</span></td>
                        <td>${new Date(alert.created).toLocaleDateString()}</td>
                        <td>${alert.expiry || 'N/A'}</td>
                        <td>${alert.target}</td>
                        <td><button class="btn-sm delete" onclick="deleteArchivedAlert('${alert.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function deleteArchivedAlert(id){
                if(!confirm('Delete archived alert?')) return;
                let alerts = loadAlerts();
                alerts = alerts.filter(a => a.id !== id);
                saveAlerts(alerts);
                renderArchive();
            }

            const editForm = document.getElementById('alert-edit-form');
            if(editForm){
                editForm.addEventListener('submit', function(e){
                    e.preventDefault();
                    const alerts = loadAlerts();
                    const id = document.getElementById('edit-alert-id').value;
                    const alert = alerts.find(a => a.id === id);
                    if(alert){
                        alert.title = document.getElementById('edit-alert-title').value;
                        alert.message = document.getElementById('edit-alert-message').value;
                        alert.type = document.getElementById('edit-alert-type').value;
                        alert.priority = document.getElementById('edit-alert-priority').value;
                        alert.target = document.getElementById('edit-alert-target').value;
                        alert.status = document.getElementById('edit-alert-status').value;
                        alert.expiry = document.getElementById('edit-alert-expiry').value || null;
                        saveAlerts(alerts);
                        renderAlertsTable();
                        getAlertStats();
                        closeModal('alertEditModal');
                        alert('‚úÖ Alert updated successfully!');
                    }
                });
            }

            // Filter and search handlers
            const searchInput = document.getElementById('alert-search');
            const typeFilter = document.getElementById('alert-filter-type');
            const priorityFilter = document.getElementById('alert-filter-priority');

            if(searchInput) searchInput.addEventListener('input', () => renderAlertsTable(typeFilter.value, priorityFilter.value, searchInput.value));
            if(typeFilter) typeFilter.addEventListener('change', () => renderAlertsTable(typeFilter.value, priorityFilter.value, searchInput.value));
            if(priorityFilter) priorityFilter.addEventListener('change', () => renderAlertsTable(typeFilter.value, priorityFilter.value, searchInput.value));

            // Initialize alerts with small delay to ensure DOM is ready
            setTimeout(() => {
                getAlertStats();
                renderAlertsTable();
                renderTemplates();
            }, 50);
            
            // Initialize message stats on dashboard
            updateMessageStats();
            
            // Listen for storage changes (when user submits new messages or alerts change)
            window.addEventListener('storage', (e) => {
                if(e.key === 'contactMessages'){
                    updateMessageStats();
                    renderMessagesTable();
                }
                if(e.key === 'alerts'){
                    getAlertStats();
                    renderAlertsTable();
                }
            });
        });

        /* === Admin Chat: conversations between Admin, Users and Agents === */
        let currentAdminChatId = null;

        function loadAdminChats(){ return JSON.parse(localStorage.getItem('adminChats') || '[]'); }
        function saveAdminChats(chats){ localStorage.setItem('adminChats', JSON.stringify(chats)); }

        function renderAdminChatList(){
            const container = document.getElementById('admin-chats-list');
            if(!container) return;
            
            // Load registered users to filter property chats
            let users = JSON.parse(localStorage.getItem('users') || 'null');
            if(!users || !Array.isArray(users)) users = [];
            try{
                const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                if(wispaUser && (wispaUser.email || wispaUser.username)){
                    const ident = wispaUser.email || wispaUser.username;
                    const exists = users.find(u => (u.email || '').toLowerCase() === (ident||'').toLowerCase() || (u.name || '').toLowerCase() === (ident||'').toLowerCase());
                    if(!exists){
                        users.unshift({ id: Date.now(), name: wispaUser.username || ident, email: wispaUser.email || '', role: 'User', joined: new Date().toLocaleDateString(), status: 'Active' });
                    }
                }
            }catch(e){}
            
            // Combine admin chats and property chats, filter duplicates
            let adminChats = loadAdminChats();
            let propertyChats = [];
            try {
                const userPropertyChatMap = {};
                for(let i = 0; i < localStorage.length; i++){
                    const key = localStorage.key(i);
                    if(key && /^wispaMessages_.+_property-/.test(key) && !key.endsWith('_backup')){
                        const match = key.match(/^wispaMessages_(.+?)_property-(.+)$/);
                        if(!match) continue;
                        const userId = match[1];
                        const propertyId = match[2];
                        const messages = JSON.parse(localStorage.getItem(key) || '[]');
                        if(messages.length > 0){
                            const hasAdmin = messages.some(m => m.sender === 'admin');
                            const hasUserOrAgent = messages.some(m => m.sender === 'user' || m.sender === 'agent');
                            if(!(hasAdmin && hasUserOrAgent)) continue;
                            const chatId = 'property-' + propertyId + '-' + userId;
                            const userMsg = messages.find(m => m.sender === 'user');
                            const userName = (userMsg?.userName || 'User').trim();
                            const userEmail = (userMsg?.userEmail || '').trim();
                            userPropertyChatMap[chatId] = {
                                id: chatId,
                                participantName: userName + ' - Property ' + propertyId,
                                participantId: userId,
                                userEmail: userEmail,
                                isProperty: true,
                                propertyId: propertyId,
                                userId: userId,
                                lastMessage: '',
                                timestamp: '',
                                messageCount: messages.length,
                                unread: 0
                            };
                            const lastMsg = messages[messages.length - 1];
                            userPropertyChatMap[chatId].lastMessage = lastMsg.text || 'No messages';
                            userPropertyChatMap[chatId].timestamp = lastMsg.ts ? new Date(lastMsg.ts).toISOString() : new Date().toISOString();
                            const adminUnread = JSON.parse(localStorage.getItem('adminUnread') || '{}');
                            userPropertyChatMap[chatId].unread = adminUnread[chatId] || 0;
                        }
                    }
                }
                propertyChats = Object.values(userPropertyChatMap);
            }catch(e){}

            // Filter out adminChats that match a property chat (same participantId and propertyId)
            let filteredAdminChats = adminChats.filter(ac => {
                if(ac.isProperty && ac.userId && ac.propertyId){
                    // If a property chat exists for this user/property, skip adminChats duplicate
                    return !propertyChats.some(pc => pc.userId === ac.userId && pc.propertyId === ac.propertyId);
                }
                // Otherwise, keep
                return true;
            });
            // Merge and sort
            let allChats = filteredAdminChats.concat(propertyChats);
            allChats.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            if(allChats.length === 0){ 
                container.innerHTML = '<div style="padding:12px;color:var(--text-light);">No conversations yet.</div>'; 
                return; 
            }
            container.innerHTML = allChats.map(c => `
                <div style="padding:12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="openChatFullView('${c.id}')">
                    <div>
                        <div style="font-weight:600;">${c.participantName || c.participantId}</div>
                        <div style="font-size:12px;color:var(--text-light);">${c.lastMessage ? c.lastMessage.substring(0,60) : 'No messages yet'}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:12px;color:var(--text-light);">${new Date(c.timestamp).toLocaleDateString()}</div>
                        ${c.unread ? `<div style="background:#e74c3c;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;margin-top:6px;">${c.unread}</div>` : ''}
                        ${c.isProperty ? `<div style="background:#27ae60;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;margin-top:6px;">üè† Property</div>` : ''}
                    </div>
                </div>
            `).join('');
            // keep conversation pane hidden - individual conversations open in their own page
        }

        function adminNewConversation(){
            const identifier = prompt('Enter registered user email or username to start a conversation:');
            if(!identifier) return;
            // Load users directly to avoid depending on loadUsers() being defined
            let users = JSON.parse(localStorage.getItem('users') || 'null');
            if(!users || !Array.isArray(users)) users = [];
            try{
                const wispaUser = JSON.parse(localStorage.getItem('wispaUser') || '{}');
                if(wispaUser && (wispaUser.email || wispaUser.username)){
                    const ident = wispaUser.email || wispaUser.username;
                    const exists = users.find(u => (u.email || '').toLowerCase() === (ident||'').toLowerCase() || (u.name || '').toLowerCase() === (ident||'').toLowerCase());
                    if(!exists){
                        users.unshift({ id: Date.now(), name: wispaUser.username || ident, email: wispaUser.email || '', role: 'User', joined: new Date().toLocaleDateString(), status: 'Active' });
                    }
                }
            }catch(e){}
            const idLower = identifier.trim().toLowerCase();
            const found = users.find(u => ((u.email||'').toLowerCase() === idLower) || ((u.name||u.username||'').toLowerCase() === idLower));
            if(!found){ alert('User not found. Conversations can only be started with registered users.'); return; }
            const participantId = found.email || found.name || found.username;
            const participantName = found.name || found.username || participantId;
            const chats = loadAdminChats();
            // avoid duplicate chat for same participant
            let existing = chats.find(c => (c.participantId||'').toLowerCase() === (participantId||'').toLowerCase());
            if(!existing){
                const id = 'chat-' + Date.now();
                const chat = { id, participantId, participantName, messages: [], lastMessage: '', timestamp: new Date().toISOString(), unread: 0 };
                chats.unshift(chat);
                saveAdminChats(chats);
                existing = chat;
            }
            renderAdminChatList();
            window.location.href = 'admin-chat.html?chat=' + encodeURIComponent(existing.id);
        }

        function openAdminChat(chatId){
            const chats = loadAdminChats();
            const chat = chats.find(c => c.id === chatId);
            if(!chat) return;
            currentAdminChatId = chatId;
            document.getElementById('admin-chat-title').textContent = chat.participantName || chat.participantId;
            document.getElementById('admin-chat-sub').textContent = chat.participantId;
            chat.unread = 0;
            saveAdminChats(chats);
            updateChatNotificationsFor(chat);
            renderAdminChatList();
            renderAdminMessages(chat);
            // show chat pane
            const pane = document.getElementById('admin-chat-pane'); if(pane) pane.style.display = 'flex';
        }

        function renderAdminMessages(chat){
            const container = document.getElementById('admin-chat-messages');
            if(!container) return;
            if(!chat || !Array.isArray(chat.messages) || chat.messages.length === 0){
                container.innerHTML = '<div style="padding:12px;color:var(--text-light);">No messages in this conversation.</div>';
                // ensure pane visible only when a chat is selected
                const pane = document.getElementById('admin-chat-pane'); if(pane) pane.style.display = currentAdminChatId ? 'flex' : 'none';
                return;
            }
            container.innerHTML = chat.messages.map(m => `
                <div style="display:flex;${m.from === 'Admin' ? 'justify-content:flex-end' : 'justify-content:flex-start'};margin-bottom:8px;">
                    <div style="max-width:75%;background:${m.from === 'Admin' ? '#3498db' : '#fff'};color:${m.from === 'Admin' ? '#fff' : '#222'};padding:10px;border-radius:10px;box-shadow:var(--shadow);">
                        <div style="font-size:14px;white-space:pre-wrap;">${escapeHtml(m.text)}</div>
                        <div style="font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px;text-align:${m.from === 'Admin' ? 'right' : 'left'};">${new Date(m.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        // Admin search for users/agents to open or create conversation
        function adminSearchUsers(q){
            const resultsEl = document.getElementById('admin-chat-search-results');
            if(!resultsEl) return;
            const val = (q||'').trim();
            if(!val){ resultsEl.style.display = 'none'; resultsEl.innerHTML = ''; return; }
            const results = searchRegisteredUsers(val);
            if(!results || results.length === 0){ resultsEl.innerHTML = '<div style="padding:10px;color:var(--text-light);">No users found</div>'; resultsEl.style.display = 'block'; return; }
            resultsEl.innerHTML = results.map(u=> `
                <div style="padding:8px;border-bottom:1px solid var(--border);cursor:pointer;" onclick="openOrCreateFromSearch('${u.id.replace(/'/g,"\\'")}', '${(u.username||u.email||u.id).replace(/'/g,"\\'")}')">
                    <div style="font-weight:600;">${u.username || u.id}</div>
                    <div style="font-size:12px;color:var(--text-light);">${u.email || ''}</div>
                </div>
            `).join('');
            resultsEl.style.display = 'block';
        }

        function openOrCreateFromSearch(participantId, participantName){
            const resultsEl = document.getElementById('admin-chat-search-results'); if(resultsEl){ resultsEl.style.display='none'; }
            const input = document.getElementById('admin-chat-search'); if(input){ input.value = ''; }
            const chats = loadAdminChats();
            let chat = chats.find(c => c.participantId === participantId || c.participantId === participantId.toLowerCase());
            if(!chat){
                const id = 'chat-' + Date.now();
                chat = { id, participantId, participantName, messages: [], lastMessage: '', timestamp: new Date().toISOString(), unread: 0 };
                chats.unshift(chat);
                saveAdminChats(chats);
            }
            renderAdminChatList();
            // open the conversation in its own page
            window.location.href = 'admin-chat.html?chat=' + encodeURIComponent(chat.id);
        }

        function sendAdminMessage(){
            const input = document.getElementById('chat-full-input') || document.getElementById('admin-chat-input');
            if(!input) return;
            const text = input.value.trim();
            if(!text) return;
            if(!currentAdminChatId){ alert('Select a conversation first or create a new one.'); return; }
            const chats = loadAdminChats();
            const chat = chats.find(c => c.id === currentAdminChatId);
            if(!chat) return;
            const msg = { id: 'm-' + Date.now(), from: 'Admin', text, timestamp: new Date().toISOString() };
            chat.messages.push(msg);
            chat.lastMessage = text;
            chat.timestamp = new Date().toISOString();
            chat.unread = 0;
            saveAdminChats(chats);

            // If this is a property chat, also update the user-property conversation in localStorage
            if(chat.isProperty && chat.userId && chat.propertyId){
                const key = 'wispaMessages_' + chat.userId + '_property-' + chat.propertyId;
                let messages = [];
                try { messages = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){}
                messages.push({ sender: 'admin', text: text, ts: Date.now() });
                localStorage.setItem(key, JSON.stringify(messages));
                try { localStorage.setItem(key + '_backup', JSON.stringify(messages)); } catch(e){}
            }

            // refresh either full view or inline messages
            if(document.getElementById('chat-full-messages')){
                openChatFullView(chat.id);
            } else {
                renderAdminMessages(chat);
            }
            renderAdminChatList();
            input.value = '';
            input.focus();
            updateChatNotificationsFor(chat, msg);
            let activity = JSON.parse(localStorage.getItem('activityLog') || '[]');
            activity.push({ type: 'admin-chat-sent', chatId: chat.id, to: chat.participantId, message: text, timestamp: new Date().toISOString() });
            localStorage.setItem('activityLog', JSON.stringify(activity));
        }

        function updateChatNotificationsFor(chat, latestMsg){
            let list = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
            const idx = list.findIndex(c => c.id === chat.id);
            const entry = {
                id: chat.id,
                userName: chat.participantName || chat.participantId,
                conversationTitle: chat.participantName || chat.participantId,
                lastMessage: latestMsg ? latestMsg.text : (chat.lastMessage || ''),
                timestamp: chat.timestamp || new Date().toISOString(),
                read: true
            };
            if(idx > -1) { list[idx] = entry; } else { list.unshift(entry); }
            localStorage.setItem('chatNotifications', JSON.stringify(list));
        }

        function openChatFullView(chatId){
            // deprecated: open conversations in separate page now
            if(!chatId) return;
            window.location.href = 'admin-chat.html?chat=' + encodeURIComponent(chatId);
        }

        function backToChatList(){
            document.getElementById('chat-fullview').style.display = 'none';
            currentAdminChatId = null;
        }

        function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\'/g,'&#39;'); }

        // Listen for storage changes to update chats in real time
        window.addEventListener('storage', (e) => { 
            // Listen for admin chats, notifications, property message updates, and unread count changes
            if(e.key === 'adminChats' || e.key === 'chatNotifications' || e.key === 'adminUnread' || e.key === 'adminChatUnreadUpdated' || (e.key && /^wispaMessages_[^_]+_property-/.test(e.key))){ 
                renderAdminChatList(); 
                const cur = loadAdminChats().find(c => c.id === currentAdminChatId); 
                if(cur) renderAdminMessages(cur); 
            } 
        });
        
        document.addEventListener('DOMContentLoaded', function(){ 
            // Initialize chats with a delay to ensure DOM is ready
            setTimeout(() => {
                // Initialize with sample conversations if none exist
                let adminChats = loadAdminChats();
                if (!Array.isArray(adminChats) || adminChats.length === 0) {
                    adminChats = [
                        {
                            id: 'sample-chat-1',
                            participantId: 'john.doe@example.com',
                            participantName: 'John Doe',
                            messages: [
                                { id: 'm-1', from: 'User', text: 'Hi, I have a question about the property listing', timestamp: new Date(Date.now() - 3600000).toISOString() },
                                { id: 'm-2', from: 'Admin', text: 'Hello! I\'ll be happy to help. What would you like to know?', timestamp: new Date(Date.now() - 3500000).toISOString() }
                            ],
                            lastMessage: 'Hello! I\'ll be happy to help. What would you like to know?',
                            timestamp: new Date(Date.now() - 3500000).toISOString(),
                            unread: 0
                        },
                        {
                            id: 'sample-chat-2',
                            participantId: 'agent.smith@example.com',
                            participantName: 'Smith Real Estate Agent',
                            messages: [
                                { id: 'm-3', from: 'User', text: 'Just checking in on the property status', timestamp: new Date(Date.now() - 7200000).toISOString() }
                            ],
                            lastMessage: 'Just checking in on the property status',
                            timestamp: new Date(Date.now() - 7200000).toISOString(),
                            unread: 1
                        }
                    ];
                    saveAdminChats(adminChats);
                }
                renderAdminChatList();
            }, 50);
            setTimeout(() => {
                if(typeof filterNotificationAlerts === 'function') {
                    filterNotificationAlerts('all');
                }
            }, 100);
        });
        // Support opening a specific admin tab via URL hash (e.g. admin.html#chat)
        window.addEventListener('load', function(){
            try{
                let tab = null;
                if(location.hash){
                    tab = location.hash.replace('#','');
                } else {
                    tab = localStorage.getItem('adminCurrentTab') || 'overview';
                }
                if(tab) setTimeout(()=> { try{ switchTab(tab); } catch(e){} }, 50);
            }catch(e){/* ignore */}
        });
    </script>
</body>
</html>
                  