<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Conversation - Wispa Real Estate</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <div class="main-container">
      <section class="services-hero">
        <div class="hero-content">
          <p class="eyebrow">Conversation</p>
          <h1>Messages</h1>
          <p class="lead">Open a conversation and message your user or agent.</p>
        </div>
      </section>
      <section class="services-section">
        <div style="max-width:1000px;margin:20px auto;">
          <div id="chatBox" class="chat-box" style="background:var(--white);border-radius:8px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;height:640px;">
            <div id="messages-area" style="flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:transparent"></div>
            <div style="border-top:1px solid var(--border);padding:12px;display:flex;gap:8px;align-items:center;">
              <input id="chatInput" type="text" placeholder="Type a message..." style="flex:1;padding:10px;border:1px solid var(--border);border-radius:6px;">
              <label for="fileInput" style="margin:0 8px 0 0;cursor:pointer;display:inline-flex;align-items:center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.5 6.5L7.5 15.5C6.67 16.33 5.33 16.33 4.5 15.5C3.67 14.67 3.67 13.33 4.5 12.5L13.5 3.5C15.43 1.57 18.57 1.57 20.5 3.5C22.43 5.43 22.43 8.57 20.5 10.5L11.5 19.5C8.57 22.43 3.43 22.43 0.5 19.5C-2.43 16.57-2.43 11.43 0.5 8.5L9.5 0.5" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </label>
              <input type="file" id="fileInput" style="display:none;" title="Attach file" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif" multiple>
              <div id="selectedFiles" style="font-size:13px;color:#555;margin-right:8px;max-width:220px;overflow-x:auto;white-space:nowrap;"></div>
              <button id="emojiBtn" style="background:none;border:none;font-size:22px;cursor:pointer;" title="Insert emoji">üòä</button>
              <button id="sendBtn" class="btn">Send</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
  <footer>
    <p style="text-align:center">&copy; 2026 Wispa Real Estate. All rights reserved.</p>
  </footer>

  <script src="script.js"></script>
  <script>
    // Admin cache shim (preserve existing helpers)
    (async function(){
      const keys = ['adminChats','properties','adminProfile','agentProfile','wispaUser'];
      window._adminCache = window._adminCache || {};
      for (const k of keys) {
        try { const v = window.adminGet ? await window.adminGet(k) : null; window._adminCache[k] = v === null || v === undefined ? null : JSON.stringify(v); } catch(e){ window._adminCache[k] = null; }
      }
      window.adminLoadKeySync = function(key) {
        try { if (window._adminCache && typeof window._adminCache[key] !== 'undefined' && window._adminCache[key] !== null) { try { return JSON.parse(window._adminCache[key]); } catch(e) { return window._adminCache[key]; } } } catch(e) {}
        return null;
      };
      window.adminSaveKeySync = function(key, value) {
        try { if (window.adminSet) window.adminSet(key, value).catch(()=>{}); if (window._adminCache) window._adminCache[key] = JSON.stringify(value); } catch(e) {}
      };
    })();

    // Conversation page script (redesigned)
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const convId = urlParams.get('id') || 'conv-1';
      const messagesEl = document.getElementById('messages-area');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const fileInput = document.getElementById('fileInput');
      const selectedFilesDiv = document.getElementById('selectedFiles');
      const emojiBtn = document.getElementById('emojiBtn');

      function getAllPossibleKeys(){
        const keys = [];
        keys.push('adminMessages_' + convId);
        keys.push('wispaMessages_' + convId);
        try{ const adminChats = (window.adminLoadKeySync ? (window.adminLoadKeySync('adminChats') || []) : (window._adminCache && window._adminCache['adminChats'] ? JSON.parse(window._adminCache['adminChats']) : [])); const meta = Array.isArray(adminChats) ? adminChats.find(c => c && c.id && (c.id === convId || String(c.id).indexOf(String(convId)) !== -1)) : null; if(meta && meta.userId) keys.push('wispaMessages_' + meta.userId + '_' + convId); }catch(e){}
        const m2 = convId.match(/^property-(\d+)-(WISPA-[^_]+)/);
        if(m2) keys.push('wispaMessages_' + m2[2] + '_property-' + m2[1]);
        return keys;
      }

      function loadMessages(){
        const keys = getAllPossibleKeys(); const out = []; const seen = new Set();
        for(const k of keys){
          try{ const raw = window.adminLoadKeySync ? window.adminLoadKeySync(k) : (window._adminCache && window._adminCache[k] ? JSON.parse(window._adminCache[k]) : null); const arr = Array.isArray(raw) ? raw : (typeof raw === 'string' ? JSON.parse(raw) : null); if(Array.isArray(arr)){ for(const m of arr){ const sig = (m.time||m.ts||'') + '|' + (m.text||'') + '|' + (m.sender||''); if(!seen.has(sig)){ out.push(m); seen.add(sig); } } } }catch(e){}
        }
        out.sort((a,b)=>(a.time||a.ts||0)-(b.time||b.ts||0));
        return out;
      }

      function saveMessages(arr){ const keys = getAllPossibleKeys(); for(const k of keys){ try{ if(window.adminSaveKeySync) window.adminSaveKeySync(k, arr); else if(window._adminCache) window._adminCache[k] = JSON.stringify(arr); }catch(e){} } }

      function escapeHtml(s){ try{return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }catch(e){return '';} }

      function buildMessageHtml(m){ const isAdmin = (m.sender === 'admin' || (m.senderName && m.senderName.toLowerCase && m.senderName.toLowerCase()==='admin')); const username = m.senderName || m.userName || m.sender || (isAdmin? 'Admin':'User'); const ts = m.time ? new Date(m.time).toLocaleString() : (m.ts ? new Date(m.ts).toLocaleString() : ''); const txt = escapeHtml(m.text||''); return `<div style="display:flex;justify-content:${isAdmin?'flex-end':'flex-start'};margin-bottom:12px;"><div style="max-width:70%;background:${isAdmin?'#3498db':'#fff'};color:${isAdmin?'#fff':'#222'};padding:10px;border-radius:10px;border:1px solid #eee;">` + `<div style="font-size:12px;font-weight:600;margin-bottom:6px;color:${isAdmin?'#fff':'#666'};">${escapeHtml(username)}</div>` + `<div style="white-space:pre-wrap">${txt}</div>` + `<div style="font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px;text-align:${isAdmin?'right':'left'};">${escapeHtml(ts)}</div>` + `</div></div>`; }

      function getPropertyPreviewCard(){ if(!convId.startsWith('property-')) return ''; const m = convId.match(/^property-(\d+)-/); if(!m) return ''; try{ const props = (window.adminLoadKeySync ? (window.adminLoadKeySync('properties') || []) : (window._adminCache && window._adminCache['properties'] ? JSON.parse(window._adminCache['properties']) : [])); const p = Array.isArray(props) ? props.find(x=>String(x.id)===String(m[1])) : null; if(!p) return ''; const badge = p.hot ? 'üî• Hot Property' : (p.featured ? '‚≠ê Featured Property' : '‚úÖ Available Property'); const img = p.images && p.images.length ? p.images[0] : ''; return `<div id="messages-property-card" style="padding:12px;border-radius:8px;background:#f7fafd;margin-bottom:10px;border:1px solid var(--border);max-width:900px;">` + `<a href="property-detail.html?id=${p.id}&conversation=true" style="text-decoration:none;color:inherit;display:flex;gap:18px;align-items:center;">` + `<div style="width:110px;height:80px;flex:0 0 110px;">${img?`<img src="${img}" style="width:110px;height:80px;object-fit:cover;border-radius:8px;">`:'<div style="width:110px;height:80px;border-radius:8px;background:#f7f7f7;"></div>'}</div>` + `<div style="flex:1;min-width:0"><div style="font-weight:700;font-size:17px;">${escapeHtml(p.title||p.name||'Property')}</div><div style="color:var(--secondary)">${escapeHtml(p.location||'')} <span style="background:#3498db;color:#fff;padding:2px 8px;border-radius:6px;margin-left:8px;">${badge}</span></div></div>` + `</a></div>`; }catch(e){return ''; } }

      function render(){ const msgs = loadMessages(); try{ const lastMsg = msgs && msgs.length ? (msgs[msgs.length-1].time || msgs[msgs.length-1].ts || '') : ''; const lastSig = String(lastMsg) + '|' + String(msgs.length) + '|' + String(convId); if(messagesEl && messagesEl.dataset && messagesEl.dataset.lastSig === lastSig) return; if(messagesEl && messagesEl.dataset) messagesEl.dataset.lastSig = lastSig; }catch(e){}
        let hadFocus=false, selStart=null, selEnd=null; try{ hadFocus = (document.activeElement === inputEl); selStart = inputEl.selectionStart; selEnd = inputEl.selectionEnd; }catch(e){}
        try{ const existing = document.getElementById('messages-property-card'); if(existing && existing.parentNode) existing.parentNode.removeChild(existing); }catch(e){}
        const propCard = getPropertyPreviewCard(); if(propCard && messagesEl && messagesEl.parentNode){ const tmp = document.createElement('div'); tmp.innerHTML = propCard; messagesEl.parentNode.insertBefore(tmp.firstElementChild, messagesEl); }
        let html = ''; if(!msgs || msgs.length===0){ html = '<p style="text-align:center;color:var(--text-light);">No messages yet. Start the conversation below!</p>'; messagesEl.innerHTML = html; return; } for(const m of msgs) html += buildMessageHtml(m);
        messagesEl.innerHTML = html; setTimeout(()=>{ try{ messagesEl.scrollTop = messagesEl.scrollHeight; }catch(e){}; try{ if(hadFocus){ inputEl.focus(); if(selStart!=null && selEnd!=null) inputEl.setSelectionRange(selStart, selEnd); } }catch(e){} }, 0);
      }

      // Wire UI
      if(emojiBtn && inputEl){ emojiBtn.addEventListener('click', ()=>{ const e = prompt('Insert emoji','üòä'); if(e){ inputEl.value += e; try{ if(document.activeElement !== inputEl) inputEl.focus(); }catch(err){} } }); }
      if(fileInput && selectedFilesDiv){ fileInput.addEventListener('change', ()=>{ try{ if(fileInput.files && fileInput.files.length){ const names = Array.from(fileInput.files).map(f=>f.name); selectedFilesDiv.textContent = names.join(', '); sendBtn.disabled = false; } else { selectedFilesDiv.textContent=''; sendBtn.disabled=false; } }catch(e){} }); }
      if(sendBtn){ sendBtn.addEventListener('click', ()=>{ try{ const val = (inputEl && inputEl.value) ? inputEl.value.trim() : ''; if(!val && !(fileInput && fileInput.files && fileInput.files.length)) return; const msgs = loadMessages(); const now = Date.now(); let adminProfile = {}; try{ adminProfile = (window.adminLoadKeySync ? window.adminLoadKeySync('adminProfile') : (window._adminCache && window._adminCache['adminProfile'] ? JSON.parse(window._adminCache['adminProfile']) : null)) || {}; }catch(e){}
            if(fileInput && fileInput.files && fileInput.files.length){ for(const f of Array.from(fileInput.files)){ msgs.push({ sender:'admin', senderName: adminProfile.adminName||'Admin', senderAvatar: adminProfile.adminAvatar||'', text: '[File] '+f.name, fileName: f.name, fileType: f.type, time: now, ts: now }); } fileInput.value=''; selectedFilesDiv.textContent=''; }
            if(val){ msgs.push({ sender:'admin', senderName: adminProfile.adminName||'Admin', senderAvatar: adminProfile.adminAvatar||'', text: val, time: now, ts: now }); }
            saveMessages(msgs); if(inputEl) inputEl.value=''; render(); const keys = getAllPossibleKeys(); for(const k of keys){ try{ const cur = window.adminLoadKeySync ? (window.adminLoadKeySync(k)||[]) : (window._adminCache && window._adminCache[k] ? JSON.parse(window._adminCache[k]) : []); if(window.adminSaveKeySync) window.adminSaveKeySync(k, cur||[]); }catch(e){} }
          }catch(e){ console.warn('send failed', e); } }); }
      if(inputEl){ inputEl.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); if(sendBtn) sendBtn.click(); } }); }
      window.addEventListener('storage', function(e){ if(!e.key) return; try{ render(); }catch(e){} });

      // Expose for existing handlers
      window.render = render; window.loadMessages = loadMessages; window.saveMessages = saveMessages;
      try{ render(); }catch(e){ console.warn('render failed', e); }
    })();
  </script>
</body>
</html>
