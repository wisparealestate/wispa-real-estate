<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Messages - Wispa Real Estate</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header and navigation removed -->

    <main>
        <div class="main-container">
            <section class="services-hero">
                <div class="hero-content">
                    <p class="eyebrow">Conversation</p>
                    <h1>Messages</h1>
                    <p class="lead">Open conversation and message your agent. This view is opened when selecting a conversation from the list.</p>
                </div>
            </section>

            <section class="services-section">
                <div style="max-width:900px;margin:20px auto;">
                    <div id="chatBox" class="chat-box" style="background:var(--white);border-radius:8px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;height:520px;">
                        <div id="messages" style="flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:transparent"></div>
                        <div style="border-top:1px solid var(--border);padding:12px;display:flex;gap:8px;align-items:center;">
                            <input id="chatInput" type="text" placeholder="Type a message..." style="flex:1;padding:10px;border:1px solid var(--border);border-radius:6px;">
                            <button id="sendBtn" class="btn">Send</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p style="text-align:center">&copy; 2026 Wispa Real Estate. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        (async function(){
            // Check if user is logged in via server session
            const userObj = await window.getCurrentUser();
            if (!userObj) {
                document.getElementById('messages').innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text);">Please <a href="login.html">login</a> to view messages.</p>';
                return;
            }

            const userId = userObj.id;
            
            const urlParams = new URLSearchParams(window.location.search);
            const convId = urlParams.get('conv') || 'conv-1';
            const messagesEl = document.getElementById('messages');
            const inputEl = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

            // Render conversation messages
            function renderList(list){
                messagesEl.innerHTML = '';
                if (!list || list.length === 0) {
                    messagesEl.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:20px;">No messages yet. Start the conversation!</p>';
                    return;
                }
                list.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'chat-message ' + (m.sender === 'user' ? 'sent' : 'received');
                    div.style.maxWidth = '78%';
                    div.style.padding = '10px 12px';
                    div.style.borderRadius = '10px';
                    div.style.alignSelf = m.sender === 'user' ? 'flex-end' : 'flex-start';
                    div.style.background = m.sender === 'user' ? 'var(--primary)' : 'var(--light)';
                    div.style.color = m.sender === 'user' ? '#fff' : 'var(--text)';
                    div.innerHTML = `<div style="font-size:14px;margin-bottom:6px">${escapeHtml(m.text)}</div><div style="font-size:11px;opacity:0.7;text-align:${m.sender==='user'?'right':'left'}">${new Date(m.ts).toLocaleTimeString()}</div>`;
                    messagesEl.appendChild(div);
                });
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            // Load initial messages from in-memory store or subscription
            const key = 'wispaMessages_' + userId + '_' + convId;
            const adminKey = 'adminMessages_' + convId;
            const legacyKey = 'wispaMessages_' + convId;

            function loadMessages(){
                window._wispaMessages = window._wispaMessages || {};
                const all = [];
                const seen = new Set();
                const candidates = [ window._wispaMessages[key] || [], window._wispaMessages[adminKey] || [], window._wispaMessages[legacyKey] || [] ];
                candidates.forEach(msgs => {
                    if (Array.isArray(msgs)) {
                        msgs.forEach(m => {
                            const sig = (m.time||m.ts||'')+'|'+(m.text||'')+'|'+(m.sender||'');
                            if (!seen.has(sig)) { all.push(m); seen.add(sig); }
                        });
                    }
                });
                all.sort((a,b) => { const ta = a.time || a.ts || 0; const tb = b.time || b.ts || 0; return ta - tb; });
                return all;
            }
            renderList(loadMessages());

            // Clear unread count for this conversation (in-memory)
            try {
                window._wispaConversations = window._wispaConversations || {};
                const convsKey = 'conversations_' + userId;
                const convs = window._wispaConversations[convsKey] || [];
                const found = convs.find(c => c.id === convId);
                if (found && found.unread && found.unread > 0) {
                    found.unread = 0;
                    window._wispaConversations[convsKey] = convs;
                }
            } catch (e) {}

            // Listen for storage changes (ignored; in-memory only). If subscribe available, use it.
            if (window.subscribeConversation) {
                window.subscribeConversation(convId, (list) => renderList(list || []));
            }

            function send(text){
                if (!text || !text.trim()) return;
                const now = Date.now();
                const msg = { sender: 'user', text: text.trim(), ts: now, time: now };
                window._wispaMessages = window._wispaMessages || {};
                window._wispaMessages[key] = window._wispaMessages[key] || loadMessages();
                window._wispaMessages[key].push(msg);
                // also push to admin view
                window._wispaMessages[adminKey] = window._wispaMessages[adminKey] || [];
                const sig = msg.ts + '|' + msg.text + '|' + msg.sender;
                const exists = window._wispaMessages[adminKey].some(m => ((m.ts||m.time) + '|' + m.text + '|' + m.sender) === sig);
                if (!exists) window._wispaMessages[adminKey].push(msg);
                inputEl.value = '';
                renderList(loadMessages());
            }

            sendBtn.addEventListener('click', ()=> send(inputEl.value));
            inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); send(inputEl.value); } });
        })();
    </script>
</body>
</html>
