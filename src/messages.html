<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Messages - Wispa Real Estate</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header and navigation removed -->

    <main>
        <div class="main-container">
            <section class="services-hero">
                <div class="hero-content">
                    <p class="eyebrow">Conversation</p>
                    <h1>Messages</h1>
                    <p class="lead">Open conversation and message your agent. This view is opened when selecting a conversation from the list.</p>
                </div>
            </section>

            <section class="services-section">
                <div style="max-width:900px;margin:20px auto;">
                    <div id="chatBox" class="chat-box" style="background:var(--white);border-radius:8px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;height:520px;">
                        <div id="messages" style="flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:transparent"></div>
                        <div style="border-top:1px solid var(--border);padding:12px;display:flex;gap:8px;align-items:center;">
                            <input id="chatInput" type="text" placeholder="Type a message..." style="flex:1;padding:10px;border:1px solid var(--border);border-radius:6px;">
                            <button id="sendBtn" class="btn">Send</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p style="text-align:center">&copy; 2026 Wispa Real Estate. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        (async function(){
            // Check if user is logged in via server session
            const userObj = await window.getCurrentUser();
            if (!userObj) {
                document.getElementById('messages').innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text);">Please <a href="login.html">login</a> to view messages.</p>';
                return;
            }

            const userId = userObj.id;
            
            const urlParams = new URLSearchParams(window.location.search);
            const convId = urlParams.get('conv') || 'conv-1';
            const messagesEl = document.getElementById('messages');
            const inputEl = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

            // Render conversation messages
            function normalizeImageUrlLocal(u){ try{ if(!u) return u; const s=String(u).trim(); if(s.indexOf('data:')===0) return s; if(window.normalizeImageUrl) return window.normalizeImageUrl(s); if(location && location.protocol==='https:'){ if(s.startsWith('http://')) return s.replace(/^http:/,'https:'); if(s.startsWith('//')) return 'https:'+s; } return s; }catch(e){return u;} }

            function renderPropertyCardIfPresent(list){
                try{
                    // find a property meta on first message or any message
                    const msgWithProp = (list||[]).find(m => m && m.meta && (m.meta.property || m.meta.propertyId || m.meta.property_id));
                    const prop = msgWithProp && (msgWithProp.meta.property || null);
                    // clear any existing card
                    const existing = document.getElementById('messages-property-card'); if(existing) existing.remove();
                    if(!prop) return;
                    const cardWrap = document.createElement('div');
                    cardWrap.id = 'messages-property-card';
                    cardWrap.style.padding = '12px';
                    cardWrap.style.borderRadius = '8px';
                    cardWrap.style.background = '#f8fafc';
                    cardWrap.style.margin = '6px 0 12px 0';
                    cardWrap.style.display = 'flex';
                    cardWrap.style.gap = '12px';
                    cardWrap.style.alignItems = 'center';
                    cardWrap.style.cursor = 'pointer';
                    const img = prop.image || (prop.images && prop.images[0]) || '';
                    if(img){ const im = document.createElement('img'); im.src = normalizeImageUrlLocal(img); im.alt = prop.title || ''; im.style.cssText = 'width:84px;height:64px;object-fit:cover;border-radius:6px;'; cardWrap.appendChild(im); }
                    const info = document.createElement('div'); info.style.flex = '1';
                    const t = document.createElement('div'); t.style.fontWeight = '700'; t.style.marginBottom='4px'; t.textContent = prop.title || prop.name || 'Property';
                    const s = document.createElement('div'); s.style.color='#666'; s.style.fontSize='13px'; s.textContent = (prop.location||prop.address||'') + (prop.price ? (' â€” '+prop.price) : '');
                    info.appendChild(t); info.appendChild(s); cardWrap.appendChild(info);
                    const pid = prop.id || prop.propertyId || prop.property_id || '';
                    cardWrap.addEventListener('click', function(){ if(pid) window.location.href = 'property-detail.html?id='+encodeURIComponent(pid)+'&conversation=true'; });
                    // insert at top of messages container
                    messagesEl.parentNode.insertBefore(cardWrap, messagesEl);
                }catch(e){ console.warn('renderPropertyCardIfPresent failed', e); }
            }

            function renderList(list){
                messagesEl.innerHTML = '';
                if (!list || list.length === 0) {
                    messagesEl.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:20px;">No messages yet. Start the conversation!</p>';
                    return;
                }
                // prepend property card when applicable
                renderPropertyCardIfPresent(list);
                list.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'chat-message ' + (m.sender === 'user' ? 'sent' : 'received');
                    div.style.maxWidth = '78%';
                    div.style.padding = '10px 12px';
                    div.style.borderRadius = '10px';
                    div.style.alignSelf = m.sender === 'user' ? 'flex-end' : 'flex-start';
                    div.style.background = m.sender === 'user' ? 'var(--primary)' : 'var(--light)';
                    div.style.color = m.sender === 'user' ? '#fff' : 'var(--text)';
                    const text = (m.text || m.body || m.content || (m.meta && m.meta.text) || (m.message && m.message.text) || '');
                    const ts = m.ts || m.time || m.sent_at || m.created_at || Date.now();
                    div.innerHTML = `<div style="font-size:14px;margin-bottom:6px">${escapeHtml(text)}</div><div style="font-size:11px;opacity:0.7;text-align:${m.sender==='user'?'right':'left'}">${new Date(ts).toLocaleTimeString()}</div>`;
                    messagesEl.appendChild(div);
                });
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            // Load messages from server API first, fallback to in-memory
            async function loadMessagesFromApi(){
                try{
                    const fetcher = window.apiFetch ? window.apiFetch : fetch;
                    const r = await fetcher('/api/conversations/' + encodeURIComponent(convId) + '/messages');
                    if (r && r.ok){ const j = await r.json(); return Array.isArray(j.messages) ? j.messages : []; }
                }catch(e){}
                // fallback to in-memory merge
                window._wispaMessages = window._wispaMessages || {};
                const key = 'wispaMessages_' + userId + '_' + convId;
                const adminKey = 'adminMessages_' + convId;
                const legacyKey = 'wispaMessages_' + convId;
                const all = [];
                const seen = new Set();
                [ window._wispaMessages[key] || [], window._wispaMessages[adminKey] || [], window._wispaMessages[legacyKey] || [] ].forEach(msgs => {
                    if (Array.isArray(msgs)) msgs.forEach(m => { const sig = (m.time||m.ts||'')+'|'+(m.text||m.content||m.body||'')+'|'+(m.sender||m.from||''); if (!seen.has(sig)){ all.push(m); seen.add(sig); } });
                });
                all.sort((a,b)=>{ const ta = a.time||a.ts||a.sent_at||0; const tb = b.time||b.ts||b.sent_at||0; return ta - tb; });
                return all;
            }

            // Initial load
            (async ()=>{ const msgs = await loadMessagesFromApi(); renderList(msgs); })();

            // Subscribe for in-tab updates
            if (window.subscribeConversation) {
                window.subscribeConversation(convId, (list) => renderList(list || []));
            }

            // Send via API, include userId and property meta
            async function send(text){
                if (!text || !text.trim()) return;
                const now = Date.now();
                const wispaUser = await window.getCurrentUser();
                const userName = (wispaUser && (wispaUser.username || wispaUser.email)) || 'Anonymous User';
                const userEmail = (wispaUser && wispaUser.email) || '';
                const userIdReal = wispaUser && wispaUser.id ? wispaUser.id : null;
                const msg = { sender: 'user', text: text.trim(), ts: now, meta: { fromPage: 'messages' } };
                // Try server
                try{
                    const payload = { convId: convId, message: Object.assign({}, msg, { userId: userIdReal }) };
                    const fetcher = window.apiFetch ? window.apiFetch : fetch;
                    const r = await fetcher('/api/conversations/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (r && r.ok){ const body = await r.json(); const returned = body && (body.message || (Array.isArray(body.messages) ? body.messages : null)); const toRender = Array.isArray(returned) ? returned : (returned ? [returned] : []); window._wispaMessages = window._wispaMessages || {}; const key = 'wispaMessages_' + userId + '_' + convId; window._wispaMessages[key] = window._wispaMessages[key] || []; if (toRender.length) toRender.forEach(m=>window._wispaMessages[key].push(m)); renderList(await loadMessagesFromApi()); inputEl.value=''; return; }
                }catch(e){}
                // Fallback: queue in-memory
                window._wispaMessages = window._wispaMessages || {};
                const key = 'wispaMessages_' + userId + '_' + convId;
                window._wispaMessages[key] = window._wispaMessages[key] || [];
                window._wispaMessages[key].push({ sender: 'user', text: text.trim(), ts: now, userName, userEmail });
                renderList(await loadMessagesFromApi());
                inputEl.value = '';
            }

            sendBtn.addEventListener('click', ()=> send(inputEl.value));
            inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); send(inputEl.value); } });
        })();
    </script>
</body>
</html>
