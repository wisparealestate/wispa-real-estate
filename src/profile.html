<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Wispa Real Estate</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Profile Page Redesign */
        .profile-page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* Header Section */
        .profile-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #fff;
            padding: 40px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }

        .profile-header-content {
            display: flex;
            align-items: center;
            gap: 24px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .profile-avatar-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-avatar:hover {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }

        .avatar-upload-hint {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-avatar-wrapper:hover .avatar-upload-hint {
            opacity: 1;
        }

        .profile-header-info h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
        }

        .profile-header-info p {
            margin: 4px 0;
            font-size: 15px;
            opacity: 0.95;
        }

        #avatarInput {
            display: none;
        }

        /* Settings Icon Button */
        .profile-settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
            padding: 0;
        }

        .profile-settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        /* Right Sidebar Menu */
        .settings-sidebar {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #fff;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
            z-index: 50;
            transition: right 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.active {
            right: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text);
        }

        .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }

        .sidebar-close-btn:hover {
            color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            padding: 12px 0;
            overflow-y: auto;
        }

        .sidebar-nav {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sidebar-nav-item {
            margin: 0;
            padding: 0;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--text);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .sidebar-nav-link:hover {
            background: var(--light);
            color: var(--primary);
            padding-left: 24px;
        }

        .sidebar-nav-link.active {
            background: var(--light);
            color: var(--primary);
            border-left: 4px solid var(--primary);
            padding-left: 16px;
        }

        .sidebar-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            opacity: 0;
            z-index: 49;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-overlay.active {
            background: rgba(0, 0, 0, 0.5);
            opacity: 1;
            pointer-events: auto;
        }

        /* Stats Grid */
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 24px;
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Tabs */
        .profile-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 30px;
            background: #fff;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .profile-tab {
            flex: 1;
            padding: 16px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            position: relative;
            transition: color 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .profile-tab:hover {
            color: var(--primary);
        }

        .profile-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Sections */
        .form-section {
            background: #fff;
            padding: 28px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 11px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--lighter);
            border-color: var(--text-light);
        }

        .btn-danger {
            background: #f44336;
            color: #fff;
            flex: 1;
        }

        .btn-danger:hover {
            background: #d32f2f;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        /* Info Display */
        .info-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--light);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 15px;
            color: var(--text);
            font-weight: 500;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }

        .modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin: 0 0 16px 0;
            font-size: 20px;
        }

        .modal-content p {
            margin: 0 0 24px 0;
            color: var(--text-light);
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Back link */
        .back-nav {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 6px;
            text-decoration: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .back-nav:hover {
            background: var(--lighter);
            border-color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .profile-header-info h1 {
                font-size: 24px;
            }

            .profile-avatar {
                width: 110px;
                height: 110px;
            }

            .profile-tabs {
                flex-wrap: wrap;
            }

            .profile-tab {
                flex: 1;
                min-width: 120px;
            }

            .form-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="main-container">
            <a href="index.html" class="back-nav" id="backNav" style="display:inline-flex;">‚Üê Back to Home</a>

            <div class="profile-page">
                <!-- Header with Avatar -->
                <div class="profile-header">
                    <button class="profile-settings-btn" id="profileSettingsBtn" title="Settings">‚öôÔ∏è</button>
                                    <script>
                                    // Hide settings and change back button if from admin chat
                                    (function(){
                                        const urlParams = new URLSearchParams(window.location.search);
                                        const fromAdminChat = urlParams.get('from') === 'adminchat';
                                        const convId = urlParams.get('conv');
                                        var backNav = document.getElementById('backNav');
                                        var settingsBtn = document.getElementById('profileSettingsBtn');
                                        if (fromAdminChat) {
                                            // Always show back button, but change text/href
                                            if (backNav) {
                                                backNav.style.display = 'inline-flex';
                                                backNav.textContent = '‚Üê Back to Chat';
                                                backNav.href = convId ? 'admin.html#conversation?id=' + encodeURIComponent(convId) : 'admin.html#chat';
                                            }
                                            // Hide settings button
                                            if (settingsBtn) settingsBtn.style.display = 'none';
                                        } else {
                                            // Default: show back button as home
                                            if (backNav) {
                                                backNav.style.display = 'inline-flex';
                                                backNav.textContent = '‚Üê Back to Home';
                                                backNav.href = 'index.html';
                                            }
                                            if (settingsBtn) settingsBtn.style.display = '';
                                        }
                                    })();
                                    </script>
                    <div class="profile-header-content">
                        <div class="profile-avatar-wrapper">
                            <img id="profilePic" src="" alt="Profile" class="profile-avatar" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2NjY2MiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5JbWFnZTwvdGV4dD48L3N2Zz4='>
                            
                            <input id="avatarInput" type="file" accept="image/*">
                        </div>
                        <div class="profile-header-info" style="text-align: center;">
                            <h1 id="headerName">Your Name</h1>
                            <p id="headerEmail">your@email.com</p>
                            <p id="memberSince">Member since January 2024</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="profile-stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="likedCount">0</div>
                        <div class="stat-label">Properties Liked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="boughtCount">0</div>
                        <div class="stat-label">Purchased</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="savedSearchesCount">0</div>
                        <div class="stat-label">Saved Searches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                        <div class="stat-label">Account Status</div>
                    </div>
                </div>

                <!-- Tabs Navigation - Hidden on Dashboard -->
                <div class="profile-tabs" style="display: none;">
                    <button class="profile-tab active" data-tab="account">Account Information</button>
                    <button class="profile-tab" data-tab="preferences">Preferences</button>
                    <button class="profile-tab" data-tab="security">Security</button>
                    <button class="profile-tab" data-tab="activity">Activity</button>
                </div>

                <!-- Tab: Account Information - Hidden on Dashboard -->
                <div id="account-tab" class="tab-content active" style="display: none;">
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="displayName">Full Name</label>
                                <input id="displayName" type="text" placeholder="Your full name">
                            </div>
                            <div class="form-group">
                                <label for="displayEmail">Email Address</label>
                                <input id="displayEmail" type="email" placeholder="your@email.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="bioInput">Bio / About You</label>
                            <textarea id="bioInput" placeholder="Tell us about yourself and what you're looking for..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneInput">Phone Number</label>
                                <input id="phoneInput" type="text" placeholder="+1 (555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label for="locationInput">Preferred Location</label>
                                <input id="locationInput" type="text" placeholder="City, State">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" id="cancelBtn">Cancel</button>
                            <button class="btn-primary" id="saveBtn">Save Changes</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Account Details</h3>
                        <div class="info-item">
                            <div class="info-label">Member Since</div>
                            <div class="info-value" id="joinedAt">‚Äî</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Account Status</div>
                            <div class="info-value">Active ‚úì</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Last Updated</div>
                            <div class="info-value" id="lastUpdated">Today</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Preferences - Hidden on Dashboard -->
                <div id="preferences-tab" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>Notification Preferences</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Email me about new property listings
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Notify me about price changes
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox"> Send me weekly market updates
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Allow contact from agents
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="savePreferencesBtn">Save Preferences</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Display Settings</h3>
                        <div class="form-group">
                            <label for="themeSelect">Theme</label>
                            <select id="themeSelect">
                                <option>Light</option>
                                <option>Dark</option>
                                <option>Auto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="currencySelect">Preferred Currency</label>
                            <select id="currencySelect">
                                <option>USD ($)</option>
                                <option>EUR (‚Ç¨)</option>
                                <option>GBP (¬£)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tab: Security - Hidden on Dashboard -->
                <div id="security-tab" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>Password Management</h3>
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input id="currentPassword" type="password" placeholder="Enter your current password">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input id="newPassword" type="password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input id="confirmPassword" type="password" placeholder="Confirm new password">
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="changePasswordBtn">Change Password</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Account Security</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> Two-Factor Authentication (2FA)
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class="btn-secondary" id="enableTwoFABtn">Configure 2FA</button>
                            <button class="btn-secondary" id="downloadSecurityBtn">Download Security Report</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Activity - Hidden on Dashboard -->
                <div id="activity-tab" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h3>Login Activity</h3>
                        <div class="info-item">
                            <div class="info-label">Last Login</div>
                            <div class="info-value">Today at 2:45 PM</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Current Session</div>
                            <div class="info-value">Active</div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Recent Activity</h3>
                        <div class="info-item">
                            <div class="info-label">Viewed Properties</div>
                            <div class="info-value" id="viewedCount">0 this month</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Searches Performed</div>
                            <div class="info-value" id="searchCount">0 this month</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Messages Sent</div>
                            <div class="info-value">0 this month</div>
                        </div>
                    </div>
                </div>

                <!-- Logout Section - Hidden on Dashboard -->
                <div class="form-section" style="margin-top: 40px; border: 1px solid #ffcccc; background: #fff5f5; display: none;">
                    <h3 style="color: #d32f2f; border-bottom-color: #ffcccc;">Danger Zone</h3>
                    <p style="color: var(--text-light); margin: 0 0 16px 0;">
                        Once you log out, you'll need to provide your credentials to access your account again.
                    </p>
                    <div class="form-actions">
                        <button class="btn-secondary" id="privacyBtn">Privacy Policy</button>
                        <button class="btn-secondary" id="agreementBtn">User Agreement</button>
                        <button class="btn-danger" id="logoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Sidebar -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <div class="settings-sidebar" id="settingsSidebar">
            <div class="sidebar-header">
                <h3>Settings</h3>
                <button class="sidebar-close-btn" id="sidebarCloseBtn">‚úï</button>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="account.html" class="sidebar-nav-link">
                            <span class="sidebar-icon">üë§</span>
                            <span>Account Information</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="preferences.html" class="sidebar-nav-link">
                            <span class="sidebar-icon">‚öôÔ∏è</span>
                            <span>Preferences</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="security.html" class="sidebar-nav-link">
                            <span class="sidebar-icon">üîí</span>
                            <span>Security</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="activity.html" class="sidebar-nav-link">
                            <span class="sidebar-icon">üìä</span>
                            <span>Activity</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item" style="border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px;">
                        <a href="privacy.html" class="sidebar-nav-link">
                            <span class="sidebar-icon">üìã</span>
                            <span>Privacy Policy</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <button class="sidebar-nav-link" id="agreementBtnSidebar">
                            <span class="sidebar-icon">üìú</span>
                            <span>User Agreement</span>
                        </button>
                    </li>
                    <li class="sidebar-nav-item" style="border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px;">
                        <button class="sidebar-nav-link" id="logoutBtnSidebar" style="color: var(--primary); font-weight: 600;">
                            <span class="sidebar-icon">üö™</span>
                            <span>Logout</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Agreement Modal -->
    <div id="agreementModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>User Agreement</h3>
            <p>By using Wispa Real Estate, you agree to our terms and conditions. This platform is designed to help you find your perfect property.</p>
            <p>We respect your privacy and handle your data according to our privacy policy. Your account is secure and protected.</p>
            <div class="modal-actions">
                <button id="closeAgreement" class="btn-secondary">Close</button>
                <button id="agreeOk" class="btn-primary">I Agree</button>
            </div>
        </div>
    </div>

    <script>
        // Utility function to safely parse JSON
        function safeParseJSON(key) {
            try { 
                return JSON.parse(localStorage.getItem(key)); 
            } catch(e) { 
                return null; 
            }
        }
        
        // Initialize user data (prefer server session; fallback to localStorage)
        const defaultUser = { 
            username: 'User', 
            email: '', 
            avatar: '', 
            bio: '', 
            phone: '',
            location: '',
            joined: (new Date()).toISOString() 
        };
        let user = defaultUser;

        // Async init: prefer server session via requireLogin/getCurrentUser
        (async function(){
            try {
                if (window.requireLogin) await window.requireLogin();
            } catch(e) {}
            try {
                const u = await window.getCurrentUser();
                if (u && (u.username || u.email)) {
                    // If this is an admin account, try to load the admin-specific profile
                    if (u.role === 'admin') {
                        try {
                            const ap = window.apiFetch ? await window.apiFetch('/api/admin/profile') : await fetch('/api/admin/profile');
                            if (ap && ap.ok) {
                                const pj = await ap.json();
                                // map admin profile shape to expected user fields
                                const profile = (pj && pj.profile) ? pj.profile : {};
                                user = Object.assign({}, user, {
                                    username: profile.adminName || user.username,
                                    email: profile.adminEmail || user.email,
                                    avatar: profile.adminAvatar || user.avatar,
                                    joined: profile.adminSince || user.created_at || user.joined
                                });
                            } else {
                                user = u;
                            }
                        } catch(e) {
                            user = u;
                        }
                    } else {
                        user = u;
                    }
                    try { localStorage.setItem('wispaUser', JSON.stringify(user)); } catch(e){}
                } else {
                    // fallback to localStorage for older clients
                    const stored = safeParseJSON('wispaUser');
                    if (stored && stored.username) user = stored;
                }
            } catch(e) {
                const stored = safeParseJSON('wispaUser');
                if (stored && stored.username) user = stored;
            }

            if(!user || !user.username){ window.location.href = 'login.html'; }
            initializeUI();
        })();

        // DOM Elements - Profile Header
        const profilePic = document.getElementById('profilePic');
        const headerName = document.getElementById('headerName');
        const headerEmail = document.getElementById('headerEmail');
        const memberSince = document.getElementById('memberSince');
        const lastUpdated = document.getElementById('lastUpdated');

        // DOM Elements - Form Inputs
        const displayNameInput = document.getElementById('displayName');
        const displayEmailInput = document.getElementById('displayEmail');
        const bioInput = document.getElementById('bioInput');
        const phoneInput = document.getElementById('phoneInput');
        const locationInput = document.getElementById('locationInput');
        const avatarInput = document.getElementById('avatarInput');

        // DOM Elements - Stats
        const likedCountEl = document.getElementById('likedCount');
        const boughtCountEl = document.getElementById('boughtCount');
        const savedSearchesCountEl = document.getElementById('savedSearchesCount');
        const viewedCount = document.getElementById('viewedCount');
        const searchCount = document.getElementById('searchCount');
        const joinedAtEl = document.getElementById('joinedAt');

        // DOM Elements - Buttons
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const savePreferencesBtn = document.getElementById('savePreferencesBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const privacyBtn = document.getElementById('privacyBtn');
        const agreementBtn = document.getElementById('agreementBtn');
        const enableTwoFABtn = document.getElementById('enableTwoFABtn');
        const downloadSecurityBtn = document.getElementById('downloadSecurityBtn');

        // DOM Elements - Modal
        const agreementModal = document.getElementById('agreementModal');
        const closeAgreement = document.getElementById('closeAgreement');
        const agreeOk = document.getElementById('agreeOk');

        // Get activity data from localStorage (real account records)
        let liked = safeParseJSON('likedProperties') || [];
        let purchases = safeParseJSON('purchases') || safeParseJSON('transactions') || [];
        let savedSearches = safeParseJSON('savedSearches') || [];

        // Initialize empty arrays in localStorage if they don't exist
        if (!safeParseJSON('likedProperties')) {
            localStorage.setItem('likedProperties', JSON.stringify(liked));
        }
        if (!safeParseJSON('purchases') && !safeParseJSON('transactions')) {
            localStorage.setItem('purchases', JSON.stringify(purchases));
        }
        if (!safeParseJSON('savedSearches')) {
            localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
        }

        // ========== Initialize UI ==========
        function initializeUI() {
            // Reload latest data from localStorage
            liked = safeParseJSON('likedProperties') || [];
            purchases = safeParseJSON('purchases') || safeParseJSON('transactions') || [];
            savedSearches = safeParseJSON('savedSearches') || [];
            
            // Profile header
            headerName.textContent = user.username || 'Your Name';
            headerEmail.textContent = user.email || 'your@email.com';
            memberSince.textContent = user.joined ? 'Member since ' + new Date(user.joined).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) : 'Member since unknown';
            
            // Form inputs
            displayNameInput.value = user.username || '';
            displayEmailInput.value = user.email || '';
            bioInput.value = user.bio || '';
            phoneInput.value = user.phone || '';
            locationInput.value = user.location || '';
            // Use inline placeholder and attach error handler to avoid external DNS failures
            const PROFILE_PLACEHOLDER = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2NjY2MiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5JbWFnZTwvdGV4dD48L3N2Zz4=';
            if (profilePic) {
                profilePic.src = user.avatar || PROFILE_PLACEHOLDER;
                profilePic.onerror = function(){ if (this.src !== PROFILE_PLACEHOLDER) this.src = PROFILE_PLACEHOLDER; };
            } else {
                console.warn('profilePic element not found');
            }
            
            // Date info
            joinedAtEl.textContent = user.joined ? new Date(user.joined).toLocaleDateString() : '‚Äî';
            lastUpdated.textContent = 'Today';
            
            // Stats - Display real data from localStorage
            likedCountEl.textContent = Array.isArray(liked) ? liked.length : 0;
            boughtCountEl.textContent = Array.isArray(purchases) ? purchases.length : 0;
            savedSearchesCountEl.textContent = Array.isArray(savedSearches) ? savedSearches.length : 0;
            viewedCount.textContent = '0 this month';
            searchCount.textContent = '0 this month';
        }

        // ========== Refresh Stats Function ==========
        function refreshStats() {
            // Reload real data from localStorage
            liked = safeParseJSON('likedProperties') || [];
            purchases = safeParseJSON('purchases') || safeParseJSON('transactions') || [];
            savedSearches = safeParseJSON('savedSearches') || [];
            
            // Update stats display - show count of admin-posted properties liked by user
            likedCountEl.textContent = Array.isArray(liked) ? liked.length : 0;
            boughtCountEl.textContent = Array.isArray(purchases) ? purchases.length : 0;
            savedSearchesCountEl.textContent = Array.isArray(savedSearches) ? savedSearches.length : 0;
        }

        // ========== Avatar Upload ==========
        if (profilePic && avatarInput) {
            profilePic.addEventListener('click', () => avatarInput.click());

            avatarInput.addEventListener('change', async function(e) {
            const file = e.target.files && e.target.files[0];
            if(!file) return;

            // Prefer uploading the avatar to the server and storing the returned URL
            try {
                const fd = new FormData();
                fd.append('avatar', file);
                const res = await fetch('/api/upload-avatar', { method: 'POST', body: fd });
                if (res && res.ok) {
                    const data = await res.json();
                    const imageUrl = data && (data.imageUrl || data.url || data.imageUrl);
                    if (imageUrl) {
                        profilePic.src = imageUrl;
                        user.avatar = imageUrl;
                        localStorage.setItem('wispaUser', JSON.stringify(user));
                        // If user has an id, try to persist avatar_url server-side (best-effort)
                        if (user && user.id) {
                            try { await fetch('/api/update-avatar-url', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: user.id, avatarUrl: imageUrl }) }); } catch(e){}
                        }
                        return;
                    }
                }
            } catch (err) {
                console.warn('Avatar upload failed, falling back to local data URL', err);
            }

            // Fallback: store as data URL in localStorage (keeps previous behaviour)
            try {
                const reader = new FileReader();
                reader.onload = function() {
                    profilePic.src = reader.result;
                    user.avatar = reader.result;
                    localStorage.setItem('wispaUser', JSON.stringify(user));
                };
                reader.readAsDataURL(file);
            } catch(e) {
                console.error('Failed to read avatar file', e);
            }
            });
        } else {
            if (!profilePic) console.warn('profilePic element missing ‚Äî avatar upload disabled');
            if (!avatarInput) console.warn('avatarInput element missing ‚Äî avatar upload disabled');
        }

        // ========== Settings Sidebar ==========
        const profileSettingsBtn = document.getElementById('profileSettingsBtn');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');

        function openSidebar() {
            settingsSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            settingsSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        if (profileSettingsBtn) profileSettingsBtn.addEventListener('click', openSidebar);
        if (sidebarCloseBtn) sidebarCloseBtn.addEventListener('click', closeSidebar);
        if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

        // Agreement button in sidebar
        const agreementBtnSidebar = document.getElementById('agreementBtnSidebar');
        if (agreementBtnSidebar) {
            agreementBtnSidebar.addEventListener('click', function() {
                if (agreementModal) agreementModal.style.display = 'flex';
                closeSidebar();
            });
        }

        // Logout button in sidebar
        const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');
        if (logoutBtnSidebar) {
            logoutBtnSidebar.addEventListener('click', function() {
                // Clear user data
                localStorage.removeItem('wispaUser');
                // Redirect to login page
                window.location.href = 'login.html';
            });
        }

        // ========== Tab Navigation ==========
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                const contentEl = document.getElementById(tabName + '-tab');
                if (contentEl) contentEl.classList.add('active');
            });
        });

        // ========== Account Tab Actions ==========
        if (saveBtn) saveBtn.addEventListener('click', function() {
            user.username = displayNameInput.value.trim() || user.username;
            user.email = displayEmailInput.value.trim() || user.email;
            user.bio = bioInput.value.trim() || '';
            user.phone = phoneInput.value.trim() || '';
            user.location = locationInput.value.trim() || '';
            
            localStorage.setItem('wispaUser', JSON.stringify(user));
            
            // Update header
            headerName.textContent = user.username;
            headerEmail.textContent = user.email || 'your@email.com';
            
            // Show success message
            alert('Profile saved successfully! ‚úì');
        });

        if (cancelBtn) cancelBtn.addEventListener('click', function() {
            // Reset form to current user values
            initializeUI();
            alert('Changes cancelled.');
        });

        // ========== Preferences Tab ==========
        if (savePreferencesBtn) savePreferencesBtn.addEventListener('click', function() {
            alert('Preferences saved successfully! ‚úì');
        });

        // ========== Security Tab ==========
        if (changePasswordBtn) changePasswordBtn.addEventListener('click', function() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if(!currentPass || !newPass || !confirmPass) {
                alert('Please fill in all password fields');
                return;
            }
            
            if(newPass !== confirmPass) {
                alert('New passwords do not match');
                return;
            }
            
            if(newPass.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            alert('Password changed successfully! ‚úì');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });

        if (enableTwoFABtn) enableTwoFABtn.addEventListener('click', function() {
            alert('Two-Factor Authentication setup initiated. Check your email for next steps.');
        });

        if (downloadSecurityBtn) downloadSecurityBtn.addEventListener('click', function() {
            alert('Security report download initiated. Check your downloads folder.');
        });

        // ========== Modal ==========
        if (agreementBtn) agreementBtn.addEventListener('click', function() {
            if (agreementModal) agreementModal.style.display = 'flex';
        });

        if (closeAgreement) closeAgreement.addEventListener('click', function() {
            if (agreementModal) agreementModal.style.display = 'none';
        });

        if (agreeOk) agreeOk.addEventListener('click', function() {
            if (agreementModal) agreementModal.style.display = 'none';
        });

        if (agreementModal) agreementModal.addEventListener('click', function(e) {
            if(e.target === agreementModal) {
                agreementModal.style.display = 'none';
            }
        });

        // ========== Navigation Links ==========
        if (privacyBtn) privacyBtn.addEventListener('click', function() {
            window.location.href = 'privacy.html';
        });

        // ========== Logout ==========
        if (logoutBtn) logoutBtn.addEventListener('click', function() {
            if(confirm('Are you sure you want to logout? You will need to login again to access your profile.')) {
                localStorage.removeItem('wispaUser');
                window.location.href = 'index.html';
            }
        });

        // ========== Page Visibility Handler ==========
        // Refresh stats when user returns to page
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshStats();
            }
        });

        // Also refresh stats periodically every 30 seconds to catch updates from other tabs
        setInterval(refreshStats, 30000);

        // Initialize on page load
        initializeUI();
    </script>
</body>
</html>
